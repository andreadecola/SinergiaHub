
@model IEnumerable<Sinergia.Models.OperazioniPrevisionaliViewModel>
@{
    var lista = Model?.ToList() ?? new List<Sinergia.Models.OperazioniPrevisionaliViewModel>();

    Func<string, string> badgeClass = t =>
        string.Equals(t, "Entrata", StringComparison.OrdinalIgnoreCase) ? "badge bg-success" : "badge bg-danger";
    Func<string, string> rowClass = t =>
        string.Equals(t, "Entrata", StringComparison.OrdinalIgnoreCase) ? "table-success" : "table-danger";

    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Operazioni Previsionali";


    // Calcoli utili previsionali
    decimal totEntrate = lista
        .Where(x => x.TipoOperazione == "Entrata")
        .Sum(x => x.ImportoPrevisto ?? 0m);

    decimal totUscite = lista
        .Where(x => x.TipoOperazione == "Uscita")
        .Sum(x => x.ImportoPrevisto ?? 0m); // Uscite già negative

    decimal utilePrev = totEntrate + totUscite; // Uscite negative → somma diretta
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

<!-- 🏷️ Titolo principale -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="fa fa-bar-chart me-2 text-primary"></i> Operazioni Previsionali
    </h4>
</div>


<div class="d-flex justify-content-between mb-2" id="controlliPrevisionale">
    <div class="d-flex flex-wrap align-items-center gap-2">
        <input id="searchPrev" type="text" class="form-control form-control-sm w-auto" placeholder="Cerca...">
        <select id="filtroTipoPrev" class="form-select form-select-sm w-auto">
            <option value="Tutte">Tutte</option>
            <option value="Entrata">Entrate</option>
            <option value="Uscita">Uscite</option>
        </select>
        <select id="pageSizePrev" class="form-select form-select-sm w-auto">
            <option value="10">10 per pagina</option>
            <option value="25">25 per pagina</option>
            <option value="50">50 per pagina</option>
        </select>
    </div>
</div>

<!-- 📥 Export Operazioni Previsionali CSV/PDF -->
<div class="d-flex justify-content-end mb-3">
    <form method="get" id="exportPrevisionaliForm"
          class="d-flex flex-wrap flex-md-nowrap gap-2 align-items-center">

        <input type="date" name="da" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.AddMonths(-1).ToString("yyyy-MM-dd")" />

        <input type="date" name="a" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.ToString("yyyy-MM-dd")" />

        <button type="submit" formaction="@Url.Action("EsportaOperazioniPrevisionaliCsv", "Home")"
                class="btn btn-outline-success btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-excel"></i> Excel/CSV
        </button>

        <button type="submit" formaction="@Url.Action("EsportaOperazioniPrevisionaliPdf", "Home")"
                class="btn btn-outline-danger btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>
    </form>
</div>


@if (!lista.Any())
{
    <div class="alert alert-info my-2">Nessuna operazione previsionale nel periodo selezionato.</div>
}
else
{
    <!-- 🖥️ Tabella Desktop -->
    <div class="d-none d-md-block table-responsive">
        <table class="table table-striped table-bordered table-sm align-middle" id="previsionaleTable">
            <thead class="table-light">
                <tr>
                    <th style="width:110px;">Data</th>
                    <th style="width:95px;">Tipo</th>
                    <th>Descrizione</th>
                    <th>Pratica</th>
                    <th class="text-end" style="width:160px;">Valore pratica</th>
                    <th class="text-end" style="width:160px;">Importo previsto</th>
                    <th class="text-center" style="width:80px;">Azioni</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in lista)
                {
                    var tipo = string.Equals(r.TipoOperazione, "Entrata", StringComparison.OrdinalIgnoreCase) ? "Entrata" : "Uscita";
                    <tr class="@rowClass(tipo)" data-tipo="@tipo">
                        <td>@(r.DataPrevisione?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td><span class="@badgeClass(tipo)">@tipo</span></td>
                        <td>@(string.IsNullOrWhiteSpace(r.Descrizione) ? "—" : r.Descrizione)</td>
                        <td>@(string.IsNullOrWhiteSpace(r.NomePratica) ? "—" : r.NomePratica)</td>
                        <td class="text-end">
                            @(tipo == "Entrata"
                                ? (r.BudgetPratica.GetValueOrDefault().ToString("N2") + " €")
                                : "—")
                        </td>
                        <td class="text-end">@r.ImportoPrevisto.GetValueOrDefault().ToString("N2") €</td>
                        <td class="text-center">
                            <button class="btn btn-outline-primary btn-sm"
                                    title="Dettaglio"
                                    onclick="apriDettaglioPrevisionale('@tipo', @r.ID_Previsione)">
                                <i class="fa fa-search"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 📱 Card Mobile -->
    <div class="d-block d-md-none mt-3">
        @foreach (var r in lista)
        {
            var tipo = string.Equals(r.TipoOperazione, "Entrata", StringComparison.OrdinalIgnoreCase) ? "Entrata" : "Uscita";
            <div class="border rounded shadow-sm p-3 mb-3 bg-white card-previsionale" data-tipo="@tipo">
                <div class="small text-muted"><strong>Data:</strong> @(r.DataPrevisione?.ToString("dd/MM/yyyy") ?? "-")</div>
                <div><strong>Tipo:</strong> <span class="@badgeClass(tipo)">@tipo</span></div>
                <div><strong>Descrizione:</strong> @(string.IsNullOrWhiteSpace(r.Descrizione) ? "—" : r.Descrizione)</div>
                <div><strong>Pratica:</strong> @(string.IsNullOrWhiteSpace(r.NomePratica) ? "—" : r.NomePratica)</div>
                <div>
                    <strong>Valore pratica:</strong>
                    @(tipo == "Entrata"
                        ? (r.BudgetPratica.GetValueOrDefault().ToString("N2") + " €")
                        : "—")
                </div>
                <div class="fw-bold @(tipo == "Entrata" ? "text-success" : "text-danger")">
                    @r.ImportoPrevisto.GetValueOrDefault().ToString("N2") €
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-primary btn-sm"
                            title="Dettaglio"
                            onclick="apriDettaglioPrevisionale('@tipo', @r.ID_Previsione)">
                        <i class="fa fa-search"></i> Dettaglio
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- 🔄 Paginazione -->
    <div class="d-flex justify-content-end align-items-center gap-2 mt-2" id="paginazionePrevisionale"></div>

    <!-- Totali -->
    <div class="d-flex flex-wrap justify-content-end gap-3 mt-2">
        <div><strong>Totale entrate:</strong> @totEntrate.ToString("N2") €</div>
        <div><strong>Totale uscite:</strong> @totUscite.ToString("N2") €</div>
        <div class="@(utilePrev >= 0 ? "text-success" : "text-danger")">
            <strong>Utile previsionale:</strong> @utilePrev.ToString("N2") €
        </div>
    </div>
}

@* Modale dettaglio *@
<div class="modal fade" id="dettaglioPrevisionaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-black">
                <h5 class="modal-title">Dettaglio operazione</h5>
                <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contenutoDettaglioPrev" class="small">Caricamento...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === Tabella: filtro + paginazione client-side ===
    (function () {
        const table = document.getElementById('previsionaleTable');
        const tbody = table ? table.querySelector('tbody') : null;
        const allRows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

        // 📱 Card mobile
        const allCards = Array.from(document.querySelectorAll('.card-previsionale'));

        const searchInput = document.getElementById('searchPrev');
        const tipoSelect = document.getElementById('filtroTipoPrev');
        const pageSizeSelect = document.getElementById('pageSizePrev');
        const pagContainer = document.getElementById('paginazionePrevisionale');

        let pageSize = parseInt(pageSizeSelect.value || '10');
        let currentPage = 1;

        function matches(el, term, tipo) {
            const text = el.innerText.toLowerCase();
            const okTerm = !term || text.includes(term);

            if (tipo === 'Tutte') return okTerm;

            // Controlla tipo da classe o da data-attribute
            const isEntrata = el.classList.contains('table-success') || el.getAttribute('data-tipo') === 'Entrata';
            const isUscita = el.classList.contains('table-danger') || el.getAttribute('data-tipo') === 'Uscita';

            const okTipo = (tipo === 'Entrata' && isEntrata) || (tipo === 'Uscita' && isUscita);
            return okTerm && okTipo;
        }

        function render() {
            const term = (searchInput.value || '').toLowerCase();
            const tipo = tipoSelect.value || 'Tutte';

            // Filtra
            const filteredRows = allRows.filter(r => matches(r, term, tipo));
            const filteredCards = allCards.filter(c => matches(c, term, tipo));

            // Calcola pagine in base alla vista attiva
            const totalItems = window.innerWidth >= 768 ? filteredRows.length : filteredCards.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
            currentPage = Math.min(currentPage, totalPages);

            // 🖥️ Tabella desktop
            allRows.forEach(r => r.style.display = 'none');
            filteredRows
                .slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(r => r.style.display = '');

            // 📱 Card mobile
            allCards.forEach(c => c.style.display = 'none');
            filteredCards
                .slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(c => c.style.display = '');

            // 🔄 Paginazione
            pagContainer.innerHTML = '';
            const info = document.createElement('span');
            info.textContent = `Pagina ${currentPage} di ${totalPages}`;
            info.className = 'me-2';
            pagContainer.appendChild(info);

            const prev = document.createElement('button');
            prev.textContent = '← Indietro';
            prev.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prev.disabled = (currentPage === 1);
            prev.onclick = () => { currentPage--; render(); };
            pagContainer.appendChild(prev);

            const next = document.createElement('button');
            next.textContent = 'Prossima →';
            next.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            next.disabled = (currentPage === totalPages);
            next.onclick = () => { currentPage++; render(); };
            pagContainer.appendChild(next);
        }

        searchInput.addEventListener('input', () => { currentPage = 1; render(); });
        tipoSelect.addEventListener('change', () => { currentPage = 1; render(); });
        pageSizeSelect.addEventListener('change', () => { pageSize = parseInt(pageSizeSelect.value); currentPage = 1; render(); });

        render();
    })();


    // Helper: rende sicuro il parsing di date JSON .NET o ISO
    function formatDate(val) {
        if (!val) return '-';
        const m = /Date\((\d+)\)/.exec(val);          // es. "/Date(1722902400000)/"
        const d = m ? new Date(parseInt(m[1], 10)) : new Date(val);
        return isNaN(d) ? '-' : d.toLocaleDateString();
    }

    // === Modale dettaglio (usa l’endpoint che hai già in HomeController) ===
    function apriDettaglioPrevisionale(tipo, id) {
        const url = `/Home/GetDettaglioOperazionePrevisionale?tipo=${encodeURIComponent(tipo)}&id=${encodeURIComponent(id)}`;
        const box = document.getElementById('contenutoDettaglioPrev');
        box.innerHTML = 'Caricamento...';

        fetch(url)
            .then(r => r.json())
            .then(res => {
                if (!res.success) {
                    toastr.error(res.message || 'Errore nel caricamento del dettaglio.');
                    return;
                }

                if (res.tipo === 'Uscita') {
                    const d = res.dettaglio;
                    box.innerHTML = `
              <div class="row g-2">
                <div class="col-md-6"><strong>Categoria:</strong> ${d.Categoria ?? '-'}</div>
                <div class="col-md-6"><strong>Origine:</strong> ${d.Origine ?? '-'}</div>
                <div class="col-12"><strong>Descrizione:</strong> ${d.Descrizione ?? '-'}</div>
                <div class="col-md-4"><strong>Importo:</strong> ${(d.Importo ?? 0).toLocaleString(undefined, { minimumFractionDigits: 2 })} €</div>
                <div class="col-md-4"><strong>Data:</strong> ${formatDate(d.DataRegistrazione)}</div>
                <div class="col-md-4"><strong>Stato:</strong> ${d.Stato ?? '-'}</div>
                <div class="col-12"><strong>Pratica:</strong> ${d.Pratica ?? '-'}</div>
              </div>`;
                } else { // Entrata
                    const d = res.dettaglio;
                    const ownerPerc = res.ownerPercent != null ? Number(res.ownerPercent) : null;
                    const sinergiaPerc = res.sinergiaPercent != null ? Number(res.sinergiaPercent) : null;
                    const residentFix = res.residentFixed != null ? Number(res.residentFixed) : null;

                    // Etichetta "quota owner" se coincide
                    const percLabel = `${(d.Percentuale ?? 0).toLocaleString()}%${res.isOwnerQuota ? ' (quota owner)' : ''}`;

                    box.innerHTML = `
              <div class="row g-2">
                <div class="col-md-6"><strong>Pratica:</strong> ${d.Pratica ?? '-'}</div>
                <div class="col-md-6"><strong>Cliente:</strong> ${d.Cliente ?? '-'}</div>
                <div class="col-md-4"><strong>Budget:</strong> ${(d.Budget ?? 0).toLocaleString(undefined, { minimumFractionDigits: 2 })} €</div>
                <div class="col-md-4"><strong>% Previsione:</strong> ${percLabel}</div>
                <div class="col-md-4"><strong>Importo previsto:</strong> ${(d.ImportoPrevisto ?? 0).toLocaleString(undefined, { minimumFractionDigits: 2 })} €</div>
                <div class="col-12"><strong>Data:</strong> ${formatDate(d.Data)}</div>

                <div class="col-12 text-muted small mt-2">
                  ${sinergiaPerc != null ? `Trattenuta Sinergia: <strong>${sinergiaPerc.toLocaleString()}%</strong>` : ''}
                  ${ownerPerc != null ? ` &middot; Owner Fee: <strong>${ownerPerc.toLocaleString()}%</strong>` : ''}
                  ${residentFix != null ? ` &middot; Costo Resident mensile: <strong>${residentFix.toLocaleString(undefined, { minimumFractionDigits: 2 })} €</strong>` : ''}
                </div>
              </div>`;
                }

                new bootstrap.Modal(document.getElementById('dettaglioPrevisionaleModal')).show();
            })
            .catch(() => toastr.error('Errore di rete nel caricamento del dettaglio.'));
    }


</script>
