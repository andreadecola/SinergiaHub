@model List<Sinergia.Models.AnagraficaCostiPraticaViewModel>
@{
    var puoAggiungere = ViewBag.PuoAggiungere == true;
    var permessiUtente = ViewBag.Permessi as Sinergia.Models.PermessiViewModel;
    bool mostraAzioni = puoAggiungere || Model.Any(c => c.ID_AnagraficaCosto > 0);
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

<div class="d-flex justify-content-between mb-2" id="controlliCostiProgetto"></div>

<!-- 🔹 Controlli + Pulsante Nuovo -->
<div class="d-flex justify-content-between align-items-center mb-2 controls-costi-progetto-wrap">
    <div id="controlliCostiProgetto" class="d-flex align-items-center gap-1 flex-nowrap"></div>

    @if (puoAggiungere)
    {
        <button class="btn btn-outline-primary btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;"
                onclick="apriNuovoCostoProgetto()">
            Nuovo Costo di Progetto
        </button>
    }
</div>

<!-- 🖥️ TABELLA DESKTOP -->
<div class="d-none d-md-block">
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="costiProgettoTable">
            <thead>
                <tr>
                    <th class="w-10 text-center">ID</th>
                    <th class="w-25 text-center">Nome</th>
                    <th class="w-25 text-center">Categoria</th> <!-- ✅ nuova colonna -->
                    <th class="w-15 text-center">Stato Costo</th>
                    <th class="w-15 text-center">Ultima Modifica</th>
                    @if (mostraAzioni)
                    {
                        <th class="w-10 text-center">Azioni</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model)
                {
                    <tr data-codice="@t.ID_CodiceCosto"
                        data-nome="@t.Nome"
                        data-stato="@t.Stato">
                        <td class="text-center">@t.ID_CodiceCosto</td>
                        <td class="text-center">@t.Nome</td>
                        <td class="text-center">
                            @(string.IsNullOrEmpty(t.NomeCategoria) ? "—" : t.NomeCategoria)
                        </td>
                        <td class="text-nowrap text-center">
                            @if (t.Stato == "Attivo")
                            {
                                <span class="badge bg-success">Attivo</span>
                            }
                            else if (t.Stato == "Inattivo")
                            {
                                <span class="badge bg-secondary">Inattivo</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-muted">Nessuno</span>
                            }
                        </td>
                        <td class="text-center">
                            @(!t.DataUltimaModifica.HasValue
                                ? "-"
                                : t.DataUltimaModifica.Value.ToString("dd/MM/yyyy"))
                        </td>
                        @if (mostraAzioni)
                        {
                            <td class="text-nowrap text-center">
                                @Html.Partial("~/Views/CostiProgetto/_AzioniCostiProgetto.cshtml", t)
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 📱 CARD VIEW MOBILE -->
<div class="d-block d-md-none mt-3 px-2">
    @foreach (var t in Model)
    {
        <div class="border rounded shadow-sm p-3 mb-3 bg-white card-costo-progetto"
             data-codice="@t.ID_CodiceCosto"
             data-nome="@t.Nome"
             data-stato="@t.Stato">

            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold text-primary">@t.ID_CodiceCosto</span>
                <small class="text-muted text-end">
                    <strong>Stato:</strong> @t.Stato
                </small>
            </div>

            <div class="small text-muted mb-1">
                <strong>Nome:</strong> @t.Nome
            </div>

            <div class="small text-muted mb-1">
                <strong>Categoria:</strong>
                @(string.IsNullOrEmpty(t.NomeCategoria) ? "—" : t.NomeCategoria)
            </div>

            <div class="small text-muted mb-2">
                <strong>Ultima modifica:</strong>
                @(!t.DataUltimaModifica.HasValue
                    ? "-"
                    : t.DataUltimaModifica.Value.ToString("dd/MM/yyyy"))
            </div>

            @if (mostraAzioni)
            {
                <div class="d-flex flex-wrap gap-2 mt-2">
                    @Html.Partial("~/Views/CostiProgetto/_AzioniCostiProgetto.cshtml", t)
                </div>
            }
        </div>
    }
</div>

<!-- 🔄 Paginazione -->
<div id="paginazioneCostiProgetto" class="d-flex justify-content-end align-items-center gap-2 mt-2"></div>
<!-- 🧾 Modale Nuovo / Modifica Costo di Progetto -->
<div class="modal fade" id="costoProgettoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="costoProgettoForm">
            <div class="modal-content">
                <div class="modal-header text-black">
                    <h5 class="modal-title" id="costoProgettoModalLabel">Nuovo Costo di Progetto</h5>
                    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="ID_AnagraficaCosto" />

                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Nome</label>
                            <input name="Nome" type="text" class="form-control form-control-sm" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Categoria</label>
                            <select name="ID_Categoria" class="form-select form-select-sm" required>
                                <option value="">-- Seleziona categoria --</option>
                                @foreach (var cat in ViewBag.CategorieCosti as List<SelectListItem>)
                                {
                                    <option value="@cat.Value">@cat.Text</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Stato</label>
                            <select name="Stato" class="form-select form-select-sm">
                                <option value="Attivo">Attivo</option>
                                <option value="Inattivo">Inattivo</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Descrizione</label>
                            <textarea name="Descrizione" rows="3" class="form-control form-control-sm"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-success btn-sm">Salva</button>
                </div>
            </div>
        </form>
    </div>
</div>


@* Modale Eliminazione Costo di Progetto *@
<div class="modal fade" id="eliminaCostoProgettoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Elimina Costo di Progetto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Confermi l’eliminazione definitiva di questo costo di progetto?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneCostoProgetto">Elimina</button>
            </div>
        </div>
    </div>
</div>


<script>
    let idCostoProgettoDaEliminare = 0;

    // ➕ Nuovo
    function apriNuovoCostoProgetto() {
        const form = document.getElementById("costoProgettoForm");
        form.reset();
        form.querySelector('[name="ID_AnagraficaCosto"]').value = 0;
        document.getElementById("costoProgettoModalLabel").textContent = "Nuovo Costo di Progetto";
        new bootstrap.Modal(document.getElementById("costoProgettoModal")).show();
    }

    // ✏️ Modifica
    function apriModificaCostoProgetto(id) {
        fetch(`/Utenti/GetCostoProgetto?id=${id}`)
            .then(res => res.json())
            .then(res => {
                if (!res.success) return toastr.error("Errore nel caricamento del costo.");

                const c = res.costo;
                const form = document.getElementById("costoProgettoForm");
                form.reset();

                form.querySelector('[name="ID_AnagraficaCosto"]').value = c.ID_AnagraficaCosto;
                form.querySelector('[name="Nome"]').value = c.Nome;
                form.querySelector('[name="ID_Categoria"]').value = c.ID_Categoria; // 🏷️ nuovo
                form.querySelector('[name="Stato"]').value = c.Stato;
                form.querySelector('[name="Descrizione"]').value = c.Descrizione || '';

                document.getElementById("costoProgettoModalLabel").textContent = "Modifica Costo di Progetto";
                new bootstrap.Modal(document.getElementById("costoProgettoModal")).show();
            });
    }


    // 💾 Submit
    $('#costoProgettoForm').on('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const id = formData.get("ID_AnagraficaCosto");

        const url = id && parseInt(id) > 0
            ? '/Utenti/ModificaCostoProgetto'
            : '/Utenti/CreaCostoProgetto';

        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    bootstrap.Modal.getInstance(document.getElementById("costoProgettoModal")).hide();
                    location.reload();
                } else {
                    toastr.error(res.message);
                }
            });
    });

    // 🗑️ Elimina
    function confermaEliminazioneCostoProgetto(id) {
        idCostoProgettoDaEliminare = id;
        new bootstrap.Modal(document.getElementById("eliminaCostoProgettoModal")).show();
    }

    $('#btnConfermaEliminazioneCostoProgetto').on('click', function () {
        fetch('/Utenti/EliminaCostoProgetto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${idCostoProgettoDaEliminare}`
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    location.reload();
                } else {
                    toastr.error(res.message);
                }
            });
    });

    // 🔍 Filtro + Paginazione (Costi Progetto) — stile "Team"
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById('costiProgettoTable');
        if (!table) return;

        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const controlliContainer = document.getElementById('controlliCostiProgetto');
        const paginationContainer = document.getElementById('paginazioneCostiProgetto');

        const searchInput = document.createElement('input');
        const selectPageSize = document.createElement('select');

        let pageSize = 10;
        let currentPage = 1;

        // 🔍 Ricerca
        searchInput.type = 'text';
        searchInput.placeholder = 'Cerca...';
        searchInput.className = 'form-control form-control-sm w-auto';

        // 📄 Page Size
        [10, 25, 50].forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = `${num} `;
            selectPageSize.appendChild(option);
        });
        selectPageSize.className = 'form-select form-select-sm w-auto';
        selectPageSize.value = String(pageSize); // valore iniziale

        // ➕ Monta i controlli
        controlliContainer.appendChild(searchInput);
        controlliContainer.appendChild(selectPageSize);

        function renderTable() {
            const keyword = searchInput.value.toLowerCase();

            // 🖥️ Filtra righe tabella desktop
            const filteredRows = rows.filter(row =>
                row.innerText.toLowerCase().includes(keyword)
            );

            // 📱 Filtra card mobile
            const cards = Array.from(document.querySelectorAll('.card-costo-progetto'));
            const filteredCards = cards.filter(card =>
                card.innerText.toLowerCase().includes(keyword)
            );

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            currentPage = Math.min(currentPage, totalPages || 1);

            // 🖥️ Mostra solo righe desktop della pagina corrente
            rows.forEach(r => r.style.display = 'none');
            filteredRows
                .slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(r => r.style.display = '');

            // 📱 Mostra solo card mobile della pagina corrente
            cards.forEach(c => c.style.display = 'none');
            filteredCards
                .slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(c => c.style.display = '');

            // 🔄 Paginazione
            paginationContainer.innerHTML = '';
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Pagina ${currentPage} di ${totalPages || 1}`;
            pageInfo.className = 'me-2';
            paginationContainer.appendChild(pageInfo);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '← Indietro';
            prevBtn.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); };
            paginationContainer.appendChild(prevBtn);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Prossima →';
            nextBtn.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); };
            paginationContainer.appendChild(nextBtn);
        }

        // 🎯 Eventi
        searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
        selectPageSize.addEventListener('change', () => {
            pageSize = parseInt(selectPageSize.value, 10);
            currentPage = 1;
            renderTable();
        });

        renderTable();
    });

</script>
