@model IEnumerable<Sinergia.Models.OperaziomoFinanziarieViewModel>
@{
    var lista = Model?.ToList() ?? new List<Sinergia.Models.OperaziomoFinanziarieViewModel>();

    Func<string, string> badgeClass = t =>
        string.Equals(t, "Entrata", StringComparison.OrdinalIgnoreCase) ? "badge bg-success" : "badge bg-danger";
    Func<string, string> rowClass = t =>
        string.Equals(t, "Entrata", StringComparison.OrdinalIgnoreCase) ? "table-success" : "table-danger";

    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Operazioni Finanziarie";

    decimal totEntrate = lista.Where(x => string.Equals(x.TipoOperazione, "Entrata", StringComparison.OrdinalIgnoreCase))
                              .Sum(x => x.Importo);
    decimal totUscite = lista.Where(x => string.Equals(x.TipoOperazione, "Uscita", StringComparison.OrdinalIgnoreCase))
                              .Sum(x => x.Importo); // già negative
    decimal utileFin = totEntrate + totUscite;
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

<!-- 🏷️ Titolo principale -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="fa fa-bar-chart me-2 text-primary"></i> Operazioni Finanziarie
    </h4>
</div>

<div class="d-flex justify-content-between mb-2" id="controlliFinanziario">
    <div class="d-flex flex-wrap align-items-center gap-2">
        <input id="searchFin" type="text" class="form-control form-control-sm w-auto" placeholder="Cerca...">
        <select id="filtroTipoFin" class="form-select form-select-sm w-auto">
            <option value="Tutte">Tutte</option>
            <option value="Entrata">Entrate</option>
            <option value="Uscita">Uscite</option>
        </select>
        <select id="pageSizeFin" class="form-select form-select-sm w-auto">
            <option value="10">10 per pagina</option>
            <option value="25">25 per pagina</option>
            <option value="50">50 per pagina</option>
        </select>
    </div>
</div>

<!-- 📥 Export Operazioni Finanziarie CSV/PDF -->
<div class="d-flex justify-content-end mb-3">
    <form method="get" id="exportFinanziarieForm"
          class="d-flex flex-wrap flex-md-nowrap gap-2 align-items-center">

        <input type="date" name="da" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.AddMonths(-1).ToString("yyyy-MM-dd")" />

        <input type="date" name="a" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.ToString("yyyy-MM-dd")" />

        <button type="submit" formaction="@Url.Action("EsportaOperazioniFinanziarieCsv", "Home")"
                class="btn btn-outline-success btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-excel"></i> Excel/CSV
        </button>

        <button type="submit" formaction="@Url.Action("EsportaOperazioniFinanziariePdf", "Home")"
                class="btn btn-outline-danger btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>
    </form>
</div>


@if (!lista.Any())
{
    <div class="alert alert-info my-2">Nessuna operazione finanziaria nel periodo selezionato.</div>
}
else
{
    <!-- 🖥️ Tabella Desktop -->
    <div class="d-none d-md-block table-responsive">
        <table class="table table-striped table-bordered table-sm align-middle" id="finanziarioTable">
            <thead class="table-light">
                <tr>
                    <th style="width:110px;">Data</th>
                    <th style="width:95px;">Tipo</th>
                    <th>Descrizione</th>
                    <th>Categoria costo</th>
                    <th>Pratica</th>
                    <th class="text-end" style="width:160px;">Importo</th>
                    <th class="text-center" style="width:80px;">Azioni</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in lista)
                {
                    var tipo = string.Equals(r.TipoOperazione, "Entrata", StringComparison.OrdinalIgnoreCase) ? "Entrata" : "Uscita";
                    <tr class="@rowClass(tipo)" data-tipo="@tipo">
                        <td>@(r.DataOperazione?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td><span class="@badgeClass(tipo)">@tipo</span></td>
                        <td>@(string.IsNullOrWhiteSpace(r.Descrizione) ? "—" : r.Descrizione)</td>
                        <td>@(string.IsNullOrWhiteSpace(r.Categoria) ? "-" : r.Categoria)</td>
                        <td>@(string.IsNullOrWhiteSpace(r.NomePratica) ? "Generale" : r.NomePratica)</td>
                        <td class="text-end">@r.Importo.ToString("N2") €</td>
                        <td class="text-center">
                            <button class="btn btn-outline-primary btn-sm"
                                    title="Dettaglio"
                                    onclick="apriDettaglioFinanziario('@r.TipoOperazione', @r.ID_Operazione)">
                                <i class="fa fa-search"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 📱 Card Mobile -->
    <div class="d-block d-md-none mt-3">
        @foreach (var r in lista)
        {
            var tipo = string.Equals(r.TipoOperazione, "Entrata", StringComparison.OrdinalIgnoreCase) ? "Entrata" : "Uscita";
            <div class="border rounded shadow-sm p-3 mb-3 bg-white card-finanziario" data-tipo="@tipo">
                <div class="small text-muted"><strong>Data:</strong> @(r.DataOperazione?.ToString("dd/MM/yyyy") ?? "-")</div>
                <div><strong>Tipo:</strong> <span class="@badgeClass(tipo)">@tipo</span></div>
                <div><strong>Descrizione:</strong> @(string.IsNullOrWhiteSpace(r.Descrizione) ? "—" : r.Descrizione)</div>
                <div><strong>Categoria costo:</strong> @(string.IsNullOrWhiteSpace(r.Categoria) ? "-" : r.Categoria)</div>
                <div><strong>Pratica:</strong> @(string.IsNullOrWhiteSpace(r.NomePratica) ? "Generale" : r.NomePratica)</div>
                <div class="fw-bold @(tipo == "Entrata" ? "text-success" : "text-danger")">
                    @r.Importo.ToString("N2") €
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-primary btn-sm"
                            title="Dettaglio"
                            onclick="apriDettaglioFinanziario('@r.TipoOperazione', @r.ID_Operazione)">
                        <i class="fa fa-search"></i> Dettaglio
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- 🔄 Paginazione -->
    <div class="d-flex justify-content-end align-items-center gap-2 mt-2" id="paginazioneFinanziario"></div>

    <!-- Totali -->
    <div class="d-flex flex-wrap justify-content-end gap-3 mt-2">
        <div><strong>Totale entrate da pratiche:</strong> @totEntrate.ToString("N2") €</div>
        <div><strong>Totale uscite:</strong> @totUscite.ToString("N2") €</div>
        <div class="@(utileFin >= 0 ? "text-success" : "text-danger")">
            <strong>Utile Professionista:</strong> @utileFin.ToString("N2") €
        </div>
    </div>
}

@* Modale dettaglio *@
<div class="modal fade" id="dettaglioFinanziarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-black">
                <h5 class="modal-title">Dettaglio operazione</h5>
                <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contenutoDettaglioFin" class="small">Caricamento...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const table = document.getElementById('finanziarioTable');
        const tbody = table ? table.querySelector('tbody') : null;
        const allRows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

        // 📱 Card mobile
        const allCards = Array.from(document.querySelectorAll('.card-finanziario'));

        const searchInput = document.getElementById('searchFin');
        const tipoSelect = document.getElementById('filtroTipoFin');
        const pageSizeSelect = document.getElementById('pageSizeFin');
        const pagContainer = document.getElementById('paginazioneFinanziario');

        let pageSize = parseInt(pageSizeSelect.value || '10');
        let currentPage = 1;

        function matches(el, term, tipo) {
            const text = el.innerText.toLowerCase();
            const okTerm = !term || text.includes(term);

            if (tipo === 'Tutte') return okTerm;

            // Controlla tipo da classe o da data-attribute
            const isEntrata = el.classList.contains('table-success') || el.getAttribute('data-tipo') === 'Entrata';
            const isUscita = el.classList.contains('table-danger') || el.getAttribute('data-tipo') === 'Uscita';

            const okTipo = (tipo === 'Entrata' && isEntrata) || (tipo === 'Uscita' && isUscita);
            return okTerm && okTipo;
        }

        function render() {
            const term = (searchInput.value || '').toLowerCase();
            const tipo = tipoSelect.value || 'Tutte';

            // Filtra
            const filteredRows = allRows.filter(r => matches(r, term, tipo));
            const filteredCards = allCards.filter(c => matches(c, term, tipo));

            // Calcola pagine in base alla vista attiva
            const totalItems = window.innerWidth >= 768 ? filteredRows.length : filteredCards.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
            currentPage = Math.min(currentPage, totalPages);

            // 🖥️ Tabella desktop
            allRows.forEach(r => r.style.display = 'none');
            filteredRows
                .slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(r => r.style.display = '');

            // 📱 Card mobile
            allCards.forEach(c => c.style.display = 'none');
            filteredCards
                .slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(c => c.style.display = '');

            // 🔄 Paginazione
            pagContainer.innerHTML = '';
            const info = document.createElement('span');
            info.textContent = `Pagina ${currentPage} di ${totalPages}`;
            info.className = 'me-2';
            pagContainer.appendChild(info);

            const prev = document.createElement('button');
            prev.textContent = '← Indietro';
            prev.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prev.disabled = (currentPage === 1);
            prev.onclick = () => { currentPage--; render(); };
            pagContainer.appendChild(prev);

            const next = document.createElement('button');
            next.textContent = 'Prossima →';
            next.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            next.disabled = (currentPage === totalPages);
            next.onclick = () => { currentPage++; render(); };
            pagContainer.appendChild(next);
        }

        searchInput.addEventListener('input', () => { currentPage = 1; render(); });
        tipoSelect.addEventListener('change', () => { currentPage = 1; render(); });
        pageSizeSelect.addEventListener('change', () => { pageSize = parseInt(pageSizeSelect.value); currentPage = 1; render(); });

        render();
    })();


    // date helper
    function formatDate(val) {
        if (!val) return '-';
        const m = /Date\((\d+)\)/.exec(val);
        const d = m ? new Date(parseInt(m[1], 10)) : new Date(val);
        return isNaN(d) ? '-' : d.toLocaleDateString();
    }

    // dettaglio
    function apriDettaglioFinanziario(tipo, id) {
        const url = `/Home/GetDettaglioOperazioneFinanziaria?tipo=${encodeURIComponent(tipo)}&id=${encodeURIComponent(id)}`;
        const box = document.getElementById('contenutoDettaglioFin');
        box.innerHTML = 'Caricamento...';

        fetch(url)
            .then(r => r.json())
            .then(res => {
                if (!res.success) {
                    toastr.error(res.message || 'Errore nel caricamento del dettaglio.');
                    return;
                }

                if (res.tipo === 'Uscita') {
                    const d = res.dettaglio;
                    box.innerHTML = `
          <div class="row g-2">
            <div class="col-md-6"><strong>Categoria:</strong> ${d.Categoria ?? '-'}</div>
            <div class="col-md-6"><strong>Origine:</strong> ${d.Origine ?? '-'}</div>
            <div class="col-12"><strong>Descrizione:</strong> ${d.Descrizione ?? '-'}</div>
            <div class="col-md-4"><strong>Importo:</strong> ${(d.Importo ?? 0).toLocaleString(undefined, { minimumFractionDigits: 2 })} €</div>
            <div class="col-md-4"><strong>Data:</strong> ${formatDate(d.DataRegistrazione)}</div>
            <div class="col-md-4"><strong>Stato:</strong> ${d.Stato ?? '-'}</div>
            <div class="col-12"><strong>Pratica:</strong> ${d.Pratica ?? 'Generale'}</div>
          </div>`;
                } else {
                    const d = res.dettaglio;
                    box.innerHTML = `
          <div class="row g-2">
            <div class="col-md-6"><strong>Pratica:</strong> ${d.Pratica ?? 'Generale'}</div>
            <div class="col-md-6"><strong>Data incasso:</strong> ${formatDate(d.DataIncasso)}</div>
            <div class="col-md-4"><strong>Importo incassato:</strong> ${(d.Importo ?? 0).toLocaleString(undefined, { minimumFractionDigits: 2 })} €</div>
            <div class="col-md-4"><strong>Modalità pagamento:</strong> ${d.ModalitaPagamento ?? '-'}</div>
            <div class="col-md-4"><strong>In plafond:</strong> ${d.VersaInPlafond ? 'Sì' : 'No'}</div>
            <div class="col-md-4"><strong>Avviso collegato:</strong> ${d.ID_AvvisoParcella ?? '-'}</div>
            <div class="col-md-4"><strong>Data avviso:</strong> ${formatDate(d.DataAvviso)}</div>
          </div>`;
                }

                new bootstrap.Modal(document.getElementById('dettaglioFinanziarioModal')).show();
            })
            .catch(() => toastr.error('Errore di rete nel caricamento del dettaglio.'));
    }
</script>
