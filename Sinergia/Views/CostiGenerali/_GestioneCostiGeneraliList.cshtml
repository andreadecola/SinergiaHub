@model List<Sinergia.Models.TipologieCostiViewModel>

@{
    var permessiUtente = ViewBag.Permessi as Sinergia.Models.PermessiViewModel;
    var puoAggiungere = permessiUtente?.Permessi.Any(p => p.Aggiungi) == true;
    bool mostraAzioni = puoAggiungere || Model.Any(c => c.ID_TipoCosto > 0);
}

@section styles {
    <style>
        #tipologieCostiTable {
            table-layout: fixed;
            width: auto;
            max-width: 400px; /* riduci ancora la larghezza massima */
            margin: 0 auto;
        }

            #tipologieCostiTable th,
            #tipologieCostiTable td {
                padding: 2px 5px !important; /* padding minimo */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                vertical-align: middle;
                font-size: 0.85rem; /* più piccolo */
            }

                #tipologieCostiTable th:nth-child(1),
                #tipologieCostiTable td:nth-child(1) {
                    width: 180px; /* più stretto per Nome */
                }

                #tipologieCostiTable th:nth-child(2),
                #tipologieCostiTable td:nth-child(2) {
                    width: 70px;
                    text-align: center;
                }

                #tipologieCostiTable th:nth-child(3),
                #tipologieCostiTable td:nth-child(3) {
                    width: 90px;
                    text-align: center;
                }

        #categoriaStatic {
            border: 1px solid #ced4da;
            border-radius: 0.2rem;
            padding: 0.375rem 0.75rem;
            background-color: #e9ecef;
            height: calc(1.8125rem + 2px);
            line-height: 1.5;
            font-size: 0.875rem;
            color: #495057;
        }
    </style>
}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

<!-- 🔍 Controlli filtro/paginazione -->
<div id="controlliTipologieCosti" class="d-flex flex-wrap align-items-center gap-1 mb-2"></div>

<!-- ➕ Pulsante nuovo -->
<div class="d-flex justify-content-end mb-2">
    @if (puoAggiungere)
    {
        <button class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;" onclick="apriNuovaTipologiaCosto()">Nuovo Costo Generale</button>
    }
</div>

<!-- 🖥️ TABELLA DESKTOP -->
<div class="d-none d-md-block">
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm align-middle" id="tipologieCostiTable">
            <thead class="table-light">
                <tr>
                    <th class="text-nowrap">ID</th>
                    <th class="text-nowrap">Nome</th>
                    <th class="text-nowrap">Stato Costo</th>
                    <th class="text-nowrap">Ricorrenza</th>
                    @if (mostraAzioni)
                    {
                        <th class="text-center text-nowrap">Azioni</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model)
                {
                    <tr data-id="@t.ID_TipoCosto">
                        <td class="text-nowrap">@t.ID_CodiceCosto</td>
                        <td class="text-nowrap">@t.Nome</td>
                        <td class="text-nowrap">@t.Stato</td>
                        <td class="text-nowrap text-center">
                            @if (t.RicorrenzaAttiva == true)
                            {
                                <span class="badge bg-success">Attiva</span>
                            }
                            else if (t.DataInizioRicorrenza != null)
                            {
                                <span class="badge bg-secondary">Scaduta</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-muted">Nessuna</span>
                            }
                        </td>
                        @if (mostraAzioni)
                        {
                            <td class="text-center">
                                @Html.Partial("~/Views/CostiGenerali/_AzioniCostoGenerale.cshtml", t)
                            </td>
                        }
                        else
                        {
                            <td class="text-center text-muted small">—</td>
                        }


                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 📱 CARD VIEW MOBILE -->
<div class="d-block d-md-none mt-3 px-2">
    @foreach (var t in Model)
    {
        <div class="border rounded shadow-sm p-3 mb-3 bg-white card-costo" data-id="@t.ID_TipoCosto">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-primary">@t.Nome</span>
                <span class="badge stato bg-@(t.RicorrenzaAttiva == true ? "success" : t.DataInizioRicorrenza != null ? "secondary" : "light text-muted")">
                    @(t.RicorrenzaAttiva == true ? "Attiva" : t.DataInizioRicorrenza != null ? "Scaduta" : "Nessuna")
                </span>

            </div>

            <div class="small text-muted"><strong>ID:</strong> @t.ID_CodiceCosto</div>
            <div class="small text-muted"><strong>Stato:</strong> @t.Stato</div>

            @if (mostraAzioni)
            {
                <div class="d-flex flex-wrap gap-2 mt-2">
                    @Html.Partial("~/Views/CostiGenerali/_AzioniCostoGenerale.cshtml", t)
                </div>
            }

        </div>
    }
</div>

<!-- 🔄 Paginazione -->
<div id="paginazioneTipologieCosti" class="d-flex justify-content-end align-items-center gap-2 mt-2"></div>

@* modale nuovo modifica  *@
<div class="modal fade" id="tipologiaCostoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="tipologiaCostoForm">
            <div class="modal-content">
                <div class="modal-header text-black">
                    <h5 class="modal-title" id="tipologiaCostoModalLabel">Nuovo Costo Generale</h5>
                    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="ID_TipoCosto" />
                    <input type="hidden" name="TipoCostoApplicazione" value="Generale" />
                    <input type="hidden" name="Operazione" value="Inserimento" />
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label>Nome</label>
                            <input name="Nome" type="text" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-6">
                            <label>Stato</label>
                            <select name="Stato" class="form-select form-select-sm">
                                <option value="Attivo">Attivo</option>
                                <option value="Inattivo">Inattivo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-success btn-sm">Salva</button>
                </div>
            </div>
        </form>
    </div>
</div>

@* modale eliminazione *@
<div class="modal fade" id="eliminaTipologiaCostoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Elimina Tipologia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Confermi l’eliminazione della tipologia di costo fisso?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneTipologia">Elimina</button>
            </div>
        </div>
    </div>
</div>

<!-- Modale Conferma Eliminazione Assegnazione Costo Generale -->
<div class="modal fade" id="confermaEliminazioneAssegnazioneGeneraleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Vuoi davvero rimuovere questa assegnazione al professionista?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneAssegnazioneGenerale">Elimina</button>
            </div>
        </div>
    </div>
</div>



<!-- Modale Ricorrenza Costo Generale -->
<div class="modal fade" id="ricorrenzaCostoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="ricorrenzaCostoForm">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Gestione Ricorrenza Costo Generale</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ✅ MANTIENI -->
                    <input type="hidden" name="ID_AnagraficaCosto" />
                    <input type="hidden" name="ID_Professionista" />
                    <input type="hidden" name="ID_Professione" />
                    <input type="hidden" name="ID_Ricorrenza" />

                    <div class="row g-3">

                        <div class="col-md-4">
                            <label class="form-label">Periodicità</label>
                            <select name="Periodicita" class="form-select form-select-sm">
                                <option value="">-- Seleziona --</option>
                                <option value="Giornaliero">Giornaliero</option>
                                <option value="Settimanale">Settimanale</option>
                                <option value="Mensile">Mensile</option>
                                <option value="Bimestrale">Bimestrale</option>
                                <option value="Trimestrale">Trimestrale</option>
                                <option value="Semestrale">Semestrale</option>
                                <option value="Annuale">Annuale</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Tipo Valore</label>
                            <select name="TipoValore" class="form-select form-select-sm" required>
                                <option value="Fisso">Fisso</option>
                                <option value="Percentuale">Percentuale</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Valore</label>
                            <input type="number" name="Valore" step="0.01" min="0" class="form-control form-control-sm" required />
                        </div>

                        <div class="col-md-6" id="categoriaWrapper">
                            <label class="form-label">Categoria</label>

                            <input type="hidden" name="Categoria" value="Costo Generale" />

                            <div id="categoriaStatic" class="form-control-plaintext">Costo Generale</div>

                            <select id="selectCategoria" name="Categoria" class="form-select form-select-sm d-none">
                                <option value="">-- Seleziona Categoria --</option>
                                <option value="Costo Generale">Costo Generale</option>
                                <option value="Trattenuta Sinergia">Trattenuta Sinergia</option>
                                <option value="Owner Fee">Owner Fee</option>
                                <option value="Costo Fisso Resident">Costo Fisso Resident</option> <!-- ✅ MANCAVA -->
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Una Tantum</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="checkUnaTantum" />
                                <label class="form-check-label" for="checkUnaTantum">
                                    Applica solo una volta (una tantum)
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Data Inizio</label>
                            <input type="date" name="DataInizio" class="form-control form-control-sm" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Data Fine</label>
                            <input type="date" name="DataFine" class="form-control form-control-sm" />
                        </div>

                        <div class="col-12">
                            <label class="form-label">Note aggiuntive</label>
                            <textarea name="Note" rows="2" class="form-control form-control-sm" placeholder="Eventuali commenti..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="salvaRicorrenzaCosto()">Salva Ricorrenza</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Hidden utili -->
<input type="hidden" id="hiddenOwnerProfessionista" value="@(ViewBag.IDProfessionistaCorrente ?? "")" />
<input type="hidden" id="hiddenProfessione" value="@(ViewBag.IDProfessioneCorrente ?? "")" />

<!-- Modale Assegna Costo Generale -->
<div class="modal fade" id="assegnaCostoGeneraleModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <form id="assegnaCostoGeneraleForm" method="post">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assegna costo generale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="ID_TipoCostoGenerale" />
                    <div id="listaProfessionistiGeneraleContainer">
                        <!-- checkboxes dinamici caricati via JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success btn-sm">Salva</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modale Dettaglio Professionisti Assegnati -->
<div class="modal fade" id="dettaglioCostoGeneraleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">Professionisti assegnati al costo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="listaProfessionistiAssegnatiGenerale">
                    <!-- elenco dinamico via JS -->
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    let idTipologiaDaEliminare = 0;
    let idAssegnazioneGeneraleDaEliminare = 0;

    // ➕ Nuova Tipologia
    function apriNuovaTipologiaCosto() {
        const form = document.getElementById("tipologiaCostoForm");
        form.reset();
        form.querySelector('[name="ID_TipoCosto"]').value = 0;
        document.getElementById("tipologiaCostoModalLabel").textContent = "Nuovo Costo Generale";
        new bootstrap.Modal(document.getElementById("tipologiaCostoModal")).show();
    }

    // ✏️ Modifica con Ricorrenza
    function apriModificaTipologia(id) {
        fetch(`/Pratiche/GetTipologieCosti?id=${id}`)
            .then(res => res.json())
            .then(res => {
                if (!res.success) return toastr.error("Errore nel caricamento.");

                const t = res.tipologia;
                const form = document.getElementById("tipologiaCostoForm");
                form.reset();

                // 🔢 Campi base (solo quelli visibili nella tabella)
                form.querySelector('[name="ID_TipoCosto"]').value = t.ID_TipoCosto;
                form.querySelector('[name="Nome"]').value = t.Nome;
                form.querySelector('[name="Stato"]').value = t.Stato;

                // 🎯 Mostra solo la modale base con i campi principali
                document.getElementById("tipologiaCostoModalLabel").textContent = "Modifica Costo Generale";
                new bootstrap.Modal(document.getElementById("tipologiaCostoModal")).show();

            }
            )
    };


    // 💾 Submit
    $('#tipologiaCostoForm').on('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const id = formData.get("ID_TipoCosto");

        const url = id && parseInt(id) > 0
            ? '/Pratiche/ModificaTipologiaCosto'
            : '/Pratiche/CreaTipologiaCosto';

        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    bootstrap.Modal.getInstance(document.getElementById("tipologiaCostoModal")).hide();
                    location.reload();
                } else {
                    toastr.error(res.message);
                }
            });
    });

    // 🗑️ Elimina
    function confermaEliminazioneTipologia(id) {
        idTipologiaDaEliminare = id;
        new bootstrap.Modal(document.getElementById("eliminaTipologiaCostoModal")).show();
    }

    $('#btnConfermaEliminazioneTipologia').on('click', function () {
        fetch('/Pratiche/EliminaTipologiaCosto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${idTipologiaDaEliminare}`
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    location.reload();
                } else {
                    toastr.error(res.message);
                }
            });
    });

    // gestione assegnazione costo generale
    function apriAssegnaCostoGenerale(idCosto) {
        fetch(`/Pratiche/GetListaProfessionistiAssegnabiliRicorrenza?idCosto=${idCosto}`)
            .then(r => r.json())
            .then(res => {
                const container = document.getElementById("listaProfessionistiGeneraleContainer");
                const form = document.getElementById("assegnaCostoGeneraleForm");
                form.reset();
                form.querySelector('[name="ID_TipoCostoGenerale"]').value = idCosto;

                if (!res.success || !Array.isArray(res.professionisti) || res.professionisti.length === 0) {
                    container.innerHTML = "<div class='alert alert-warning'>Nessun professionista disponibile.</div>";
                } else {
                    container.innerHTML = res.professionisti.map(p => `
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="ID_UtentiSelezionati" value="${p.ID}" id="checkGenerale_${p.ID}">
                        <label class="form-check-label" for="checkGenerale_${p.ID}">${p.Nome}</label>
                    </div>
                `).join('');
                }

                new bootstrap.Modal(document.getElementById("assegnaCostoGeneraleModal")).show();
            })
            .catch(err => {
                console.error("Errore fetch professionisti:", err);
                toastr.error("Errore durante il caricamento dei professionisti.");
            });
    }

    // submit assegnazione
    document.getElementById("assegnaCostoGeneraleForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const checkboxSelezionati = [...this.querySelectorAll('input[name="ID_UtentiSelezionati"]:checked')];

        if (checkboxSelezionati.length === 0) {
            toastr.warning("⚠️ Seleziona almeno un professionista.");
            return;
        }

        fetch("/Pratiche/AssegnaRicorrenzaCostoGenerale", {
            method: "POST",
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message || "Assegnazione completata.");
                    bootstrap.Modal.getInstance(document.getElementById("assegnaCostoGeneraleModal")).hide();
                    location.reload();
                } else {
                    toastr.error(res.message || "Errore durante l’assegnazione.");
                }
            })
            .catch(err => {
                toastr.error("Errore durante l’assegnazione.");
                console.error(err);
            });
    });


    // dettaglio assegnazione
    function apriDettaglioCostoGenerale(idCosto) {
        fetch(`/Pratiche/VisualizzaAssegnazioniRicorrenza?idTipoCosto=${idCosto}`)
            .then(r => r.json())
            .then(res => {
                const container = document.getElementById("listaProfessionistiAssegnatiGenerale");

                if (!res.success || !Array.isArray(res.assegnazioni) || res.assegnazioni.length === 0) {
                    container.innerHTML = "<div class='alert alert-info'>Nessun professionista assegnato.</div>";
                } else {
                    container.innerHTML = `
                <ul class="list-group">
                    ${res.assegnazioni.map(p => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${p.NomeProfessionista}</strong>
                                <small class="text-muted ms-2">(${p.DataAssegnazione})</small>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge bg-primary">${p.Importo}</span>
                                <button class="btn btn-sm btn-danger"
                                        onclick="confermaEliminazioneAssegnazioneGenerale(${p.ID_Ricorrenza})"
                                        title="Rimuovi assegnazione">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </li>
                    `).join('')}
                </ul>
                `;
                }

                document.getElementById("hiddenIDGeneraleAttivo")?.remove();
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.id = "hiddenIDGeneraleAttivo";
                hiddenInput.value = idCosto;
                document.body.appendChild(hiddenInput);

                new bootstrap.Modal(document.getElementById("dettaglioCostoGeneraleModal")).show();
            })
            .catch(err => {
                console.error("Errore fetch dettaglio:", err);
                toastr.error("Errore durante il recupero dei dati.");
            });
    }

    // eliminazione assegnazione

    function confermaEliminazioneAssegnazioneGenerale(idAssegnazione) {
        idAssegnazioneGeneraleDaEliminare = idAssegnazione;

        const modaleDettaglio = bootstrap.Modal.getInstance(document.getElementById("dettaglioCostoGeneraleModal"));
        if (modaleDettaglio) modaleDettaglio.hide();

        setTimeout(() => {
            new bootstrap.Modal(document.getElementById("confermaEliminazioneAssegnazioneGeneraleModal")).show();
        }, 400);
    }

    document.getElementById("btnConfermaEliminazioneAssegnazioneGenerale").addEventListener("click", function () {
        if (!idAssegnazioneGeneraleDaEliminare) return;

        fetch('/Pratiche/EliminaAssegnazioneCostoGenerale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `idRicorrenza=${idAssegnazioneGeneraleDaEliminare}` // ✅ nome parametro corretto
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    bootstrap.Modal.getInstance(document.getElementById("confermaEliminazioneAssegnazioneGeneraleModal"))?.hide();

                    setTimeout(() => {
                        const idCosto = document.getElementById("hiddenIDGeneraleAttivo")?.value;
                        if (idCosto) apriDettaglioCostoGenerale(idCosto);
                    }, 500);
                } else {
                    toastr.error(res.message);
                }
            })
            .catch(err => {
                console.error("Errore eliminazione:", err);
                toastr.error("Errore durante l’eliminazione dell’assegnazione.");
            });
    });





    //  ricorrenza costo


    function apriModaleRicorrenza(idAnagraficaCosto) {

        console.log("=== DEBUG apriModaleRicorrenza ===");
        console.log("ID Anagrafica:", idAnagraficaCosto);

        const form = document.getElementById("ricorrenzaCostoForm");
        form.reset();

        form.querySelector('[name="ID_AnagraficaCosto"]').value = idAnagraficaCosto;
        form.querySelector('[name="ID_Ricorrenza"]').value = "";

        const selectCategoria = document.getElementById("selectCategoria");

        fetch(`/Pratiche/GetRicorrenzaCostoGenerale?idAnagraficaCosto=${idAnagraficaCosto}`)
            .then(r => r.json())
            .then(res => {

                console.log("🔍 Risposta server:", res);

                // ====================================================
                // 1️⃣ NESSUNA RICORRENZA → NUOVA
                // ====================================================
                if (!res.success) {

                    console.log("→ Nessuna ricorrenza trovata → nuova ricorrenza");

                    let categoria = res.categoria || "Costo Generale";
                    console.log("Categoria default impostata:", categoria);

                    selectCategoria.value = categoria;

                    // 🔥 FIX: aggiorna anche l'HIDDEN Categoria
                    form.querySelector('[name="Categoria"]').value = categoria;

                    // Nascondi statico, mostra select
                    document.getElementById("categoriaWrapper").style.display = "none";
                    selectCategoria.classList.remove("d-none");

                    document.getElementById("checkUnaTantum").checked = false;
                    aggiornaCampiUnaTantum();

                    form.querySelector('[name="Periodicita"]').disabled = false;
                    form.querySelector('[name="DataInizio"]').disabled = false;
                    form.querySelector('[name="DataFine"]').disabled = false;
                    document.getElementById("checkUnaTantum").closest(".form-check").style.display = "";

                    new bootstrap.Modal(document.getElementById("ricorrenzaCostoModal")).show();
                    return;
                }

                // ====================================================
                // 2️⃣ RICORRENZA ESISTENTE → MODIFICA
                // ====================================================
                console.log("→ Modalità editing ricorrenza esistente");

                const r = res.ricorrenza;

                form.querySelector('[name="ID_Ricorrenza"]').value = r.ID_Ricorrenza || "";
                form.querySelector('[name="Periodicita"]').value = r.Periodicita || "";
                form.querySelector('[name="TipoValore"]').value = r.TipoValore || "";
                form.querySelector('[name="Valore"]').value = r.Valore || "";
                form.querySelector('[name="Note"]').value = r.Note || "";

                if (r.DataInizio) form.querySelector('[name="DataInizio"]').value = r.DataInizio;
                if (r.DataFine) form.querySelector('[name="DataFine"]').value = r.DataFine;

                selectCategoria.value = r.Categoria;

                // 🔥 FIX: aggiorna anche l’HIDDEN Categoria
                form.querySelector('[name="Categoria"]').value = r.Categoria;

                // Categoria statica
                document.getElementById("categoriaWrapper").style.display = "block";
                selectCategoria.classList.add("d-none");
                document.getElementById("categoriaStatic").textContent = r.Categoria;

                // ====================================================
                // UNA-TANTUM
                // ====================================================
                const checkUnaTantum = document.getElementById("checkUnaTantum");

                // Se esiste periodicità (Mensile, Trimestrale, ecc.) → NON è una tantum
                if (r.Periodicita && r.Periodicita !== "") {
                    checkUnaTantum.checked = false;
                } else {
                    // se NON c’è periodicità → allora può essere una tantum
                    if (r.DataInizio && r.DataFine && r.DataInizio === r.DataFine) {
                        checkUnaTantum.checked = true;
                    } else {
                        checkUnaTantum.checked = false;
                    }
                }

                aggiornaCampiUnaTantum();
                // ====================================================
                // COSTI SPECIALI
                // ====================================================
                const categoriaNorm = (r.Categoria || "").trim().toLowerCase();
                const èSpeciale =
                    categoriaNorm === "owner fee" ||
                    categoriaNorm === "trattenuta sinergia";
               
                console.log("Categoria normalizzata:", categoriaNorm);
                console.log("È un costo speciale?:", èSpeciale);

                const periodicitaField = form.querySelector('[name="Periodicita"]');
                const dataInizioField = form.querySelector('[name="DataInizio"]');
                const dataFineField = form.querySelector('[name="DataFine"]');

                if (èSpeciale) {
                    console.log("→ Costo speciale: disabilito campi");

                    periodicitaField.value = "";
                    dataInizioField.value = "";
                    dataFineField.value = "";

                    periodicitaField.disabled = true;
                    dataInizioField.disabled = true;
                    dataFineField.disabled = true;

                    document.getElementById("checkUnaTantum").closest(".form-check").style.display = "none";

                    toastr.info(`⚙️ "${r.Categoria}" non richiede periodicità né date.`);
                } else {
                    periodicitaField.disabled = false;
                    dataInizioField.disabled = false;
                    dataFineField.disabled = false;
                    document.getElementById("checkUnaTantum").closest(".form-check").style.display = "";
                }

                new bootstrap.Modal(document.getElementById("ricorrenzaCostoModal")).show();

            })
            .catch(err => {
                console.error("Errore:", err);
                toastr.error("❌ Errore durante il caricamento della ricorrenza.");
            });
    }


    function salvaRicorrenzaCosto() {

        console.log("=== 🟦 DEBUG salvaRicorrenzaCosto ===");

        const form = document.getElementById("ricorrenzaCostoForm");
        const formData = new FormData(form);

        const categoria = formData.get("Categoria");
        console.log("📌 Categoria letta dal form:", categoria);

        // =============================
        // ID PROFESSIONISTA / PROFESSIONE
        // =============================
        const idProfessionista = document.getElementById("hiddenOwnerProfessionista")?.value;
        const idProfessione = document.getElementById("hiddenProfessione")?.value;

        console.log("ID Professionista:", idProfessionista);
        console.log("ID Professione:", idProfessione);

        if (idProfessionista) formData.set("ID_Professionista", idProfessionista);
        if (idProfessione) formData.set("ID_Professione", idProfessione);

        // =============================
        // CAMPi MODALE
        // =============================
        const periodicitaField = form.querySelector('[name="Periodicita"]');
        const dataInizioField = form.querySelector('[name="DataInizio"]');
        const dataFineField = form.querySelector('[name="DataFine"]');

        const periodicitaVal = periodicitaField.value;
        const dataInizioVal = dataInizioField.value;
        const dataFineVal = dataFineField.value;

        console.log("Periodicità:", periodicitaVal);
        console.log("Data Inizio:", dataInizioVal);
        console.log("Data Fine:", dataFineVal);

        // Scrive nel formData, anche se i campi sono disabilitati
        formData.set("Periodicita", periodicitaVal);
        formData.set("DataInizio", dataInizioVal);
        formData.set("DataFine", dataFineVal);

        // =============================
        // COSTI SPECIALI
        // =============================
        const categoriaNorm = (categoria || "").trim().toLowerCase();

        const èSpeciale =
            categoriaNorm === "owner fee" ||
            categoriaNorm === "trattenuta sinergia" ;

        console.log("Categoria normalizzata:", categoriaNorm);
        console.log("È un costo speciale?:", èSpeciale);

        if (èSpeciale) {
            console.log("➡ Imposto periodicità e date a stringa vuota (speciale)");

            formData.set("Periodicita", "");
            formData.set("DataInizio", "");
            formData.set("DataFine", "");

            periodicitaField.disabled = true;
            dataInizioField.disabled = true;
            dataFineField.disabled = true;
        }

        // =============================
        // VALIDAZIONE BASE
        // =============================
        const idTipoCosto = formData.get("ID_AnagraficaCosto");
        const tipoValore = formData.get("TipoValore");
        const valore = formData.get("Valore");
        const periodicita = formData.get("Periodicita");

        console.log("ID Tipo Costo:", idTipoCosto);
        console.log("Tipo Valore:", tipoValore);
        console.log("Valore:", valore);
        console.log("Periodicità (finale):", periodicita);

        if (!idTipoCosto || !tipoValore || !valore || !categoria) {
            console.warn("⚠️ Validazione fallita: manca un campo obbligatorio.");
            toastr.warning("⚠️ Compilare tutti i campi obbligatori.");
            return;
        }

        if (!èSpeciale) {
            console.log("Validazione su periodicità perché NON è speciale...");
            if (!periodicita || !dataInizioVal) {
                console.warn("⚠️ Manca Periodicità o DataInizio → blocco salvataggio.");
                toastr.warning("⚠️ Compilare Periodicità e Data Inizio.");
                return;
            }
        } else {
            console.log("✨ Nessuna validazione date/periodicità perché è un costo speciale.");
        }

        // =============================
        // DEBUG COMPLETO FORM DATA
        // =============================
        console.log("===== 📦 FORM DATA INVIATO AL SERVER =====");
        for (let [key, val] of formData.entries()) {
            console.log(key + ":", val);
        }
        console.log("===========================================");

        // =============================
        // INVIO AL SERVER
        // =============================
        fetch('/Pratiche/SalvaRicorrenzaCostoGenerale', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(res => {
                console.log("📥 Risposta server:", res);

                if (res.success) {
                    toastr.success("✅ Ricorrenza salvata correttamente.");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("ricorrenzaCostoModal"));
                    if (modal) modal.hide();
                } else {
                    toastr.error("❌ Errore durante il salvataggio: " + (res.message || ""));
                }
            })
            .catch(err => {
                console.error("❌ ERRORE FETCH:", err);
                toastr.error("❌ Errore di rete durante il salvataggio.");
            });
    }



    // ✅ Funzione GLOBALE, dichiarata fuori da DOMContentLoaded
    function aggiornaCampiUnaTantum() {
        const checkbox = document.getElementById("checkUnaTantum");
        const periodicita = document.querySelector('[name="Periodicita"]');
        const dataInizio = document.querySelector('[name="DataInizio"]');
        const dataFine = document.querySelector('[name="DataFine"]');
        const oggi = new Date().toISOString().slice(0, 10); // yyyy-MM-dd

        if (checkbox.checked) {
            periodicita.value = "Giornaliero";
            if (!dataInizio.value) dataInizio.value = oggi;
            dataFine.value = dataInizio.value;

            // 🔒 Disabilita i campi
            periodicita.disabled = true;
            dataInizio.disabled = true;
            dataFine.disabled = true;
        } else {
            // 🔓 Riabilita i campi
            periodicita.disabled = false;
            dataInizio.disabled = false;
            dataFine.disabled = false;
        }
    }


    // ✅ Comportamento checkbox Una Tantum
    document.addEventListener("DOMContentLoaded", function () {
        const checkbox = document.getElementById("checkUnaTantum");
        const dataInizio = document.querySelector('[name="DataInizio"]');
        const dataFine = document.querySelector('[name="DataFine"]');

        // ✅ Quando cambia lo stato della checkbox → aggiorna dinamicamente i campi
        checkbox.addEventListener("change", aggiornaCampiUnaTantum);

        // ✅ Validazione: DataFine non può essere prima di DataInizio
        const validateDateRange = () => {
            const start = new Date(dataInizio.value);
            const end = new Date(dataFine.value);

            if (dataInizio.value && dataFine.value && end < start) {
                toastr.warning("⚠️ La Data Fine non può essere precedente alla Data Inizio.");
                dataFine.value = "";
            }
        };

        dataInizio.addEventListener("change", validateDateRange);
        dataFine.addEventListener("change", validateDateRange);
    });



    // 🔍 Filtro e paginazione - Tipologie Costi Generali
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById('tipologieCostiTable');
        if (!table) return;

        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const cards = Array.from(document.querySelectorAll('.card-costo')); // per mobile

        const controlliContainer = document.getElementById('controlliTipologieCosti');
        const paginationContainer = document.getElementById('paginazioneTipologieCosti');

        const searchInput = document.createElement('input');
        const selectPageSize = document.createElement('select');
        const selectStato = document.createElement('select');

        let pageSize = 10;
        let currentPage = 1;

        // 🔍 Ricerca
        searchInput.type = 'text';
        searchInput.placeholder = 'Cerca...';
        searchInput.className = 'form-control form-control-sm w-auto';

        // 📄 Page Size
        [10, 25, 50].forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = `${num} per pagina`;
            selectPageSize.appendChild(option);
        });
        selectPageSize.className = 'form-select form-select-sm w-auto';

        // ⚙️ Ricorrenza
        const labelRicorrenza = document.createElement('label');
        labelRicorrenza.textContent = 'Ricorrenza:';
        labelRicorrenza.className = 'form-label mb-0 me-1';

        ['Tutti', 'Attiva', 'Scaduta', 'Nessuna'].forEach(stato => {
            const option = document.createElement('option');
            option.value = stato;
            option.textContent = stato;
            selectStato.appendChild(option);
        });
        selectStato.className = 'form-select form-select-sm w-auto';

        // ➕ Controlli nella barra
        controlliContainer.appendChild(searchInput);
        controlliContainer.appendChild(labelRicorrenza);
        controlliContainer.appendChild(selectStato);
        controlliContainer.appendChild(selectPageSize);

        function renderTable() {
            const keyword = searchInput.value.toLowerCase();
            const filtroStato = selectStato.value;

            // Filtra righe
            let filteredRows = rows.filter(row => {
                const text = row.innerText.toLowerCase();
                const statoCell = row.querySelector('td:nth-child(4)'); // colonna ricorrenza
                const stato = statoCell ? statoCell.innerText.trim() : '';
                const statoMatch = (filtroStato === 'Tutti' || stato.includes(filtroStato));
                return text.includes(keyword) && statoMatch;
            });

            // Filtra card
            let filteredCards = cards.filter(card => {
                const text = card.innerText.toLowerCase();
                const statoEl = card.querySelector('.stato'); // <span class="stato">Attiva</span>
                const stato = statoEl ? statoEl.innerText.trim() : '';
                const statoMatch = (filtroStato === 'Tutti' || stato.includes(filtroStato));
                return text.includes(keyword) && statoMatch;
            });

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            currentPage = Math.min(currentPage, totalPages || 1);

            // 🖥️ Tabella desktop
            rows.forEach(r => r.style.display = 'none');
            filteredRows.slice((currentPage - 1) * pageSize, currentPage * pageSize).forEach(r => r.style.display = '');

            // 📱 Card mobile
            cards.forEach(c => c.style.display = 'none');
            filteredCards.slice((currentPage - 1) * pageSize, currentPage * pageSize).forEach(c => c.style.display = '');

            // 🔄 Paginazione
            paginationContainer.innerHTML = '';
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Pagina ${currentPage} di ${totalPages || 1}`;
            pageInfo.className = 'me-2';
            paginationContainer.appendChild(pageInfo);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '← Indietro';
            prevBtn.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); };
            paginationContainer.appendChild(prevBtn);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Prossima →';
            nextBtn.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); };
            paginationContainer.appendChild(nextBtn);
        }

        // Eventi
        searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
        selectStato.addEventListener('change', () => { currentPage = 1; renderTable(); });
        selectPageSize.addEventListener('change', () => {
            pageSize = parseInt(selectPageSize.value);
            currentPage = 1;
            renderTable();
        });

        renderTable();
    });



</script>
