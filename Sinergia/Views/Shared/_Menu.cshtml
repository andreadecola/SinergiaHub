@{
    var menu = Session["menuLinks"] as List<Sinergia.Models.MenuViewModel> ?? new List<Sinergia.Models.MenuViewModel>();
    var utente = Session["User"] as Sinergia.Model.Utenti;

    var vociSingole = menu
        .Where(x => x.ÈValido?.ToUpper() == "SI" && x.VoceSingola?.Trim() == "1")
        .ToList();

    var vociRaggruppate = menu
        .Where(x => x.ÈValido?.ToUpper() == "SI" && (x.VoceSingola?.Trim() != "1" || x.VoceSingola == null))
        .GroupBy(x => x.CategoriaMenu)
        .ToList();
}

<!-- Sidebar Header -->
@if (utente != null)
{
    <div class="sidebar-header px-3 py-2">
        <span class="fw-bold text-white">
            @(utente.Nome.ToLower() == "admin" && utente.Cognome.ToLower() == "admin"
                ? "admin"
                : utente.Nome + " " + utente.Cognome)
        </span>
    </div>
}

<ul class="nav flex-column" id="sidebarMenu">

    @* VOCI SINGOLE *@
    @foreach (var voce in vociSingole)
    {
        <li class="nav-item">
            <a class="nav-link" href="@Url.Action(voce.Azione, voce.Controller)">
                <i class="@voce.Icona me-2"></i> @voce.NomeMenu
            </a>
        </li>
    }

    @* VOCI RAGGRUPPATE CON COLLAPSE *@
    @foreach (var group in vociRaggruppate)
    {
        var categoriaId = "submenu-" + (group.Key ?? "nessuna").Replace(" ", "").ToLower();
        var icona = group.First().Icona;

        <li class="nav-item menu-categoria">
            <a class="nav-link dropdown-toggle collapsed"
               href="#@categoriaId"
               data-bs-toggle="collapse"
               role="button"
               aria-expanded="false"
               aria-controls="@categoriaId">
                <i class="@icona me-2"></i> @group.Key
            </a>
            <ul class="collapse list-unstyled ps-4"
                id="@categoriaId"
                data-bs-parent="#sidebarMenu">
                @* 👈 questo chiude gli altri *@
                @foreach (var voce in group)
                {
                    <li>
                        <a class="nav-link" href="@Url.Action(voce.Azione, voce.Controller)">
                            @voce.NomeMenu
                        </a>
                    </li>
                }
            </ul>
        </li>
    }
</ul>
