@model List<Sinergia.Models.FinanziamentiProfessionistiViewModel>
@{
    var puoAggiungere = ViewBag.PuoAggiungere == true;
    var permessiUtente = ViewBag.Permessi as Sinergia.Models.PermessiViewModel;
    bool mostraAzioni = puoAggiungere || Model.Any();
    var professionisti = ViewBag.Professionisti as List<SelectListItem> ?? new List<SelectListItem>();
    var tipoUtente = ViewBag.TipoUtenteCorrente as string;
    var idUtenteCorrente = (int?)ViewBag.IDUtenteCorrente;
    var nomeUtenteCorrente = ViewBag.NomeUtenteCorrente as string;

}


@section styles {
    <style>
        #plafondTable th, #plafondTable td {
            white-space: nowrap;
            vertical-align: middle;
        }
    </style>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

<!-- 🔍 Controlli filtro/paginazione -->
<div id="controlliPlafondTable"
     class="d-flex flex-wrap align-items-center gap-1 mb-2"
     data-mostra-pagamenti="@ViewBag.MostraPagamenti">
</div>

<!-- ℹ️ Legenda -->
<div class="alert alert-info py-2 px-3 mb-3">
    <strong>Legenda:</strong>
    <ul class="mb-0 small">
        <li>
            <strong>💰 Finanziamento (versamento):</strong>
            importo versato dal professionista per alimentare il proprio plafond.
        </li>
        <li>
            <strong>🧾 Costo Personale (spesa):</strong>
            spesa sostenuta dal professionista, che verrà scalata dal plafond disponibile.
        </li>
        <li>
            <strong>🏦 Prelievo (bonifico):</strong>
            importo prelevato dal plafond e bonificato al professionista (uscita di cassa).
        </li>
    </ul>
</div>


<!-- ➕ Pulsanti aggiunta -->
<div class="d-flex justify-content-end mb-2">
    @if (puoAggiungere)
    {
        <button class="btn btn-outline-success btn-sm mx-2" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;"
                onclick="apriNuovoFinanziamento()"
                title="Registra un versamento effettuato dal professionista per aumentare il plafond."
                data-bs-toggle="tooltip">
            <i class="fa fa-piggy-bank me-1"></i> Finanziamento (versamento)
        </button>

        <button class="btn btn-outline-danger btn-sm" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;"
                onclick="apriModaleCostoPersonale()"
                title="Registra una spesa personale sostenuta dal professionista. Sarà scalata dal plafond disponibile.">
            <i class="fa fa-receipt me-1"></i> Costo Personale (spesa)
        </button>
    }

    <button class="btn btn-outline-primary btn-sm mx-2"
            style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;"
            onclick="apriModalePrelievoProfessionista()"
            title="Registra un prelievo/bonifico al professionista (uscita dal plafond).">
        <i class="fa fa-university me-1"></i> Prelievo (bonifico)
    </button>

</div>
<!-- 🖥️ TABELLA DESKTOP -->
<div class="d-none d-md-block">
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="plafondTable">
            <thead>
                <tr>
                    <th>Professionista</th>
                    <th>Tipo Plafond</th>

                    <!-- 🆕 -->
                    <th>Pratica</th>
                    <th>Avviso</th>
                    <th>Incasso</th>

                    <th>Origine Movimento</th>
                    <th>Importo</th>
                    <th>Data Versamento</th>

                    @if (mostraAzioni)
                    {
                        <th class="text-center">Azioni</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var p in Model)
                {
                    <tr data-id="@p.ID_Finanziamento"
                        data-id-pratica="@p.ID_Pratiche"
                        data-id-avviso="@p.ID_AvvisoParcella"
                        data-id-incasso="@p.ID_Incasso">

                        <td>@p.NomeProfessionista</td>
                        <td>@p.TipoPlafond</td>

                        <!-- 🆕 PRATICA -->
                        <td>
                            @if (p.ID_Pratiche.HasValue)
                            {
                                <a class="badge bg-info text-decoration-none"
                                   href="@Url.Action("GestionePratiche", "Pratiche", new { id = p.ID_Pratiche })"
                                   title="Apri pratica">
                                    @(!string.IsNullOrWhiteSpace(p.NomePratica) ? p.NomePratica : $"#{p.ID_Pratiche}")
                                </a>
                            }
                            else
                            { <span class="text-muted">-</span>}
                        </td>


                        <!-- 🆕 AVVISO -->
                        <td class="text-center">
                            @if (p.ID_AvvisoParcella.HasValue)
                            {
                                <a class="badge bg-warning text-dark text-decoration-none"
                                   href="@Url.Action("GestioneParcelle", "Pratiche")"
                                   title="Apri lista avvisi parcella">
                                    @(!string.IsNullOrWhiteSpace(p.NumeroAvviso)
                                    ? p.NumeroAvviso
                                    : $"#{p.ID_AvvisoParcella}")
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>


                        <!-- 🆕 INCASSO -->
                        <td class="text-center">
                            @if (p.ID_Incasso.HasValue)
                            {
                                <a class="badge bg-success text-decoration-none"
                                   href="@Url.Action("GestioneIncassi", "Pratiche", new { id = p.ID_Incasso })"
                                   title="Apri incasso">
                                    #@p.ID_Incasso
                                </a>
                            }
                            else
                            { <span class="text-muted">-</span>}
                        </td>


                        <td>@(string.IsNullOrEmpty(p.OrigineMovimento) ? "-" : p.OrigineMovimento)</td>

                        <td class="text-end">@p.Importo.ToString("N2")</td>
                        <td width="200px">@(p.DataVersamento?.ToString("yyyy-MM-dd") ?? "")</td>

                        @if (mostraAzioni)
                        {
                            <td class="text-center">
                                @Html.Partial("~/Views/Plafond/_AzioniPlafond.cshtml", p)
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


<!-- 📱 CARD VIEW MOBILE -->
<div class="d-block d-md-none mt-3 px-2">
    @foreach (var p in Model)
    {
        <div class="border rounded shadow-sm p-3 mb-3 bg-white card-plafond"
             data-id="@p.ID_Finanziamento"
             data-id-pratica="@p.ID_Pratiche"
             data-id-avviso="@p.ID_AvvisoParcella"
             data-id-incasso="@p.ID_Incasso">

            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-primary">@p.NomeProfessionista</span>
                <span class="badge bg-secondary">@p.TipoPlafond</span>
            </div>

            <!-- 🆕 PRATICA -->
            @if (p.ID_Pratiche.HasValue)
            {
                <div class="small text-muted">
                    <strong>Pratica:</strong>
                    @if (p.ID_Pratiche.HasValue)
                    {
                        <a class="badge bg-info text-decoration-none"
                           href="@Url.Action("GestionePratiche", "Pratiche", new { id = p.ID_Pratiche })">
                            @(!string.IsNullOrWhiteSpace(p.NomePratica) ? p.NomePratica : $"#{p.ID_Pratiche}")
                        </a>
                    }
                    else
                    { <span>-</span>}
                </div>
            }

            <!-- 🆕 AVVISO -->

            <div class="small text-muted mt-1">
                <strong>Avviso:</strong>
                @if (p.ID_AvvisoParcella.HasValue)
                {
                    <a class="badge bg-warning text-dark text-decoration-none"
                       href="@Url.Action("GestioneAParcelle", "Pratiche", new { id = p.ID_AvvisoParcella })">
                        @(!string.IsNullOrWhiteSpace(p.NumeroAvviso) ? p.NumeroAvviso : $"#{p.ID_AvvisoParcella}")
                    </a>
                }
                else
                { <span>-</span>}
            </div>

            <!-- 🆕 INCASSO -->
            <div class="small text-muted mt-1">
                <strong>Incasso:</strong>
                @if (p.ID_Incasso.HasValue)
                {
                    <a class="badge bg-success text-decoration-none"
                       href="@Url.Action("GestioneIncassi", "Pratiche", new { id = p.ID_Incasso })">
                        #@p.ID_Incasso
                    </a>
                }
                else
                { <span>-</span>}
            </div>

            <!-- 🆕 ORIGINE -->
            @if (!string.IsNullOrEmpty(p.OrigineMovimento))
            {
                <div class="small text-muted">
                    <strong>Origine:</strong> @p.OrigineMovimento
                </div>
            }

            <div class="small text-muted text-end">
                <strong>Importo:</strong> @p.Importo.ToString("N2")
            </div>

            <div class="small text-muted">
                <strong>Data:</strong> @(p.DataVersamento?.ToString("dd/MM/yyyy") ?? "-")
            </div>

            @if (mostraAzioni)
            {
                <div class="d-flex flex-wrap gap-2 mt-2">
                    @Html.Partial("~/Views/Plafond/_AzioniPlafond.cshtml", p)
                </div>
            }
        </div>
    }
</div>



<!-- 🔄 Paginazione -->
<div id="paginazionePlafondTable" class="d-flex justify-content-end align-items-center gap-2 mt-2"></div>

<!-- 📊 Totale -->
@{
    decimal totalePlafond = ViewBag.TotalePlafond ?? 0m;
    var colore = totalePlafond >= 0 ? "text-success" : "text-danger";
}
<div class="d-flex justify-content-end mt-3">
    <div class="fw-bold text-end @colore">
        Totale Plafond: @totalePlafond.ToString("N2") €
    </div>
</div>


@* nel caso vuoi fare filtro professionista per totale plafond ci lavoreremo dopo  *@

<!-- 🔽 Modale Creazione/Modifica Finanziamento -->
<div class="modal fade" id="finanziamentoModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="finanziamentoForm">
            <div class="modal-content">
                <div class="modal-header text-black">
                    <h5 class="modal-title" id="finanziamentoModalLabel">Nuovo Finanziamento</h5>
                    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="ID_Finanziamento" />

                    <!-- 👤 PROFESSIONISTA -->
                    <div class="mb-3">
                        <label>Professionista</label>

                        @if (tipoUtente == "Admin")
                        {
                            <select class="form-select form-select-sm"
                                    name="ID_Professionista"
                                    id="ID_Professionista_Fin"
                                    required>
                                <option value="">-- Seleziona --</option>
                                @foreach (var prof in professionisti)
                                {
                                    <option value="@prof.Value">@prof.Text</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="hidden"
                                   name="ID_Professionista"
                                   id="ID_Professionista_Fin"
                                   value="@idUtenteCorrente" />

                            <input type="text"
                                   class="form-control form-control-sm"
                                   value="@nomeUtenteCorrente"
                                   readonly />
                        }
                    </div>

                    <!-- 💰 IMPORTO -->
                    <div class="mb-3">
                        <label>Importo</label>
                        <input type="number"
                               name="Importo"
                               step="0.01"
                               class="form-control form-control-sm"
                               required />
                    </div>

                    <!-- 📅 DATA -->
                    <div class="mb-3">
                        <label>Data Versamento</label>
                        <input type="date"
                               name="DataVersamento"
                               class="form-control form-control-sm"
                               required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success btn-sm">Salva</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </form>
    </div>
</div>


@* Modale costo personale *@
<div class="modal fade" id="modalCostoPersonale" tabindex="-1"
     aria-labelledby="modalCostoPersonaleLabel" aria-hidden="true">

    <div class="modal-dialog">
        <div class="modal-content">

            <form id="formCostoPersonale">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCostoPersonaleLabel">
                        Nuovo Costo Personale
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <!-- 👤 PROFESSIONISTA -->
                    <div class="mb-2">
                        <label>Professionista</label>

                        @if (tipoUtente == "Admin")
                        {
                            <select class="form-select form-select-sm"
                                    name="ID_Utente"
                                    id="idUtenteCosto"
                                    required>
                                <option value="">-- Seleziona --</option>
                                @foreach (var prof in professionisti)
                                {
                                    <option value="@prof.Value">@prof.Text</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="hidden"
                                   name="ID_Utente"
                                   id="idUtenteCosto"
                                   value="@idUtenteCorrente" />

                            <input type="text"
                                   class="form-control form-control-sm"
                                   value="@nomeUtenteCorrente"
                                   readonly />
                        }
                    </div>

                    <!-- 💰 PLAFOND -->
                    <div class="mb-2">
                        <label>Plafond disponibile (€)</label>
                        <input type="text"
                               id="plafondDisponibileInput"
                               class="form-control"
                               readonly />
                    </div>

                    <!-- 📝 DESCRIZIONE -->
                    <div class="mb-2">
                        <label>Descrizione</label>
                        <input type="text"
                               name="Descrizione"
                               class="form-control"
                               maxlength="200"
                               required />
                    </div>

                    <!-- 💶 IMPORTO -->
                    <div class="mb-2">
                        <label>Importo (€)</label>
                        <input type="text"
                               name="Importo"
                               inputmode="decimal"
                               class="form-control"
                               placeholder="Es. 12,74"
                               required />
                    </div>

                    <!-- 📅 DATA -->
                    <div class="mb-2">
                        <label>Data del Costo</label>
                        <input type="date"
                               name="DataInserimento"
                               class="form-control"
                               required />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        Salva
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- 🗑️ Modale Conferma Eliminazione Finanziamento -->
<div class="modal fade" id="eliminaFinanziamentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler eliminare questo finanziamento dal plafond?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneFinanziamento">Elimina</button>
            </div>
        </div>
    </div>
</div>

<!-- 🗑️ Modale Conferma Eliminazione Versamento Plafond -->
<div class="modal fade" id="eliminaVersamentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler eliminare questo incasso dal plafond del professionista?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneVersamento">Elimina</button>
            </div>
        </div>
    </div>
</div>

<!-- 🗑️ Modale Conferma Eliminazione Costo Personale -->
<div class="modal fade" id="eliminaCostoPersonaleModal" tabindex="-1" aria-labelledby="eliminaCostoPersonaleLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminaCostoPersonaleLabel">Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler eliminare questo <strong>costo personale</strong> dal plafond del professionista?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneCostoPersonale">Elimina</button>
            </div>
        </div>
    </div>
</div>

<!-- 🗑️ Modale Prelievo   -->
<div class="modal fade" id="modalPrelievoProfessionista" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="formPrelievoProfessionista">

                <div class="modal-header">
                    <h5 class="modal-title">Nuovo Prelievo Professionista</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <!-- 👤 PROFESSIONISTA -->
                    <div class="mb-2">
                        <label>Professionista</label>

                        @if (tipoUtente == "Admin")
                        {
                            <select class="form-select form-select-sm"
                                    name="idProfessionista"
                                    id="idUtentePrelievo"
                                    required>
                                <option value="">-- Seleziona --</option>
                                @foreach (var prof in professionisti)
                                {
                                    <option value="@prof.Value">@prof.Text</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="hidden"
                                   name="idProfessionista"
                                   id="idUtentePrelievo"
                                   value="@idUtenteCorrente" />

                            <input type="text"
                                   class="form-control form-control-sm"
                                   value="@nomeUtenteCorrente"
                                   readonly />
                        }
                    </div>

                    <!-- 💰 PLAFOND -->
                    <div class="mb-2">
                        <label>Plafond disponibile (€)</label>
                        <input type="text"
                               id="plafondDisponibilePrelievoInput"
                               class="form-control"
                               readonly />
                    </div>

                    <!-- 💶 IMPORTO -->
                    <div class="mb-2">
                        <label>Importo (€)</label>
                        <input type="text"
                               name="importo"
                               inputmode="decimal"
                               class="form-control"
                               placeholder="Es. 150,00"
                               required />
                    </div>

                    <!-- 📝 NOTE -->
                    <div class="mb-2">
                        <label>Note</label>
                        <input type="text"
                               name="note"
                               class="form-control"
                               maxlength="200" />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        Salva
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>




<!-- 🗑️ Modale Conferma Eliminazione Prelievo Professionista -->
<div class="modal fade" id="eliminaPrelievoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Conferma Eliminazione Prelievo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Sei sicuro di voler eliminare questo <strong>prelievo al professionista</strong>?
                <br />
                <span class="text-muted small">
                    L'importo verrà riaccreditato nel plafond disponibile.
                </span>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary btn-sm"
                        data-bs-dismiss="modal">
                    Annulla
                </button>

                <button type="button"
                        class="btn btn-danger btn-sm"
                        id="btnConfermaEliminazionePrelievo">
                    Elimina Prelievo
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let idFinanziamentoDaEliminare = 0;

    function apriNuovoFinanziamento() {
        const form = document.getElementById("finanziamentoForm");
        form.reset();
        form.querySelector('[name="ID_Finanziamento"]').value = 0;
        document.getElementById("finanziamentoModalLabel").textContent = "Nuovo Finanziamento";
        new bootstrap.Modal(document.getElementById("finanziamentoModal")).show();
    }

    function apriModificaFinanziamento(id) {
        fetch(`/Pratiche/GetFinanziamento?id=${id}`)
            .then(res => res.json())
            .then(res => {
                if (!res.success) return toastr.error("Errore nel caricamento.");

                const f = res.finanziamento;
                const form = document.getElementById("finanziamentoForm");
                form.reset();

                form.querySelector('[name="ID_Finanziamento"]').value = f.ID_Finanziamento;
                form.querySelector('[name="ID_Professionista"]').value = f.ID_Professionista;
                form.querySelector('[name="Importo"]').value = f.Importo;
                form.querySelector('[name="DataVersamento"]').value = f.DataVersamento;

                document.getElementById("finanziamentoModalLabel").textContent = "Modifica Finanziamento";
                new bootstrap.Modal(document.getElementById("finanziamentoModal")).show();
            });
    }

    document.getElementById("finanziamentoForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const id = formData.get("ID_Finanziamento");
        const url = id && parseInt(id) > 0
            ? '/Pratiche/ModificaFinanziamento'
            : '/Pratiche/CreaFinanziamento';

        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    bootstrap.Modal.getInstance(document.getElementById("finanziamentoModal")).hide();
                    location.reload();
                } else {
                    toastr.error(res.message);
                }
            });
    });

    //function confermaEliminazioneFinanziamento(id) {
    //    idFinanziamentoDaEliminare = id;
    //    new bootstrap.Modal(document.getElementById("eliminaFinanziamentoModal")).show();
    //}

    //document.getElementById("btnConfermaEliminazioneFinanziamento").addEventListener("click", function () {
    //    fetch('/Pratiche/EliminaFinanziamento', {
    //        method: 'POST',
    //        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    //        body: `id=${idFinanziamentoDaEliminare}`
    //    })
    //        .then(r => r.json())
    //        .then(res => {
    //            if (res.success) {
    //                toastr.success(res.message);
    //                location.reload();
    //            } else {
    //                toastr.error(res.message);
    //            }
    //        });
    //});

    //salvataggio costo personale professionista


    function apriModaleCostoPersonale(idProfessionista) {

        const select = document.getElementById('idUtenteCosto');
        const idUtente = idProfessionista || (select ? select.value : '');

        if (idUtente) {
            caricaPlafondDisponibile(idUtente);
        } else {
            document.getElementById("plafondDisponibileInput").value = '';
        }

        new bootstrap.Modal(
            document.getElementById("modalCostoPersonale")
        ).show();
    }


    document.getElementById("formCostoPersonale")
        .addEventListener("submit", function (e) {

            e.preventDefault();

            const form = this;
            const formData = new FormData(form);

            // ============================
            // 🔥 LETTURA IMPORTO RAW (STRINGA PURA)
            // ============================
            const rawImporto = formData.get("Importo");

            console.log("RAW IMPORTO:", rawImporto);

            if (!rawImporto || !rawImporto.trim()) {
                toastr.warning("Inserisci un importo valido.");
                return;
            }

            // ============================
            // 🔥 NORMALIZZAZIONE SMART
            // ============================
            let importoNormalizzato = rawImporto.trim();

            // Caso formato italiano
            if (importoNormalizzato.includes(',')) {
                importoNormalizzato = importoNormalizzato
                    .replace(/\./g, '')   // separatori migliaia
                    .replace(',', '.');   // decimale
            }

            console.log("IMPORTO NORMALIZZATO:", importoNormalizzato);

            const importoInserito = parseFloat(importoNormalizzato);
            const idUtente = formData.get("ID_Utente");

            if (!idUtente) {
                toastr.warning("Seleziona un professionista.");
                return;
            }

            if (isNaN(importoInserito) || importoInserito <= 0) {
                toastr.warning("Inserisci un importo valido.");
                return;
            }

            // Sovrascrivo valore pulito
            formData.set("Importo", importoNormalizzato);

            // ============================
            // 🔎 RECUPERO PLAFOND
            // ============================
            fetch('/Pratiche/GetPlafondDisponibile?idUtente=' + encodeURIComponent(idUtente))
                .then(res => res.json())
                .then(data => {

                    if (!data.success) {
                        toastr.error("Errore nel recupero del plafond disponibile.");
                        return;
                    }

                    let rawPlafond = (data.plafond || "")
                        .replace("€", "")
                        .trim()
                        .replace(/\./g, "")
                        .replace(",", ".");

                    const plafondDisponibile = parseFloat(rawPlafond);

                    if (isNaN(plafondDisponibile)) {
                        toastr.error("Errore nel parsing del plafond disponibile.");
                        return;
                    }

                    if (importoInserito > plafondDisponibile) {
                        toastr.warning("Il costo supera il plafond disponibile.");
                        return;
                    }

                    // ============================
                    // ✅ INVIO AL SERVER
                    // ============================
                    fetch('/Pratiche/InserisciCostoPersonale', {
                        method: 'POST',
                        body: formData
                    })
                        .then(r => r.json())
                        .then(res => {

                            if (res.success) {
                                toastr.success(res.message);

                                bootstrap.Modal
                                    .getInstance(
                                        document.getElementById("modalCostoPersonale")
                                    )
                                    .hide();

                                form.reset();
                                location.reload();

                            } else {
                                toastr.error(res.message || "Errore durante il salvataggio.");
                            }
                        });

                })
                .catch(() => toastr.error("Errore nel recupero del plafond."));
        });


    function caricaPlafondDisponibile(idUtente) {
        fetch('/Pratiche/GetPlafondDisponibile?idUtente=' + encodeURIComponent(idUtente))
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    $('#plafondDisponibileInput').val(data.plafond);
                    $('#plafondDisponibilePrelievoInput').val(data.plafond); // se esiste
                } else {
                    $('#plafondDisponibileInput').val('Errore');
                    $('#plafondDisponibilePrelievoInput').val('Errore');
                }
            })
            .catch(() => {
                $('#plafondDisponibileInput').val('Errore');
                $('#plafondDisponibilePrelievoInput').val('Errore');
            });
    }


    function apriModalePrelievoProfessionista(idProfessionista) {

        const select = document.getElementById('idUtentePrelievo');
        const idUtente = idProfessionista || (select ? select.value : '');

        if (idUtente) {
            fetch('/Pratiche/GetPlafondDisponibile?idUtente=' + encodeURIComponent(idUtente))
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("plafondDisponibilePrelievoInput").value = data.plafond;
                    } else {
                        document.getElementById("plafondDisponibilePrelievoInput").value = "Errore";
                    }
                })
                .catch(() => {
                    document.getElementById("plafondDisponibilePrelievoInput").value = "Errore";
                });
        } else {
            document.getElementById("plafondDisponibilePrelievoInput").value = '';
        }

        new bootstrap.Modal(
            document.getElementById("modalPrelievoProfessionista")
        ).show();
    }



    document.getElementById("formPrelievoProfessionista")
        .addEventListener("submit", function (e) {

            e.preventDefault();

            const form = this;
            const formData = new FormData(form);

            // ============================
            // 🔥 LETTURA CAMPI
            // ============================
            const rawImporto = formData.get("importo");
            const note = formData.get("note") || "";
            const idProfessionista = formData.get("idProfessionista");

            if (!idProfessionista) {
                toastr.warning("Seleziona un professionista.");
                return;
            }

            if (!rawImporto || !rawImporto.trim()) {
                toastr.warning("Inserisci un importo valido.");
                return;
            }

            // ============================
            // 🔥 NORMALIZZAZIONE IMPORTO
            // ============================
            let importoNormalizzato = rawImporto.trim();

            if (importoNormalizzato.includes(',')) {
                importoNormalizzato = importoNormalizzato
                    .replace(/\./g, '')   // separatori migliaia
                    .replace(',', '.');   // decimale
            }

            const importoInserito = parseFloat(importoNormalizzato);

            if (isNaN(importoInserito) || importoInserito <= 0) {
                toastr.warning("Inserisci un importo valido.");
                return;
            }

            // ============================
            // 🔎 RECUPERO PLAFOND CORRETTO
            // ============================
            fetch('/Pratiche/GetPlafondDisponibile?idUtente=' + encodeURIComponent(idProfessionista))
                .then(res => res.json())
                .then(data => {

                    if (!data.success) {
                        toastr.error("Errore nel recupero del plafond disponibile.");
                        return;
                    }

                    let rawPlafond = (data.plafond || "")
                        .replace("€", "")
                        .trim()
                        .replace(/\./g, "")
                        .replace(",", ".");

                    const plafondDisponibile = parseFloat(rawPlafond);

                    if (isNaN(plafondDisponibile)) {
                        toastr.error("Errore nel parsing del plafond disponibile.");
                        return;
                    }

                    if (importoInserito > plafondDisponibile) {
                        toastr.warning("Il prelievo supera il plafond disponibile.");
                        return;
                    }

                    // ============================
                    // ✅ INVIO AL SERVER
                    // ============================
                    const payload =
                        `ID_Utente=${encodeURIComponent(idProfessionista)}` +
                        `&importo=${encodeURIComponent(importoNormalizzato)}` +
                        `&note=${encodeURIComponent(note)}`;


                    fetch('/Pratiche/InserisciPrelievoProfessionista', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: payload
                    })
                        .then(r => r.json())
                        .then(res => {

                            if (res.success) {
                                toastr.success(res.message);

                                bootstrap.Modal
                                    .getInstance(
                                        document.getElementById("modalPrelievoProfessionista")
                                    )
                                    .hide();

                                form.reset();
                                location.reload();

                            } else {
                                toastr.error(res.message || "Errore durante il prelievo.");
                            }
                        });

                })
                .catch(() => toastr.error("Errore nel recupero del plafond."));
        });


    let idElementoDaEliminare = null;
    let tipoEliminazione = null; // "versamento" o "costo"

    function mostraModaleEliminazione(tipo, id) {
        idElementoDaEliminare = id;
        tipoEliminazione = tipo;

        let modalId = '';

        if (tipo === 'versamento') {
            modalId = 'eliminaVersamentoModal';
        }
        else if (tipo === 'costo') {
            modalId = 'eliminaCostoPersonaleModal';
        }
        else if (tipo === 'finanziamento') {
            modalId = 'eliminaFinanziamentoModal';
        }
        else if (tipo === 'prelievo') {
            modalId = 'eliminaPrelievoModal';
        }

        if (modalId) {
            const modal = new bootstrap.Modal(
                document.getElementById(modalId)
            );
            modal.show();
        }
    }


    // Event listener per i bottoni di conferma eliminazione (unico listener)
    document.querySelectorAll(
        '#btnConfermaEliminazioneVersamento, ' +
        '#btnConfermaEliminazioneCostoPersonale, ' +
        '#btnConfermaEliminazioneFinanziamento, ' +
        '#btnConfermaEliminazionePrelievo'
    )
        .forEach(btn => {
            btn.addEventListener('click', function () {

                if (!idElementoDaEliminare || !tipoEliminazione) {
                    console.warn("❌ Nessun elemento da eliminare");
                    return;
                }

                let url = '';
                switch (tipoEliminazione) {
                    case 'versamento':
                        url = '/Pratiche/EliminaVersamentoPlafond';
                        break;
                    case 'costo':
                        url = '/Pratiche/EliminaCostoPersonale';
                        break;
                    case 'finanziamento':
                        url = '/Pratiche/EliminaFinanziamento';
                        break;
                    case 'prelievo':
                        url = '/Pratiche/EliminaPrelievoProfessionista';
                        break;
                }

                if (!url) {
                    console.error("❌ Tipo eliminazione sconosciuto:", tipoEliminazione);
                    return;
                }

                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${encodeURIComponent(idElementoDaEliminare)}`
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            toastr.success(res.message);
                            location.reload();
                        } else {
                            toastr.error(res.message || "Errore durante l'eliminazione.");
                        }
                    })
                    .catch(err => {
                        console.error("❌ Errore fetch eliminazione:", err);
                        toastr.error("Errore di comunicazione col server.");
                    });
            });
        });


    // Usa questa funzione nel listener globale per gestire il click sui bottoni .btn-elimina
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-elimina');
        if (!btn) return;

        const tipo = btn.getAttribute('data-tipo');
        const id = btn.getAttribute('data-id');

        if (!tipo || !id) return;

        mostraModaleEliminazione(tipo, id);
    });


    // 🔍 Filtro e paginazione Plafond
    document.addEventListener("DOMContentLoaded", function () {

        // =====================================================
        // 🔥 AGGANCIO SELECT ADMIN (COSTO / PRELIEVO)
        // =====================================================

        const selectCosto = document.getElementById("idUtenteCosto");
        if (selectCosto) {
            selectCosto.addEventListener("change", function () {
                const idUtente = this.value;
                if (!idUtente) {
                    document.getElementById("plafondDisponibileInput").value = "";
                    return;
                }
                caricaPlafondDisponibile(idUtente);
            });
        }

        const selectPrelievo = document.getElementById("idUtentePrelievo");
        if (selectPrelievo) {
            selectPrelievo.addEventListener("change", function () {
                const idUtente = this.value;
                if (!idUtente) {
                    document.getElementById("plafondDisponibilePrelievoInput").value = "";
                    return;
                }

                fetch('/Pratiche/GetPlafondDisponibile?idUtente=' + encodeURIComponent(idUtente))
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById("plafondDisponibilePrelievoInput").value = data.plafond;
                        } else {
                            document.getElementById("plafondDisponibilePrelievoInput").value = "Errore";
                        }
                    })
                    .catch(() => {
                        document.getElementById("plafondDisponibilePrelievoInput").value = "Errore";
                    });
            });
        }

        // =====================================================
        // 🔍 FILTRO + PAGINAZIONE PLAFOND
        // =====================================================

        const table = document.getElementById('plafondTable');
        if (!table) return;

        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const cards = document.querySelectorAll('.card-plafond');

        const controlliContainer = document.getElementById('controlliPlafondTable');
        const paginationContainer = document.getElementById('paginazionePlafondTable');

        const searchInput = document.createElement('input');
        const selectPageSize = document.createElement('select');
        const selectTipo = document.createElement('select');

        let pageSize = 10;
        let currentPage = 1;

        // 🔍 Ricerca
        searchInput.type = 'text';
        searchInput.placeholder = 'Cerca...';
        searchInput.className = 'form-control form-control-sm w-auto';

        // 📄 Page Size
        [10, 25, 50].forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = `${num} per pagina`;
            selectPageSize.appendChild(option);
        });
        selectPageSize.className = 'form-select form-select-sm w-auto';

        // ⚙️ Tipo Plafond
        ['Tutti', 'Finanziamento', 'Costo Personale', 'Pagamento Costi'].forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo;
            option.textContent = tipo;
            selectTipo.appendChild(option);
        });
        selectTipo.className = 'form-select form-select-sm w-auto';

        // ✅ Checkbox "Mostra pagamenti"
        const mostraPagamentiCheckbox = document.createElement('input');
        mostraPagamentiCheckbox.type = 'checkbox';
        mostraPagamentiCheckbox.className = 'form-check-input me-1';
        mostraPagamentiCheckbox.id = 'mostraPagamentiCheck';

        const checkboxLabel = document.createElement('label');
        checkboxLabel.className = 'form-check-label';
        checkboxLabel.style.cursor = 'pointer';
        checkboxLabel.htmlFor = 'mostraPagamentiCheck';
        checkboxLabel.appendChild(mostraPagamentiCheckbox);
        checkboxLabel.appendChild(document.createTextNode(' Mostra pagamenti'));

        const currentFilterValue = controlliContainer.getAttribute('data-mostra-pagamenti');
        mostraPagamentiCheckbox.checked = currentFilterValue === 'True' || currentFilterValue === 'true';
        mostraPagamentiCheckbox.addEventListener('change', function () {
            const params = new URLSearchParams(window.location.search);
            if (this.checked) {
                params.set('mostraPagamenti', 'true');
            } else {
                params.delete('mostraPagamenti');
            }
            window.location.search = params.toString();
        });

        // 📌 Aggiungi controlli
        controlliContainer.appendChild(searchInput);
        controlliContainer.appendChild(selectTipo);
        controlliContainer.appendChild(selectPageSize);
        controlliContainer.appendChild(checkboxLabel);

        function renderTable() {
            const keyword = searchInput.value.toLowerCase();
            const filtroTipo = selectTipo.value;

            let filteredRows = rows.filter(row => {
                const text = row.innerText.toLowerCase();
                const tipoCell = row.querySelector('td:nth-child(2)');
                const tipo = tipoCell ? tipoCell.innerText.trim() : '';
                const tipoMatch = (filtroTipo === 'Tutti' || tipo === filtroTipo);
                return text.includes(keyword) && tipoMatch;
            });

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            currentPage = Math.min(currentPage, totalPages || 1);

            rows.forEach(r => r.style.display = 'none');
            filteredRows.slice((currentPage - 1) * pageSize, currentPage * pageSize)
                .forEach(r => r.style.display = '');

            cards.forEach(c => c.style.display = 'none');
            filteredRows.forEach(row => {
                const id = row.getAttribute('data-id');
                const card = document.querySelector(`.card-plafond[data-id="${id}"]`);
                if (card) card.style.display = '';
            });

            paginationContainer.innerHTML = '';
            paginationContainer.className = 'd-flex justify-content-end align-items-center gap-2';

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Pagina ${currentPage} di ${totalPages || 1}`;
            pageInfo.className = 'me-2';
            paginationContainer.appendChild(pageInfo);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '← Indietro';
            prevBtn.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); };
            paginationContainer.appendChild(prevBtn);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Prossima →';
            nextBtn.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); };
            paginationContainer.appendChild(nextBtn);
        }

        searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
        selectTipo.addEventListener('change', () => { currentPage = 1; renderTable(); });
        selectPageSize.addEventListener('change', () => {
            pageSize = parseInt(selectPageSize.value);
            currentPage = 1;
            renderTable();
        });

        renderTable();
    });


</script>