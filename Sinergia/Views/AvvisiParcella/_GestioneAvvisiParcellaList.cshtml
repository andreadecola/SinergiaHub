@model List<Sinergia.Models.AvvisoParcellaViewModel>
@{
    var permessiUtente = ViewBag.Permessi as Sinergia.Models.PermessiViewModel;
    bool puoAggiungere = ViewBag.PuoAggiungere == true;
    bool mostraAzioni = puoAggiungere || Model.Any(c => c.PuoModificare || c.PuoEliminare);
}

@section styles {
    <style>
        /* =====================================
           🎨 STILI BASE TABELLA AVVISI PARCELLA
        ====================================== */
        #avvisiTable th, #avvisiTable td {
            white-space: nowrap;
            vertical-align: middle;
        }

        #controlliAvvisi select,
        #controlliAvvisi input {
            min-width: 90px;
        }

        .tooltip-inner {
            text-align: left;
            font-size: 0.85rem;
            max-width: 250px;
            background-color: #333;
            color: #fff;
            border-radius: 6px;
        }

        /* =====================================
           🧩 RESPONSIVE FIX PER SCHERMI PICCOLI
           (laptop 13–14 pollici, <1440px)
        ====================================== */
        @@media (max-width: 1440px) {
            #avvisiTable th,
            #avvisiTable td {
                white-space: normal !important;   /* consente di andare a capo */
                word-wrap: break-word !important;
                font-size: 0.72rem !important;     /* 👈 più piccolo */
                line-height: 1.15;
                padding: 4px 3px !important;       /* 👈 celle più compatte */
            }

            /* Titolo Avviso su due righe */
            #avvisiTable th:nth-child(1),
            #avvisiTable td:nth-child(1) {
                max-width: 120px !important;
            }

            /* Pratica e Responsabile */
            #avvisiTable th:nth-child(2),
            #avvisiTable td:nth-child(2),
            #avvisiTable th:nth-child(3),
            #avvisiTable td:nth-child(3) {
                max-width: 90px !important;
            }

            /* Tipologia e Fase */
            #avvisiTable th:nth-child(4),
            #avvisiTable td:nth-child(4),
            #avvisiTable th:nth-child(5),
            #avvisiTable td:nth-child(5) {
                max-width: 85px !important;
            }

            /* Metodo pagamento */
            #avvisiTable th:nth-child(14),
            #avvisiTable td:nth-child(14) {
                max-width: 80px !important;
            }

            /* Badge compatti */
            #avvisiTable .badge {
                font-size: 0.65rem !important;
                padding: 3px 5px !important;
            }

            /* Pulsanti azione ridotti */
            #avvisiTable .btn {
                padding: 2px 5px !important;
                font-size: 0.75rem !important;
            }

            /* Evita scroll orizzontale */
            .table-responsive {
                overflow-x: hidden !important;
            }

            /* Tabelle più strette globalmente */
            #avvisiTable {
                table-layout: fixed !important;
            }
        }




        /* =====================================
           💻 DESKTOP GRANDI (ripristino normale)
        ====================================== */
        @@media (min-width: 1441px) {
            #avvisiTable th,
            #avvisiTable td {
                white-space: nowrap !important;
                font-size: 0.9rem !important;
                padding: 8px 6px !important;
            }
        }
    </style>
}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="~/Content/css/style-mobile.css" rel="stylesheet" />

<!-- 🔍 Controlli filtro/paginazione -->
<div id="controlliAvvisi" class="d-flex flex-wrap align-items-center gap-1 mb-2"></div>

<!-- 📥 Export Avvisi Parcella CSV/PDF -->
<div class="d-flex justify-content-end mb-3">
    <form method="get" id="exportAvvisiForm"
          class="d-flex flex-wrap flex-md-nowrap gap-2 align-items-center">

        <input type="date" name="da" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.AddMonths(-1).ToString("yyyy-MM-dd")" />

        <input type="date" name="a" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.ToString("yyyy-MM-dd")" />

        <button type="submit" formaction="@Url.Action("EsportaAvvisiParcellaCsv", "Pratiche")"
                class="btn btn-outline-success btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-excel"></i> Excel/CSV
        </button>

        @*<button type="submit" formaction="@Url.Action("EsportaAvvisiParcellaPdf", "Pratiche")"
                class="btn btn-outline-danger btn-sm"
                style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>*@
    </form>
</div>


<!-- ➕ Pulsante nuovo -->
<div class="d-flex justify-content-end mb-2">
    @if (puoAggiungere)
    {
        <button class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;" onclick="apriNuovoAvviso()">Nuovo Avviso Parcella</button>
    }
</div>

<!-- 🖥️ TABELLA DESKTOP -->
<div class="d-none d-md-block">
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle" id="avvisiTable">
            <thead class="table-light">
                <tr>
                    <th>Titolo Avviso</th>
                    <th>Pratica</th>
                    <th>Responsabile</th>
                    <th>Tipologia</th>
                    <th>Fase</th>
                    <th>Data</th>
                    <th>Stato</th>
                    <th>Importo Base (€)</th>
                    <th>Acconto (€)</th> <!-- ✅ nuovo campo -->
                    <th>Cassa Prev. (%)</th>
                    <th>IVA (%)</th>
                    <th>Spese Generali (€)</th>
                    <th class="fw-bold text-success">Totale (€)</th>
                    <th>Metodo Pagamento</th>

                    @if (mostraAzioni)
                    {
                        <th class="text-center">Azioni</th>
                    }
                </tr>
            </thead>

            <tbody>
                @foreach (var a in Model)
                {
                    <tr data-id="@a.ID_AvvisoParcelle">
                        <td>@a.TitoloAvviso</td>
                        <td>@a.NomePratica</td>
                        <td>@a.NomeResponsabilePratica</td>
                        <td>@a.TipologiaAvviso</td>
                        <td>
                            @(a.TipologiaAvviso == "Giudiziale"
                                ? a.FaseGiudiziale
                                : "-")
                        </td>
                        <td>@(a.DataAvviso?.ToString("dd/MM/yyyy") ?? "")</td>
                        <td class="stato">
                            <span class="badge bg-@(a.Stato == "Pagato" ? "success" : a.Stato == "Inviato" ? "info" : "secondary")">
                                @a.Stato
                            </span>
                        </td>
                        <td class="text-end">
                            @(a.Importo.HasValue ? a.Importo.Value.ToString("N2") : "-")
                        </td>
                        <td class="text-end text-primary">
                            @(a.ImportoAcconto.HasValue && a.ImportoAcconto > 0
                                ? a.ImportoAcconto.Value.ToString("N2")
                                : "-")
                        </td>
                        <td class="text-end">
                            @(a.ContributoIntegrativoPercentuale?.ToString("0.##") ?? "")%
                        </td>
                        <td class="text-end">
                            @(a.AliquotaIVA?.ToString("0.##") ?? "")%
                        </td>
                        <td class="text-end">
                            @(a.ImportoRimborsoSpese?.ToString("N2") ?? "-")
                        </td>
                        <td class="fw-bold text-end text-success"
                            data-bs-toggle="tooltip"
                            data-bs-html="true"
                            title="
                                    <div style='text-align:left;'>
                                        <b>Totale incassato:</b> @(a.TotaleIncassato?.ToString("N2") ?? "0,00") €<br>
                                        <b>Residuo:</b> @(a.ImportoResiduoEffettivo?.ToString("N2") ?? "0,00") €<br>
                                        <b>Competenza:</b> @(a.TrimestreCompetenza ?? "-")
                                    </div>">
                                @(a.TotaleAvvisoParcella.HasValue
                                    ? a.TotaleAvvisoParcella.Value.ToString("N2")
                                    : "-")
                            </td>
                        <td>@a.MetodoPagamento</td>

                        @if (mostraAzioni)
                        {
                            <td class="text-center">
                                @Html.Partial("~/Views/AvvisiParcella/_AzioniAvvisoParcella.cshtml", a)
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 📱 CARD VIEW MOBILE -->
<div class="d-block d-md-none mt-3 px-2">
    @foreach (var a in Model)
    {
        <div class="border rounded shadow-sm p-3 mb-3 bg-white card-avviso" data-id="@a.ID_AvvisoParcelle">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-primary">@a.TitoloAvviso</span>
                <span class="fw-bold text-primary">@a.NomePratica</span>
                <span class="badge bg-@(a.Stato == "Pagato" ? "success" : "secondary")">@a.Stato</span>
            </div>

            <!-- 🔹 Tipologia e fase -->
            <div class="small text-muted">
                <strong>Tipologia:</strong> @(a.TipologiaAvviso ?? "-")
            </div>
            @if (a.TipologiaAvviso == "Giudiziale")
            {
                <div class="small text-muted">
                    <strong>Fase:</strong> @(a.FaseGiudiziale ?? "-")
                </div>
            }

            <!-- 🔹 Dettagli economici -->
            <div class="small text-muted"><strong>Data:</strong> @(a.DataAvviso?.ToString("dd/MM/yyyy") ?? "-")</div>
            <div class="small text-muted"><strong>Importo Base:</strong> @(a.Importo?.ToString("C") ?? "-")</div>

            @if (a.ImportoAcconto.HasValue && a.ImportoAcconto > 0)
            {
                <div class="small text-muted"><strong>Acconto:</strong> @(a.ImportoAcconto.Value.ToString("C"))</div>
            }

            <div class="small text-muted"><strong>Cassa Prev.:</strong> @(a.ContributoIntegrativoPercentuale?.ToString("0.##") ?? "-")%</div>
            <div class="small text-muted"><strong>Contributo:</strong> @(a.ContributoIntegrativoImporto?.ToString("C") ?? "-")</div>
            <div class="small text-muted"><strong>IVA:</strong> @(a.AliquotaIVA?.ToString("0.##") ?? "-")%</div>
            <div class="small text-muted"><strong>Spese Generali:</strong> @(a.ImportoRimborsoSpese?.ToString("C") ?? "-")</div>

            <!-- 🔹 Totale finale -->
            <div class="small text-muted mt-1">
                Incassato: @(a.TotaleIncassato?.ToString("C") ?? "-") —
                Residuo: @(a.ImportoResiduoEffettivo?.ToString("C") ?? "-")<br />
                Comp.: @(a.TrimestreCompetenza ?? "-")
            </div>

            <div class="small text-muted"><strong>Metodo Pagamento:</strong> @a.MetodoPagamento</div>

            <!-- 🔹 Azioni -->
            @if (mostraAzioni)
            {
                <div class="d-flex flex-wrap gap-2 mt-2">
                    @Html.Partial("~/Views/AvvisiParcella/_AzioniAvvisoParcella.cshtml", a)
                </div>
            }
        </div>
    }
</div>

<!-- 🔄 Paginazione -->
<div id="paginazioneAvvisi" class="d-flex justify-content-end align-items-center gap-2 mt-2"></div>

<!-- ===================================================== -->
<!-- 🧾 Modale Inserimento/Modifica Avviso Parcella -->
<!-- ===================================================== -->
<div class="modal fade" id="avvisoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="avvisoForm">
            <div class="modal-content">
                <div class="modal-header text-black">
                    <h5 class="modal-title" id="avvisoModalLabel">Nuovo Avviso Parcella</h5>
                    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- Hidden -->
                    <input type="hidden" name="ID_AvvisoParcelle" />
                    <input type="hidden" name="TariffaOraria" />
                    <input type="hidden" name="OreEffettive" />
                    <input type="hidden" name="DescrizioneCompenso" />
                    <input type="hidden" name="ID_ResponsabilePratica" />
                    <input type="hidden" name="ID_OwnerCliente" />
                    <input type="hidden" name="ID_RigaCompenso" id="ID_RigaCompenso" />

                    <div class="row g-2">

                        <!-- Titolo Avviso -->
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Titolo Avviso</label>
                            <input type="text" name="TitoloAvviso" class="form-control form-control-sm" maxlength="100" />
                        </div>

                        <!-- Pratica -->
                        <div class="col-md-6">
                            <label class="form-label">Pratica</label>
                            <select name="ID_Pratiche"
                                    class="form-select form-select-sm"
                                    required
                                    id="selectPraticaAvviso">
                                <option value="">-- Seleziona una pratica --</option>
                            </select>

                            <!-- 🔍 Ricerca pratica per Nome o ID -->
                            <label class="form-label mt-1 small text-muted">
                                Cerca pratica (nome o ID)
                            </label>
                            <input type="text"
                                   id="cercaPraticaInput"
                                   class="form-control form-control-sm"
                                   placeholder="Es. 12 oppure Rossi c/ Bianchi" />
                        </div>


                        <!-- Responsabile pratica -->
                        <div class="col-md-6">
                            <label class="form-label">Responsabile pratica</label>
                            <input type="text" id="nomeResponsabilePratica" class="form-control form-control-sm" readonly />
                        </div>

                        <!-- Owner cliente -->
                        <div class="col-md-6">
                            <label class="form-label">Owner cliente</label>
                            <input type="text" id="nomeOwnerCliente" class="form-control form-control-sm" readonly />
                        </div>

                        <!-- Data e stato -->
                        <div class="col-md-3">
                            <label class="form-label">Data Avviso</label>
                            <input name="DataAvviso" type="date" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stato</label>
                            <select name="Stato" class="form-select form-select-sm" required>
                                <option value="">-- Seleziona stato --</option>
                                <option value="In attesa">In attesa</option>
                                <option value="Inviato">Inviato</option>
                                <option value="Pagato">Pagato</option>
                            </select>
                        </div>

                        <!-- Tipologia Avviso -->
                        <div class="col-md-6">
                            <label class="form-label">Tipologia Avviso</label>
                            <select name="TipologiaAvviso" class="form-select form-select-sm" id="tipologiaAvviso" required>
                                <option value="">-- Seleziona tipologia --</option>
                                <option value="Fisso">Fisso</option>
                                <option value="A ore">A ore</option>
                                <option value="Giudiziale">Giudiziale</option>
                            </select>
                        </div>

                        <!-- Fase Giudiziale -->
                        <div class="col-md-6 d-none" id="faseGiudizialeContainer">
                            <label class="form-label">Fase Giudiziale</label>
                            <select name="FaseGiudiziale" id="faseGiudiziale" class="form-select form-select-sm">
                                <option value="">-- Seleziona fase --</option>
                            </select>
                        </div>

                        <!-- Voce Compenso -->
                        <div class="col-md-6 d-none" id="voceCompensoContainer">
                            <label class="form-label">Voce di Compenso</label>
                            <select name="VoceCompenso" id="voceCompensoSelect" class="form-select form-select-sm">
                                <option value="">-- Seleziona voce --</option>
                            </select>
                        </div>

                        <!-- Importo e Acconto -->
                        <div class="col-md-4">
                            <label class="form-label" id="labelImporto">Importo</label>
                            <input type="number" step="0.01" class="form-control form-control-sm"
                                   id="Importo" name="Importo"
                                   oninput="gestisciCampiImportoAcconto(); calcolaTotaleAvvisoParcella();" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label" id="labelImportoAcconto">Importo Acconto</label>
                            <input type="number" step="0.01" class="form-control form-control-sm"
                                   id="ImportoAcconto" name="ImportoAcconto"
                                   oninput="gestisciCampiImportoAcconto(); calcolaTotaleAvvisoParcella();" />
                        </div>

                        <!-- Rimborso Spese -->
                        <div class="col-md-4">
                            <label class="form-label">Spese Generali (%)</label>
                            <select name="RimborsoSpesePercentuale"
                                    class="form-select form-select-sm"
                                    id="rimborsoSpeseSelect"
                                    onchange="calcolaTotaleAvvisoParcella()">
                                <option value="">-- Seleziona --</option>
                                <option value="0">0%</option>
                                <option value="15">15%</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Importo Spese Generali</label>
                            <input name="ImportoRimborsoSpese" class="form-control form-control-sm" readonly />
                        </div>

                        <!-- Contributo Integrativo -->
                        <div class="col-md-4">
                            <label class="form-label">Contributo Integrativo (%)</label>
                            <input name="ContributoIntegrativoPercentuale"
                                   class="form-control form-control-sm"
                                   type="text"
                                   inputmode="decimal"
                                   placeholder="%"
                                   oninput="calcolaTotaleAvvisoParcella()" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Importo Contributo</label>
                            <input name="ContributoIntegrativoImporto" class="form-control form-control-sm" readonly />
                        </div>

                        <!-- IVA -->
                        <div class="col-md-4">
                            <label class="form-label">Aliquota IVA (%)</label>
                            <select name="AliquotaIVA" class="form-select form-select-sm" required onchange="calcolaTotaleAvvisoParcella()">
                                <option value="">-- Seleziona --</option>
                                <option value="0">Esente</option>
                                <option value="4">4%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="22">22%</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Importo IVA</label>
                            <input name="ImportoIVA" class="form-control form-control-sm" readonly />
                        </div>

                        <!-- Totale -->
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Totale Avviso Parcella</label>
                            <input name="TotaleAvvisoParcella" class="form-control form-control-sm fw-bold text-success" readonly />
                        </div>

                        <!-- Metodo pagamento e note -->
                        <div class="col-md-4">
                            <label class="form-label">Metodo di Pagamento</label>
                            <select class="form-select form-select-sm" name="MetodoPagamento" id="metodoPagamento" required>
                                <option value="">-- Seleziona --</option>
                                <option value="Contanti">Contanti</option>
                                <option value="Bonifico">Bonifico</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Note</label>
                            <textarea name="Note" rows="1" class="form-control form-control-sm"></textarea>
                        </div>
                    </div>

                    <!-- ========================================================= -->
                    <!-- 📎 SEZIONE UPLOAD AVVISO PARCELLA PDF -->
                    <!-- ========================================================= -->
                    <hr class="mt-4 mb-3" />
                    <h6 class="fw-bold text-primary">
                        <i class="fa fa-paperclip me-1"></i> Documento Avviso Parcella
                    </h6>

                    <!-- 🔹 Upload del PDF firmato -->
                    <div class="mb-2" id="sezioneUploadAvvisoFirmato">
                        <label class="form-label fw-bold">
                            <i class="fa fa-file-pdf text-danger me-1"></i> Carica Avviso Firmato (PDF)
                        </label>

                        <input type="file"
                               id="inputFileAvviso"
                               name="FileAvvisoFirmato"
                               class="form-control form-control-sm"
                               accept=".pdf"
                               onchange="gestisciUploadAvvisoFirmato(this)" />

                        <div class="mt-1 text-muted small" id="fileAvvisoSelezionato"></div>
                        <small class="text-muted">Obbligatorio per archiviare l’avviso dopo la firma.</small>
                    </div>

                    <!-- 🔹 File già caricato -->
                    <div class="border rounded p-2 bg-light d-none" id="fileAvvisoCaricatoContainer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fa fa-file-pdf text-danger me-1"></i>
                                <strong id="nomeFileAvviso" class="text-primary"></strong>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                        onclick="scaricaAvvisoFirmato()">
                                    <i class="fa fa-download"></i> Scarica
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="rimuoviFileAvvisoCaricato($('#avvisoForm [name=ID_AvvisoParcelle]').val())">
                                    <i class="fa fa-trash"></i> Rimuovi
                                </button>

                            </div>
                        </div>
                        <input type="hidden" name="PercorsoDocumentoEsistente" id="hiddenPercorsoAvviso" />
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-success btn-sm">Salva</button>
                </div>
            </div>
        </form>
    </div>
</div>



<!-- Modale Eliminazione -->
<div class="modal fade" id="eliminaAvvisoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Elimina Avviso Parcella</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Confermi l’eliminazione dell'avviso?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnConfermaEliminazioneAvviso">Elimina</button>
            </div>
        </div>
    </div>
</div>
<!-- ========================================================= -->
<!-- 🧾 MODALE ANTEPRIMA AVVISO PARCELLA (riutilizza layout Template) -->
<!-- ========================================================= -->
<div class="modal fade" id="modaleAnteprimaTemplate" tabindex="-1" aria-labelledby="modaleAnteprimaTemplateLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg">

            <!-- 🔸 HEADER -->
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold" id="modaleAnteprimaTemplateLabel">Anteprima Avviso Parcella</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>

            <!-- 🔸 CORPO -->
            <div class="modal-body bg-white">
                <div id="contenutoTemplateGenerato"
                     class="p-3"
                     style="border:1px solid #ccc; border-radius:6px; background-color:#fff; min-height:400px; overflow-y:auto;">
                    <!-- L’HTML generato dall’avviso verrà inserito qui dinamicamente -->
                </div>
            </div>

            <!-- 🔸 FOOTER -->
            <div class="modal-footer d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-success" onclick="salvaAvvisoComePDF(event)">💾 Salva come PDF</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>

        </div>
    </div>
</div>


<!-- Modale Dati Bancari commentata in data 15/10/2025 in quanto i pagamenti vanno diretti a sinergia  -->
<!--<div class="modal fade" id="datiBancariModal" tabindex="-1" aria-labelledby="datiBancariModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="DatiBancariForm">
                <div class="modal-header text-black">
                    <h5 class="modal-title" id="datiBancariModalLabel">Dati Bancari del Professionista</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
                </div>
                <div class="modal-body">-->
<!-- ⚠️ Avviso -->
<!--<div class="alert alert-warning p-2 mb-3" role="alert">
    I campi contrassegnati con <span class="text-danger">*</span> sono obbligatori.
</div>-->
<!-- Hidden per ID e Tipo -->
<!--<input type="hidden" name="ID_Cliente" />
                    <input type="hidden" name="TipoCliente" value="Professionista" />
                    <input type="hidden" id="hiddenProfessionistaAvviso" value="@ViewBag.IDProfessionista" />
                    <input type="hidden" id="hiddenIDProfessionistaAvviso" name="ID_Professionista" />

                    <div class="mb-2">
                        <label class="form-label">Istituto di Credito <span class="text-danger">*</span></label>
                        <input type="text" name="NomeBanca" class="form-control form-control-sm"
                               placeholder="Es. Intesa Sanpaolo, Unicredit, BNL" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">IBAN <span class="text-danger">*</span></label>
                        <input type="text" name="IBAN" class="form-control form-control-sm"
                               placeholder="Es. IT60X0542811101000000123456" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Intestatario <span class="text-danger">*</span></label>
                        <input type="text" name="Intestatario" class="form-control form-control-sm"
                               placeholder="Nome e Cognome dell'intestatario del conto" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">BIC/SWIFT</label>
                        <input type="text" name="BIC_SWIFT" class="form-control form-control-sm"
                               placeholder="Es. BCITITMM o codice della banca estera" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Note</label>
                        <textarea name="Note" rows="2" class="form-control form-control-sm"
                                  placeholder="Eventuali annotazioni sui dati bancari..."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="salvaDatiBancari()">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>-->

<script>
    let idAvvisoDaEliminare = 0;

    // ➕ Nuovo avviso
    function apriNuovoAvviso() {
        const form = document.getElementById("avvisoForm");
        form.reset();

        // ✏️ Pulisci campi hidden
        form.querySelector('[name="ID_AvvisoParcelle"]').value = "";
        form.querySelector('[name="TariffaOraria"]').value = "";
        form.querySelector('[name="OreEffettive"]').value = "";
        form.querySelector('[name="DescrizioneCompenso"]').value = "";
        form.querySelector('[name="ID_ResponsabilePratica"]').value = "";
        form.querySelector('[name="TitoloAvviso"]').value = "";

        // 💰 Pulisci campi economici
        form.querySelector('[name="Importo"]').value = "";
        form.querySelector('[name="ImportoAcconto"]').value = "";
        form.querySelector('[name="ContributoIntegrativoPercentuale"]').value = "";
        form.querySelector('[name="ContributoIntegrativoImporto"]').value = "";
        form.querySelector('[name="AliquotaIVA"]').value = "";
        form.querySelector('[name="ImportoIVA"]').value = "";
        form.querySelector('[name="RimborsoSpesePercentuale"]').value = "";
        form.querySelector('[name="ImportoRimborsoSpese"]').value = "";
        form.querySelector('[name="TotaleAvvisoParcella"]').value = "";

        // 🧾 Reset campi visivi
        document.getElementById("nomeResponsabilePratica").value = "";
        document.getElementById("nomeOwnerCliente").value = "";

        // 🧹 Reset tipologia / fase giudiziale
        const tipologiaSelect = document.getElementById("tipologiaAvviso");
        const faseContainer = document.getElementById("faseGiudizialeContainer");
        const faseSelect = document.getElementById("faseGiudiziale");

        tipologiaSelect.value = "";
        faseSelect.innerHTML = '<option value="">-- Seleziona fase --</option>';
        faseContainer.classList.add("d-none");

        // 🔄 Reset metodo pagamento e note
        document.getElementById("metodoPagamento").value = "";
        form.querySelector('[name="Note"]').value = "";

        // ✅ Riabilita select pratica e aggiorna titolo
        const selectPratica = document.getElementById("selectPraticaAvviso");
        selectPratica.disabled = false;
        document.getElementById("avvisoModalLabel").textContent = "Nuovo Avviso Parcella";

        // 🔄 Carica le pratiche nel dropdown
        caricaPraticheInSelect();

        // 🔹 Reset visivo del totale e dei campi derivati
        $('#Importo, #ImportoAcconto, [name="ImportoIVA"], [name="ImportoRimborsoSpese"], [name="TotaleAvvisoParcella"]').removeClass('text-danger text-success bg-light');
        $('#labelImporto, #labelImportoAcconto').removeClass('text-muted');

        // ⚙️ Reinizializza la logica Importo / Acconto
        gestisciCampiImportoAcconto();

        // =====================================================
        // 🗓️ Impostazione automatica date
        // =====================================================
        const oggi = new Date();
        const dataOggi = `${oggi.getFullYear()}-${String(oggi.getMonth() + 1).padStart(2, '0')}-${String(oggi.getDate()).padStart(2, '0')}`;
        const primoDelMese = new Date(oggi.getFullYear(), oggi.getMonth(), 1);

        // Imposta la data avviso a oggi
        form.querySelector('[name="DataAvviso"]').value = dataOggi;

        // Memorizza le date "logiche" invisibili
        window.dataCompetenzaCorrente = `${primoDelMese.getFullYear()}-${String(primoDelMese.getMonth() + 1).padStart(2, '0')}-${String(primoDelMese.getDate()).padStart(2, '0')}`;
        window.dataInvioCorrente = null;

        console.log("📅 [DEBUG] DataAvviso impostata:", dataOggi);
        console.log("📅 [DEBUG] DataCompetenza calcolata:", window.dataCompetenzaCorrente);

        // ======================================================
        // 📎 Reset sezione Upload Avviso Firmato
        // ======================================================
        $("#inputFileAvviso").val("");
        $("#fileAvvisoCaricatoContainer").hide();
        $("#fileAvvisoSelezionato").text("");
        $("#nomeFileAvviso").text("");
        $("#hiddenPercorsoAvviso").val("");


        // 🟢 Mostra la modale
        new bootstrap.Modal(document.getElementById("avvisoModal")).show();
    }



    // ✏️ Modifica avviso
    function apriModificaAvviso(id) {
        console.group("🟦 [apriModificaAvviso] Apertura avviso", id);

        fetch(`/Pratiche/GetAvvisoParcella?id=${id}`)
            .then(r => r.json())
            .then(res => {
                console.log("📩 Risposta GetAvvisoParcella:", res);

                if (!res.success) {
                    toastr.error("Errore nel caricamento dell’avviso.");
                    console.warn("❌ Errore: ", res.message);
                    return;
                }

                const a = res.avviso;
                const fasi = res.fasiGiudiziali || [];
                const fissi = res.fissi || [];
                const aOre = res.aOre || [];

                const form = document.getElementById("avvisoForm");
                form.reset();

                // ============================================================
                // 🔁 Campi base
                // ============================================================
                form.querySelector('[name="ID_AvvisoParcelle"]').value = a.ID_AvvisoParcelle;
                form.querySelector('[name="ID_Pratiche"]').value = a.ID_Pratiche;
                form.querySelector('[name="TitoloAvviso"]').value = a.TitoloAvviso || ""; // ✅ nuovo campo
                form.querySelector('[name="Importo"]').value = a.Importo || "";
                form.querySelector('[name="ImportoAcconto"]').value = a.ImportoAcconto || "";
                form.querySelector('[name="Stato"]').value = a.Stato || "";
                form.querySelector('[name="Note"]').value = a.Note || "";
                form.querySelector('[name="MetodoPagamento"]').value = a.MetodoPagamento || "";

                // ======================================================
                // 📎 Gestione documento firmato (PDF)
                // ======================================================
                if (res.haDocumentoCaricato && res.nomeFileDocumento) {
                    // ✅ Mostra info file
                    $("#sezioneUploadAvvisoFirmato").hide();
                    $("#fileAvvisoCaricatoContainer").removeClass("d-none").show();
                    $("#nomeFileAvviso").text(res.nomeFileDocumento);
                    $("#hiddenPercorsoAvviso").val(res.nomeFileDocumento);
                } else {
                    // 🧹 Nessun file caricato
                    $("#sezioneUploadAvvisoFirmato").show();
                    $("#fileAvvisoCaricatoContainer").addClass("d-none").hide();
                    $("#nomeFileAvviso").text("");
                    $("#hiddenPercorsoAvviso").val("");
                }

                // 🔁 Responsabile e Owner
                form.querySelector('[name="ID_ResponsabilePratica"]').value = a.ID_ResponsabilePratica || "";
                form.querySelector('[name="ID_OwnerCliente"]').value = a.ID_OwnerCliente || "";
                document.getElementById("nomeResponsabilePratica").value = a.NomeResponsabilePratica || "";
                document.getElementById("nomeOwnerCliente").value = a.NomeOwnerCliente || "";

                // 📅 Data Avviso
                let dataAvv = null;
                if (a.DataAvviso) {
                    if (typeof a.DataAvviso === "string" && a.DataAvviso.startsWith("/Date(")) {
                        const ms = parseInt(a.DataAvviso.replace(/[^0-9]/g, ""));
                        dataAvv = new Date(ms);
                    } else {
                        dataAvv = new Date(a.DataAvviso);
                    }

                    if (!isNaN(dataAvv.getTime())) {
                        form.querySelector('[name="DataAvviso"]').value =
                            `${dataAvv.getFullYear()}-${String(dataAvv.getMonth() + 1).padStart(2, '0')}-${String(dataAvv.getDate()).padStart(2, '0')}`;
                    }
                }

                // ============================================================
                // 🗓️ Gestione invisibile date di competenza e invio
                // ============================================================
                if (dataAvv) {
                    const dataComp = new Date(dataAvv.getFullYear(), dataAvv.getMonth(), 1);
                    window.dataCompetenzaCorrente =
                        `${dataComp.getFullYear()}-${String(dataComp.getMonth() + 1).padStart(2, '0')}-${String(dataComp.getDate()).padStart(2, '0')}`;
                } else {
                    window.dataCompetenzaCorrente = null;
                }

                if (a.DataInvio) {
                    let dataInv;
                    if (typeof a.DataInvio === "string" && a.DataInvio.startsWith("/Date(")) {
                        const ms = parseInt(a.DataInvio.replace(/[^0-9]/g, ""));
                        dataInv = new Date(ms);
                    } else {
                        dataInv = new Date(a.DataInvio);
                    }

                    if (!isNaN(dataInv.getTime())) {
                        window.dataInvioCorrente =
                            `${dataInv.getFullYear()}-${String(dataInv.getMonth() + 1).padStart(2, '0')}-${String(dataInv.getDate()).padStart(2, '0')}`;
                    }
                } else {
                    window.dataInvioCorrente = null;
                }

                console.log("📅 [DEBUG] DataCompetenza:", window.dataCompetenzaCorrente);
                console.log("📤 [DEBUG] DataInvio:", window.dataInvioCorrente);

                // 💰 Contributi, IVA e Totale
                const valoreCI = a.ContributoIntegrativoPercentuale ?? res.contributoIntegrativoPercentuale ?? "";
                form.querySelector('[name="ContributoIntegrativoPercentuale"]').value = valoreCI;
                form.querySelector('[name="ContributoIntegrativoImporto"]').value = a.ContributoIntegrativoImporto || "";
                form.querySelector('[name="AliquotaIVA"]').value = a.AliquotaIVA || "";
                form.querySelector('[name="ImportoIVA"]').value = a.ImportoIVA || "";
                form.querySelector('[name="TotaleAvvisoParcella"]').value = a.TotaleAvvisoParcella || "";

                // ============================================================
                // 🔹 Gestione tipologia avviso
                // ============================================================
                const tipologiaSelect = form.querySelector('[name="TipologiaAvviso"]');
                tipologiaSelect.value = a.TipologiaAvviso || "";

                const faseContainer = document.getElementById("faseGiudizialeContainer");
                const faseSelect = document.getElementById("faseGiudiziale");
                const voceContainer = document.getElementById("voceCompensoContainer");
                const voceSelect = document.getElementById("voceCompensoSelect");

                faseContainer.classList.add("d-none");
                voceContainer.classList.add("d-none");
                voceSelect.innerHTML = "";
                faseSelect.innerHTML = "";

                // ============================================================
                // ⚖️ Caso 1 - Giudiziale
                // ============================================================
                if (a.TipologiaAvviso === "Giudiziale") {
                    faseContainer.classList.remove("d-none");

                    if (fasi.length > 0) {
                        fasi.forEach(f => {
                            const importoTotale = parseFloat(f.Importo) || 0;
                            const importoInviato = parseFloat(f.ImportoInviatoAllaFatturazione) || 0;
                            const importoResiduo = importoTotale - importoInviato;
                            const selected = f.ID_CompensoOrigine === a.ID_CompensoOrigine ? "selected" : "";

                            faseSelect.insertAdjacentHTML(
                                "beforeend",
                                `<option value="${f.FaseGiudiziale}"
                                data-importo="${importoResiduo}"
                                data-idcompenso="${f.ID_CompensoOrigine}"
                                ${selected}>
                                ${f.FaseGiudiziale} (${importoResiduo.toFixed(2)} €)
                            </option>`
                            );

                            if (selected) {
                                form.querySelector('[name="Importo"]').value = importoResiduo.toFixed(2);
                            }
                        });
                    } else {
                        faseSelect.innerHTML = '<option value="">Nessuna fase disponibile</option>';
                    }
                }

                // ============================================================
                // 💼 Caso 2 - Fisso
                // ============================================================
                else if (a.TipologiaAvviso === "Fisso") {
                    voceContainer.classList.remove("d-none");
                    voceSelect.innerHTML = "";

                    if (fissi.length > 0) {
                        fissi.forEach(f => {
                            const importoTotale = parseFloat(f.ImportoTotale || f.ImportoBase || f.Importo) || 0;
                            const inviato = parseFloat(f.ImportoInviatoAllaFatturazione) || 0;
                            const residuo = importoTotale - inviato;

                            const selected = (a.ID_CompensoOrigine &&
                                (f.ID_CompensoOrigine === a.ID_CompensoOrigine ||
                                    f.ID_RigaCompenso === a.ID_CompensoOrigine))
                                ? "selected" : "";

                            voceSelect.insertAdjacentHTML(
                                "beforeend",
                                `<option value="${f.ID_CompensoOrigine}"
                                data-importo="${residuo}" ${selected}>
                                ${f.Voce} (${residuo.toFixed(2)} €)
                            </option>`
                            );

                            if (selected) {
                                form.querySelector('[name="Importo"]').value = residuo.toFixed(2);
                            }
                        });
                    } else {
                        voceSelect.innerHTML = '<option value="">Nessun compenso fisso disponibile</option>';
                    }
                }

                // ============================================================
                // ⏱️ Caso 3 - A ore
                // ============================================================
                else if (a.TipologiaAvviso === "A ore") {
                    voceContainer.classList.remove("d-none");
                    voceSelect.innerHTML = "";

                    if (aOre.length > 0) {
                        aOre.forEach(f => {
                            const importoTotale = parseFloat(f.Importo) || 0;
                            const inviato = parseFloat(f.ImportoInviatoAllaFatturazione) || 0;
                            const residuo = importoTotale - inviato;
                            const selected = f.ID_CompensoOrigine === a.ID_CompensoOrigine ? "selected" : "";

                            voceSelect.insertAdjacentHTML(
                                "beforeend",
                                `<option value="${f.ID_CompensoOrigine}"
                                data-importo="${residuo}" ${selected}>
                                ${f.Voce} (${residuo.toFixed(2)} €)
                            </option>`
                            );

                            if (selected) {
                                form.querySelector('[name="Importo"]').value = residuo.toFixed(2);
                            }
                        });
                    } else {
                        voceSelect.innerHTML = '<option value="">Nessun compenso a ore disponibile</option>';
                    }
                }

                // 🔄 Cambio selezione → aggiorna Importo
                voceSelect.addEventListener("change", e => {
                    const opt = e.target.selectedOptions[0];
                    if (opt && opt.dataset.importo) {
                        form.querySelector('[name="Importo"]').value = parseFloat(opt.dataset.importo).toFixed(2);
                        calcolaTotaleAvvisoParcella();
                        gestisciCampiImportoAcconto();
                    }
                });

                faseSelect.addEventListener("change", e => {
                    const opt = e.target.selectedOptions[0];
                    if (opt && opt.dataset.importo) {
                        form.querySelector('[name="Importo"]').value = parseFloat(opt.dataset.importo).toFixed(2);
                        calcolaTotaleAvvisoParcella();
                        gestisciCampiImportoAcconto();
                    }
                });

                // 🔹 Rimborso spese
                form.querySelector('[name="RimborsoSpesePercentuale"]').value =
                    a.RimborsoSpesePercentuale || res.rimborsoSpesePercentuale || "0";
                form.querySelector('[name="ImportoRimborsoSpese"]').value = a.ImportoRimborsoSpese || "";

                // ✅ Aggiorna hidden ID_RigaCompenso / ID_CompensoOrigine
                const hiddenCompenso = form.querySelector('[name="ID_RigaCompenso"]');
                if (hiddenCompenso) hiddenCompenso.value = a.ID_CompensoOrigine || "";

                // 🔁 Selezione pratica
                const select = form.querySelector('[name="ID_Pratiche"]');
                let option = select.querySelector(`option[value="${a.ID_Pratiche}"]`);
                if (!option) {
                    option = document.createElement("option");
                    option.value = a.ID_Pratiche;
                    option.textContent = a.NomePratica || "Pratica selezionata";
                    select.appendChild(option);
                }
                select.value = a.ID_Pratiche;
                select.disabled = true;

                // 🎨 Ripristina stili base
                $('#Importo, #ImportoAcconto, [name="ImportoIVA"], [name="ImportoRimborsoSpese"], [name="TotaleAvvisoParcella"]').removeClass('bg-light text-muted');
                $('#labelImporto, #labelImportoAcconto').removeClass('text-muted');

                // ⚙️ Applica logica di esclusione Importo/Acconto
                gestisciCampiImportoAcconto();

                // ============================================================
                // 💰 FIX: ripristino Importo effettivo da server se mancante
                // ============================================================
                if (a.Importo && parseFloat(a.Importo) > 0) {
                    const importoServer = parseFloat(a.Importo);
                    form.querySelector('[name="Importo"]').value = importoServer.toFixed(2);
                    console.log("💶 [DEBUG] Importo base ripristinato da server:", importoServer);

                    calcolaContributoIntegrativo();
                    calcolaTotaleAvvisoParcella();
                } else {
                    console.warn("⚠️ [DEBUG] Nessun importo valido da server, mantengo valore esistente");
                }

                // 🟢 Mostra la modale
                document.getElementById("avvisoModalLabel").textContent = "Modifica Avviso Parcella";
                new bootstrap.Modal(document.getElementById("avvisoModal")).show();

                // 🔄 Ricalcola totale dopo caricamento
                setTimeout(() => {
                    calcolaTotaleAvvisoParcella();
                    gestisciCampiImportoAcconto();
                }, 400);
            })
            .catch(err => {
                console.error("❌ Errore apertura avviso:", err);
                toastr.error("Errore durante il caricamento dell’avviso.");
            })
            .finally(() => {
                console.groupEnd();
            });
    }




    // 💾 Salva (submit)
    $('#avvisoForm').on('submit', function (e) {
        e.preventDefault();

        const form = this;

        // 🔓 Se la select pratica è disabilitata, abilitala temporaneamente per l’invio
        const selectPratica = document.getElementById("selectPraticaAvviso");
        const eraDisabilitata = selectPratica.disabled;
        if (eraDisabilitata) selectPratica.disabled = false;

        // 🔄 Ricalcola i totali prima di inviare
        calcolaTotaleAvvisoParcella();

        const formData = new FormData(form);

        // 🔒 Ripristina stato disabilitato
        if (eraDisabilitata) selectPratica.disabled = true;

        // =======================================================
        // 🗓️ Aggiungi automaticamente DataCompetenza e DataInvio
        // =======================================================
        const dataAvvisoStr = formData.get("DataAvviso");

        if (dataAvvisoStr) {
            const d = new Date(dataAvvisoStr);
            // Calcola automaticamente la data di competenza = primo giorno del mese
            const dataCompetenza = new Date(d.getFullYear(), d.getMonth(), 1);
            const dataCompetenzaStr =
                `${dataCompetenza.getFullYear()}-${String(dataCompetenza.getMonth() + 1).padStart(2, '0')}-${String(dataCompetenza.getDate()).padStart(2, '0')}`;

            formData.set("DataCompetenza", dataCompetenzaStr);
            window.dataCompetenzaCorrente = dataCompetenzaStr;
        }

        // 📤 Gestione DataInvio
        if (formData.get("Stato") === "Inviato") {
            const oggi = new Date();
            const dataInvioStr =
                `${oggi.getFullYear()}-${String(oggi.getMonth() + 1).padStart(2, '0')}-${String(oggi.getDate()).padStart(2, '0')}`;
            formData.set("DataInvio", dataInvioStr);
            window.dataInvioCorrente = dataInvioStr;
        } else if (window.dataInvioCorrente) {
            formData.set("DataInvio", window.dataInvioCorrente);
        } else {
            formData.set("DataInvio", "");
        }

        console.log("📅 [DEBUG] DataCompetenza:", formData.get("DataCompetenza"));
        console.log("📤 [DEBUG] DataInvio:", formData.get("DataInvio"));

        // =======================================================
        // 🧩 Recupera ID Compenso (origine o voce selezionata)
        // =======================================================
        const tipologia = formData.get("TipologiaAvviso");
        const voceSelect = document.getElementById("voceCompensoSelect");
        const faseSelect = document.getElementById("faseGiudiziale");
        const hiddenCompenso = document.getElementById("ID_RigaCompenso");

        let idCompenso = "";

        if (tipologia === "Fisso" || tipologia === "A ore") {
            const opt = voceSelect?.selectedOptions?.[0];
            if (opt) idCompenso = opt.dataset.idcompenso || opt.value || "";
        } else if (tipologia === "Giudiziale") {
            const opt = faseSelect?.selectedOptions?.[0];
            if (opt && opt.dataset.idcompenso) {
                idCompenso = opt.dataset.idcompenso;
            }
        }

        // ✅ Aggiorna il campo hidden e aggiungi nel FormData anche per il backend
        hiddenCompenso.value = idCompenso;
        formData.set("ID_RigaCompenso", idCompenso);
        formData.set("ID_CompensoOrigine", idCompenso);

        // =======================================================
        // 🧮 FIX CULTURALE – Normalizza numeri con virgola per ASP.NET
        // =======================================================
        [
            "Importo",
            "ImportoAcconto",
            "TotaleAvvisoParcella",
            "ImportoIVA",
            "ContributoIntegrativoImporto",
            "ImportoRimborsoSpese"
        ].forEach(campo => {
            const val = formData.get(campo);
            if (val) {
                const normalizzato = val.toString().trim().replace(".", ",");
                console.log(`🔢 Normalizzato ${campo}: da ${val} → ${normalizzato}`);
                formData.set(campo, normalizzato);
            }
        });

        // ✅ Aggiungi TitoloAvviso
        const titolo = formData.get("TitoloAvviso");
        formData.set("TitoloAvviso", titolo || "");
        console.log("📌 TitoloAvviso:", titolo);

        // =======================================================
        // 🧩 DEBUG – mostra tutti i dati che verranno inviati
        // =======================================================
        console.group("📦 [DEBUG SUBMIT] DATI INVIATI AL CONTROLLER");
        console.log("📌 Tipologia:", tipologia);
        console.log("📌 Fase selezionata:", faseSelect?.value || "(vuota)");
        console.log("📌 Voce selezionata:", voceSelect?.value || "(vuota)");
        console.log("📎 ID_RigaCompenso:", hiddenCompenso.value || "(vuoto)");
        console.log("📎 ID_CompensoOrigine:", formData.get("ID_CompensoOrigine") || "(vuoto)");
        console.log("📎 Importo:", formData.get("Importo") || "(vuoto)");
        console.log("📎 ImportoAcconto:", formData.get("ImportoAcconto") || "(vuoto)");
        console.log("📎 Totale Avviso Parcella:", formData.get("TotaleAvvisoParcella") || "(vuoto)");
        console.log("📎 Pratica:", formData.get("ID_Pratiche") || "(vuota)");
        console.log("📎 Stato:", formData.get("Stato") || "(vuoto)");
        console.log("📎 Metodo Pagamento:", formData.get("MetodoPagamento") || "(vuoto)");
        console.log("📅 DataCompetenza:", formData.get("DataCompetenza"));
        console.log("📤 DataInvio:", formData.get("DataInvio"));
        console.groupEnd();

        // =======================================================
        // ⚠️ Validazioni minime lato client
        // =======================================================
        const importo = parseFloat((formData.get("Importo") || "0").replace(",", "."));
        const acconto = parseFloat((formData.get("ImportoAcconto") || "0").replace(",", "."));

        if (tipologia === "Giudiziale" && !formData.get("FaseGiudiziale")) {
            toastr.warning("⚠️ Devi selezionare una fase giudiziale.");
            return;
        }

        // ✅ Validazione mutua esclusione
        if ((importo <= 0 && acconto <= 0) || (importo > 0 && acconto > 0)) {
            toastr.warning("⚠️ Inserisci solo uno tra Importo o Importo Acconto.");
            return;
        }

        // =======================================================
        // 📤 Scelta endpoint (Crea o Modifica)
        // =======================================================
        const id = formData.get("ID_AvvisoParcelle");
        const url = id && parseInt(id) > 0
            ? '/Pratiche/ModificaAvvisoParcella'
            : '/Pratiche/CreaAvvisoParcella';

        // =======================================================
        // 🚀 Invio al server
        // =======================================================
        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                console.group("📥 [RISPOSTA DAL SERVER]");
                console.log(res);
                console.groupEnd();

                if (res.success) {
                    toastr.success(res.message || "Avviso salvato con successo.");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("avvisoModal"));
                    if (modal) modal.hide();

                    // 🔄 Ricarica la lista avvisi o la pagina
                    if (typeof caricaAvvisiParcella === "function") caricaAvvisiParcella();
                    else location.reload();
                } else {
                    toastr.error(res.message || "Errore durante il salvataggio.");
                }
            })
            .catch(err => {
                console.error("❌ Errore durante il salvataggio:", err);
                toastr.error("Errore imprevisto durante il salvataggio dell’avviso.");
            });
    });



    // 🗑️ Elimina
    function confermaEliminazioneAvviso(id) {
        idAvvisoDaEliminare = id;
        new bootstrap.Modal(document.getElementById("eliminaAvvisoModal")).show();
    }

    $('#btnConfermaEliminazioneAvviso').on('click', function () {
        fetch('/Pratiche/EliminaAvvisoParcella', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${idAvvisoDaEliminare}`
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    location.reload();
                } else {
                    toastr.error(res.message);
                }
            });
    });


    // 📋 Carica le pratiche nel select e gestisci i dati collegati
    function caricaPraticheInSelect() {
        fetch('/Pratiche/GetListaPratiche')
            .then(res => res.json())
            .then(data => {
                console.log("📦 [DEBUG] Risposta completa da GetListaPratiche:", data);

                const select = document.getElementById("selectPraticaAvviso");
                const tipologiaSelect = document.getElementById("tipologiaAvviso");
                const faseContainer = document.getElementById("faseGiudizialeContainer");
                const faseSelect = document.getElementById("faseGiudiziale");
                const voceContainer = document.getElementById("voceCompensoContainer");
                const voceSelect = document.getElementById("voceCompensoSelect");

                // 🔄 Reset iniziale select
                select.innerHTML = '<option value="">-- Seleziona una pratica --</option>';
                window.mappaPraticaProfessionista = {};

                if (data.success && Array.isArray(data.pratiche)) {
                    // ============================================================
                    // 🔹 Popola le pratiche nel dropdown
                    // ============================================================
                    data.pratiche.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.ID_Pratiche;
                        option.textContent = p.Titolo;
                        select.appendChild(option);

                        window.mappaPraticaProfessionista[p.ID_Pratiche] = {
                            idResponsabile: p.ID_UtenteResponsabile,
                            nomeResponsabile: p.NomeResponsabile,
                            idOwner: p.ID_OwnerCliente,
                            nomeOwner: p.NomeOwner,
                            contributoPercentuale: p.PercentualeContributoIntegrativo,
                            tipologia: p.Tipologia,
                            importo: p.Importo || 0,
                            compensiDettaglio: p.CompensiDettaglio || [],
                            fasiGiudiziali: p.FasiGiudiziali || []
                        };
                    });

                    // ============================================================
                    // 🔄 Cambio pratica
                    // ============================================================
                    if (!select.dataset.listenerAggiunto) {
                        select.addEventListener("change", function () {
                            const idPratica = this.value;
                            const info = window.mappaPraticaProfessionista[idPratica];

                            // Reset campi economici
                            document.querySelector('[name="Importo"]').value = "";
                            document.querySelector('[name="ImportoAcconto"]').value = "";
                            $('#Importo, #ImportoAcconto').removeClass('bg-light text-muted');
                            $('#labelImporto, #labelImportoAcconto').removeClass('text-muted');

                            // Reset contenitori compensi
                            faseSelect.innerHTML = '<option value="">-- Seleziona fase --</option>';
                            voceSelect.innerHTML = '<option value="">-- Seleziona voce --</option>';
                            faseContainer.classList.add("d-none");
                            voceContainer.classList.add("d-none");

                            if (info) {
                                console.log("🟩 [DEBUG] Pratica selezionata:", info);

                                // ============================================================
                                // 👤 Dati anagrafici
                                // ============================================================
                                document.getElementById("nomeResponsabilePratica").value = info.nomeResponsabile || "N.D.";
                                document.getElementById("nomeOwnerCliente").value = info.nomeOwner || "N.D.";
                                document.querySelector('[name="ID_ResponsabilePratica"]').value = info.idResponsabile || "";
                                document.querySelector('[name="ID_OwnerCliente"]').value = info.idOwner || "";

                                // ============================================================
                                // 💰 Contributo integrativo predefinito
                                // ============================================================
                                document.querySelector('[name="ContributoIntegrativoPercentuale"]').value =
                                    info.contributoPercentuale || 0;

                                // Importo base (se esiste)
                                const base = parseFloat(info.importo || 0);
                                if (base > 0) {
                                    document.querySelector('[name="Importo"]').value = base.toFixed(2);
                                    calcolaContributoIntegrativo();
                                    calcolaTotaleAvvisoParcella();
                                }

                                // ⚙️ Reimposta logica mutua esclusione
                                gestisciCampiImportoAcconto();

                                // ============================================================
                                // 🗓️ Imposta automaticamente DataAvviso e DataCompetenza
                                // ============================================================
                                const oggi = new Date();
                                const dataOggi =
                                    `${oggi.getFullYear()}-${String(oggi.getMonth() + 1).padStart(2, '0')}-${String(oggi.getDate()).padStart(2, '0')}`;
                                document.querySelector('[name="DataAvviso"]').value = dataOggi;

                                const primoDelMese = new Date(oggi.getFullYear(), oggi.getMonth(), 1);
                                window.dataCompetenzaCorrente =
                                    `${primoDelMese.getFullYear()}-${String(primoDelMese.getMonth() + 1).padStart(2, '0')}-${String(primoDelMese.getDate()).padStart(2, '0')}`;

                                console.log("📅 [DEBUG] DataAvviso impostata automaticamente:", dataOggi);
                                console.log("📆 [DEBUG] DataCompetenza calcolata:", window.dataCompetenzaCorrente);
                            }
                        });
                        select.dataset.listenerAggiunto = "true";
                    }

                    // ============================================================
                    // 🔄 Cambio tipologia (Fisso / A ore / Giudiziale)
                    // ============================================================
                    if (!tipologiaSelect.dataset.listenerAggiunto) {
                        tipologiaSelect.addEventListener("change", function () {
                            const tipo = this.value;
                            const idPratica = select.value;
                            const info = window.mappaPraticaProfessionista[idPratica];

                            console.log(`🟨 [DEBUG] Cambio tipologia → ${tipo}`, info);

                            // Reset UI
                            faseSelect.innerHTML = '<option value="">-- Seleziona fase --</option>';
                            voceSelect.innerHTML = '<option value="">-- Seleziona voce --</option>';
                            faseContainer.classList.add("d-none");
                            voceContainer.classList.add("d-none");
                            document.querySelector('[name="Importo"]').value = "";
                            document.querySelector('[name="ImportoAcconto"]').value = "";
                            gestisciCampiImportoAcconto();

                            if (!info) return;

                            // ============================================================
                            // ⚖️ Caso GIUDIZIALE
                            // ============================================================
                            if (tipo === "Giudiziale") {
                                faseContainer.classList.remove("d-none");
                                const fasi = info.fasiGiudiziali || [];

                                if (fasi.length > 0) {
                                    fasi.forEach(f => {
                                        const importoBase = parseFloat(f.Importo) || 0;
                                        const importoInviato = parseFloat(f.ImportoInviatoAllaFatturazione) || 0;
                                        const importoResiduo = importoBase - importoInviato;

                                        const option = document.createElement("option");
                                        option.value = f.FaseGiudiziale;
                                        option.textContent = `${f.FaseGiudiziale} (${importoResiduo.toFixed(2)} €)`;
                                        option.dataset.importo = importoResiduo;
                                        option.dataset.idcompenso = f.ID_CompensoOrigine;
                                        faseSelect.appendChild(option);
                                    });

                                    faseSelect.onchange = function () {
                                        const opt = this.options[this.selectedIndex];
                                        const importo = parseFloat(opt.dataset.importo) || 0;
                                        const idCompenso = opt.dataset.idcompenso || null;

                                        console.log("💰 [DEBUG] Fase selezionata:", {
                                            Fase: opt.value,
                                            ImportoResiduo: importo,
                                            ID_RigaCompenso: idCompenso
                                        });

                                        document.querySelector('[name="Importo"]').value = importo.toFixed(2);
                                        document.querySelector('#ID_RigaCompenso').value = idCompenso;

                                        calcolaContributoIntegrativo();
                                        calcolaTotaleAvvisoParcella();
                                        gestisciCampiImportoAcconto();
                                    };
                                } else {
                                    faseSelect.innerHTML = '<option value="">Nessuna fase disponibile</option>';
                                    toastr.info("Nessuna voce di fase giudiziale trovata per questa pratica.");
                                }
                            }

                            // ============================================================
                            // 💼 Caso FISSO
                            // ============================================================
                            else if (tipo === "Fisso") {
                                const vociFisse = info.compensiDettaglio.filter(c => c.TipoCompenso?.toLowerCase() === "fisso");

                                if (vociFisse.length > 0) {
                                    voceContainer.classList.remove("d-none");
                                    voceSelect.innerHTML = '<option value="">-- Seleziona voce --</option>';

                                    vociFisse.forEach(v => {
                                        const importoTotale = parseFloat(v.Importo) || 0;
                                        const inviato = parseFloat(v.ImportoInviatoAllaFatturazione) || 0;
                                        const residuo = importoTotale - inviato;

                                        const option = document.createElement("option");
                                        option.value = v.ID_RigaCompenso;
                                        option.textContent = `${v.Descrizione || "(Senza descrizione)"} – ${residuo.toFixed(2)} €`;
                                        option.dataset.importo = residuo;
                                        option.dataset.idcompenso = v.ID_RigaCompenso;
                                        voceSelect.appendChild(option);
                                    });

                                    voceSelect.onchange = function () {
                                        const opt = this.options[this.selectedIndex];
                                        const importo = parseFloat(opt.dataset.importo) || 0;
                                        const idCompenso = opt.dataset.idcompenso || null;

                                        console.log("💵 [DEBUG] Voce FISSO selezionata:", { ID_RigaCompenso: idCompenso, ImportoResiduo: importo });

                                        document.querySelector('[name="Importo"]').value = importo.toFixed(2);
                                        document.querySelector('#ID_RigaCompenso').value = idCompenso;

                                        calcolaContributoIntegrativo();
                                        calcolaTotaleAvvisoParcella();
                                        gestisciCampiImportoAcconto();
                                    };
                                } else {
                                    toastr.info("Nessuna voce di compenso fisso trovata per questa pratica.");
                                }
                            }

                            // ============================================================
                            // ⏱️ Caso A ORE
                            // ============================================================
                            else if (tipo === "A ore") {
                                const vociOre = info.compensiDettaglio.filter(c => c.TipoCompenso?.toLowerCase() === "a ore");

                                if (vociOre.length > 0) {
                                    voceContainer.classList.remove("d-none");
                                    voceSelect.innerHTML = '<option value="">-- Seleziona voce --</option>';

                                    vociOre.forEach(v => {
                                        const importoTotale = parseFloat(v.Importo) || 0;
                                        const inviato = parseFloat(v.ImportoInviatoAllaFatturazione) || 0;
                                        const residuo = importoTotale - inviato;

                                        const option = document.createElement("option");
                                        option.value = v.ID_RigaCompenso;
                                        option.textContent = `${v.Descrizione || "(Senza descrizione)"} – ${residuo.toFixed(2)} €`;
                                        option.dataset.importo = residuo;
                                        option.dataset.idcompenso = v.ID_RigaCompenso;
                                        voceSelect.appendChild(option);
                                    });

                                    voceSelect.onchange = function () {
                                        const opt = this.options[this.selectedIndex];
                                        const importo = parseFloat(opt.dataset.importo) || 0;
                                        const idCompenso = opt.dataset.idcompenso || null;

                                        console.log("⏱️ [DEBUG] Voce A ORE selezionata:", { ID_RigaCompenso: idCompenso, ImportoResiduo: importo });

                                        document.querySelector('[name="Importo"]').value = importo.toFixed(2);
                                        document.querySelector('#ID_RigaCompenso').value = idCompenso;

                                        calcolaContributoIntegrativo();
                                        calcolaTotaleAvvisoParcella();
                                        gestisciCampiImportoAcconto();
                                    };
                                } else {
                                    toastr.info("Nessuna voce di compenso orario trovata per questa pratica.");
                                }
                            }
                        });
                        tipologiaSelect.dataset.listenerAggiunto = "true";
                    }
                }
            })
            .catch(err => {
                console.error("❌ Errore caricamento pratiche:", err);
                toastr.error("Errore durante il caricamento delle pratiche.");
            });
    }



    function gestisciCampiImportoAcconto() {
        const campoImporto = document.getElementById("Importo");
        const campoAcconto = document.getElementById("ImportoAcconto");
        const labelImporto = document.getElementById("labelImporto");
        const labelAcconto = document.getElementById("labelImportoAcconto");

        const valImporto = parseFloat(campoImporto.value) || 0;
        const valAcconto = parseFloat(campoAcconto.value) || 0;

        if (valAcconto > 0) {
            // 🔒 Se c'è acconto → disabilita Importo
            campoImporto.value = "";
            campoImporto.disabled = true;
            campoImporto.classList.add("bg-light");
            labelImporto.classList.add("text-muted");

            campoAcconto.disabled = false;
            campoAcconto.classList.remove("bg-light");
            labelAcconto.classList.remove("text-muted");
        }
        else if (valImporto > 0) {
            // 🔒 Se c'è importo → disabilita Acconto
            campoAcconto.value = "";
            campoAcconto.disabled = true;
            campoAcconto.classList.add("bg-light");
            labelAcconto.classList.add("text-muted");

            campoImporto.disabled = false;
            campoImporto.classList.remove("bg-light");
            labelImporto.classList.remove("text-muted");
        }
        else {
            // 🔄 Nessun valore → entrambi abilitati
            campoImporto.disabled = false;
            campoAcconto.disabled = false;
            campoImporto.classList.remove("bg-light");
            campoAcconto.classList.remove("bg-light");
            labelImporto.classList.remove("text-muted");
            labelAcconto.classList.remove("text-muted");
        }
    }

    // ✅ Reinizializza quando si apre la modale
    document.addEventListener("shown.bs.modal", function (event) {
        if (event.target.id === "avvisoModal") {
            gestisciCampiImportoAcconto();
        }
    });



    /* questo controlla il metodo di pagamento commentata in data 15/10/2025 in quanto il pagamento del avviso va direttamente nel conto di sinergia  */

    //function controllaMetodoPagamento() {
    //    const metodo = document.getElementById("metodoPagamento").value;

    //    if (metodo === "Bonifico") {
    //        const idPratica = document.getElementById("selectPraticaAvviso").value;

    //        if (!idPratica) {
    //            toastr.warning("Seleziona prima una pratica.");
    //            document.getElementById("metodoPagamento").value = "";
    //            return;
    //        }

    //        const info = window.mappaPraticaProfessionista[idPratica];
    //        const idProfessionista = info?.idResponsabile; // ✅ CORRETTO

    //        if (!idProfessionista || parseInt(idProfessionista) <= 0) {
    //            toastr.warning("Professionista non trovato per la pratica selezionata.");
    //            document.getElementById("metodoPagamento").value = "";
    //            return;
    //        }

    //        apriModaleDatiBancariProfessionista(idProfessionista);
    //    }
    //}

    /*  DATI BANCARI commentati in data 15/10/2025 in quanto il pagamento del avviso va direttamente nel conto di sinergia*/

    //function apriModaleDatiBancariProfessionista(idProfessionista) {
    //    const form = document.getElementById("DatiBancariForm");
    //    form.reset();

    //    form.querySelector('[name="ID_Cliente"]').value = idProfessionista || "";
    //    form.querySelector('[name="TipoCliente"]').value = "Professionista";
    //    document.getElementById("hiddenProfessionistaAvviso").value = idProfessionista || ""; // ✅ sicurezza extra

    //    if (!idProfessionista || idProfessionista === "0") {
    //        new bootstrap.Modal(document.getElementById("datiBancariModal")).show();
    //        return;
    //    }

    //    fetch(`/Pratiche/GetDatiBancari?idCliente=${idProfessionista}`)
    //        .then(response => {
    //            if (!response.ok) {
    //                throw new Error("Risposta non valida dal server.");
    //            }
    //            return response.json();
    //        })
    //        .then(data => {
    //            if (data && data.IBAN) {
    //                // I dati bancari esistono, quindi non apriamo la modale
    //                return;
    //            }

    //            // Dati mancanti: apri la modale per inserirli
    //            toastr.warning("Dati bancari mancanti. Inserisci i dati per procedere.");
    //            new bootstrap.Modal(document.getElementById("datiBancariModal")).show();
    //        })
    //        .catch(err => {
    //            console.error("Errore nel recupero dei dati bancari:", err);
    //            toastr.warning("Dati bancari mancanti o errore nella lettura. Inserisci i dati.");
    //            new bootstrap.Modal(document.getElementById("datiBancariModal")).show();
    //        });

    //}

    //function salvaDatiBancari() {
    //    const form = document.getElementById("DatiBancariForm");

    //    // 👉 Check manuale dei required
    //    const nomeBanca = form.querySelector('[name="NomeBanca"]').value.trim();
    //    const iban = form.querySelector('[name="IBAN"]').value.trim();
    //    const intestatario = form.querySelector('[name="Intestatario"]').value.trim();

    //    if (!nomeBanca || !iban || !intestatario) {
    //        toastr.error("Tutti i campi obbligatori devono essere compilati.");
    //        return;
    //    }

    //    const formData = new FormData(form);
    //    const idCliente = formData.get("ID_Cliente");

    //    if (!idCliente) {
    //        // Salva in variabile JS (caso edge)
    //        datiBancariTemporaneiProfessionista = {
    //            NomeBanca: nomeBanca,
    //            IBAN: iban,
    //            Intestatario: intestatario,
    //            BIC_SWIFT: formData.get("BIC_SWIFT"),
    //            Note: formData.get("Note")
    //        };

    //        toastr.success("Dati bancari salvati temporaneamente.");
    //        bootstrap.Modal.getInstance(document.getElementById('datiBancariModal')).hide();
    //        setTimeout(() => {
    //            const modaleAvviso = new bootstrap.Modal(document.getElementById('modaleAvvisoParcella'));
    //            modaleAvviso.show();
    //        }, 300);
    //        return;
    //    }

    //    // Invio al server
    //    fetch('/Pratiche/SalvaDatiBancari', {
    //        method: 'POST',
    //        body: formData
    //    })
    //        .then(r => r.json())
    //        .then(res => {
    //            if (res.success) {
    //                toastr.success(res.message);
    //                bootstrap.Modal.getInstance(document.getElementById('datiBancariModal')).hide();
    //                setTimeout(() => {
    //                    const modaleAvviso = new bootstrap.Modal(document.getElementById('modaleAvvisoParcella'));
    //                    modaleAvviso.show();
    //                }, 300);
    //            } else {
    //                toastr.error(res.message);
    //            }
    //        })
    //        .catch(err => {
    //            console.error("Errore:", err);
    //            toastr.error("Errore durante il salvataggio dati bancari.");
    //        });
    //}

    /* fine dati bancari*/


    /* calcolo contributo integrativo e calcolo totale della parcella*/

    // ===================================================
    // 💰 Calcola Contributo Integrativo (basato su Importo + Spese Generali)
    // ===================================================
    function calcolaContributoIntegrativo() {
        const form = document.getElementById("avvisoForm");
        if (!form) return;

        const importo = parseFloat((form.querySelector('[name="Importo"]').value || "0").replace(",", ".")) || 0;
        const importoAcconto = parseFloat((form.querySelector('[name="ImportoAcconto"]').value || "0").replace(",", ".")) || 0;
        const speseGenerali = parseFloat((form.querySelector('[name="ImportoRimborsoSpese"]').value || "0").replace(",", ".")) || 0;
        const percentuale = parseFloat((form.querySelector('[name="ContributoIntegrativoPercentuale"]').value || "0").replace(",", ".")) || 0;

        const base = importoAcconto > 0 ? importoAcconto : importo;
        const baseCI = base + speseGenerali;

        const contributo = +(baseCI * percentuale / 100).toFixed(2);

        form.querySelector('[name="ContributoIntegrativoImporto"]').value =
            contributo > 0 ? contributo.toFixed(2) : "";
    }


    // ===================================================
    // 🧮 Calcola Totale Avviso Parcella (coerente col backend)
    // ===================================================
    function calcolaTotaleAvvisoParcella() {
        const form = document.getElementById("avvisoForm");
        if (!form) return;

        // 🔥 Prima ricalcolo CI altrimenti contributoIntegrativo è errato
        calcolaContributoIntegrativo();

        // 🔹 Input
        const importo = parseFloat((form.querySelector('[name="Importo"]').value || "0").replace(",", ".")) || 0;
        const importoAcconto = parseFloat((form.querySelector('[name="ImportoAcconto"]').value || "0").replace(",", ".")) || 0;
        const ivaPerc = parseFloat((form.querySelector('[name="AliquotaIVA"]').value || "0").replace(",", ".")) || 0;
        const rimborsoPerc = parseFloat((form.querySelector('[name="RimborsoSpesePercentuale"]').value || "0").replace(",", ".")) || 0;

        // 🔁 Base imponibile effettiva
        const base = importoAcconto > 0 ? importoAcconto : importo;

        // 1️⃣ Rimborso spese (su imponibile)
        const importoRimborso = +(base * rimborsoPerc / 100).toFixed(2);
        form.querySelector('[name="ImportoRimborsoSpese"]').value = importoRimborso.toFixed(2);

        // 2️⃣ CI aggiornato dopo fix
        const contributoIntegrativo = parseFloat(
            (form.querySelector('[name="ContributoIntegrativoImporto"]').value || "0").replace(",", ".")
        ) || 0;

        // 3️⃣ Base IVA
        const imponibileIVA = base + importoRimborso + contributoIntegrativo;

        // 4️⃣ IVA
        const importoIva = +(imponibileIVA * ivaPerc / 100).toFixed(2);
        form.querySelector('[name="ImportoIVA"]').value = importoIva.toFixed(2);

        // 5️⃣ Totale
        const totale = +(imponibileIVA + importoIva).toFixed(2);
        form.querySelector('[name="TotaleAvvisoParcella"]').value = totale.toFixed(2);

        console.log("✔ Totale aggiornato", { totale });
    }


    // ===================================================
    // 🔁 Eventi di aggiornamento automatico live
    // ===================================================
    document.getElementById("selectPraticaAvviso").addEventListener("change", () => {
        calcolaContributoIntegrativo();
        calcolaTotaleAvvisoParcella();
    });

    document.querySelector('[name="Importo"]').addEventListener("input", () => {
        calcolaContributoIntegrativo();
    });

    document.querySelector('[name="ImportoAcconto"]').addEventListener("input", () => {
        calcolaContributoIntegrativo();
    });

    document.querySelector('[name="ContributoIntegrativoPercentuale"]').addEventListener("input", () => {
        calcolaContributoIntegrativo();
    });

    document.querySelector('[name="AliquotaIVA"]').addEventListener("change", () => {
        calcolaTotaleAvvisoParcella();
    });

    document.querySelector('[name="RimborsoSpesePercentuale"]').addEventListener("change", () => {
        calcolaTotaleAvvisoParcella();
    });



    /* fine calcolo */

    // ======================================================
    // 📎 Gestione selezione file (mostra nome file scelto)
    // ======================================================
    function gestisciUploadAvvisoFirmato(input) {
        const file = input.files[0];
        const info = document.getElementById("fileAvvisoSelezionato");

        if (file) {
            info.textContent = `File selezionato: ${file.name}`;
            info.classList.add("text-success");
        } else {
            info.textContent = "";
            info.classList.remove("text-success");
        }
    }

    // ======================================================
    // 📤 Upload PDF Avviso Parcella firmato (invio al Controller)
    // ======================================================
    function gestisciUploadAvvisoFirmato(input) {
        const file = input.files[0];

        if (!file) {
            toastr.warning("⚠️ Seleziona un file PDF da caricare.");
            return;
        }

        // 🔎 Controllo formato
        if (!file.name.toLowerCase().endsWith(".pdf")) {
            toastr.error("❌ Il file deve essere in formato PDF.");
            input.value = "";
            return;
        }

        // Recupera l'ID Avviso dalla modale (presente come campo hidden)
        const idAvviso = document.querySelector("input[name='ID_AvvisoParcelle']").value;

        if (!idAvviso || idAvviso <= 0) {
            toastr.error("❌ Nessun avviso selezionato. Salva prima l'avviso prima di caricare il PDF.");
            input.value = "";
            return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("idAvviso", idAvviso);

        $.ajax({
            url: "/Pratiche/SalvaAvvisoParcellaFirmato",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            beforeSend: function () {
                toastr.info("⏳ Caricamento del PDF in corso...");
            },
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message);

                    // Mostra il nome file e aggiorna la UI
                    $("#fileAvvisoCaricatoContainer").show();
                    $("#nomeFileAvviso").text(file.name);
                    $("#fileAvvisoSelezionato")
                        .html(`<b class='text-success'>✅ ${file.name}</b> caricato correttamente`);

                    // Aggiorna anche i flag nascosti se presenti
                    $("input[name='PercorsoDocumentoEsistente']").val(file.name);
                } else {
                    toastr.error(response.message || "Errore durante il caricamento del file.");
                }
            },
            error: function (xhr) {
                console.error(xhr);
                toastr.error("❌ Errore imprevisto durante l'upload del file.");
            }
        });
    }

    function rimuoviFileAvvisoCaricato(idAvviso) {
        // 🧹 UI reset immediato
        $("#fileAvvisoCaricatoContainer").addClass("d-none").hide();
        $("#nomeFileAvviso").text("");
        $("#hiddenPercorsoAvviso").val("");
        $("#sezioneUploadAvvisoFirmato").show();
        $("#inputFileAvviso").val("");

        // 📤 Chiamata AJAX al server
        $.ajax({
            url: '/Pratiche/EliminaDocumentoAvvisoParcella',
            type: 'POST',
            data: { idAvviso: idAvviso },
            success: function (res) {
                if (res.success) {
                    toastr.success(res.message || "✅ File Avviso Parcella eliminato.");
                } else {
                    toastr.warning(res.message || "⚠️ Errore durante l'eliminazione del file.");
                }
            },
            error: function () {
                toastr.error("❌ Errore di comunicazione con il server.");
            }
        });
    }


    function scaricaAvvisoFirmato() {
        const idAvviso = $('#avvisoForm [name="ID_AvvisoParcelle"]').val();
        if (!idAvviso) {
            toastr.warning("⚠️ Avviso non salvato. Impossibile scaricare il file.");
            return;
        }

        window.open(`/Pratiche/ScaricaAvvisoParcella?idAvviso=${idAvviso}`, '_blank');
    }



    // fine upload


    // gestione tempplate avviso parcella

    // ======================================================
    // 📄 GENERAZIONE E GESTIONE AVVISO PARCELLA
    // ======================================================

    // 🔹 Variabile globale
    let avvisoCorrente = null;

    // ======================================================
    // 🔹 1️⃣ APRE L'ANTEPRIMA AVVISO PARCELLA
    // ======================================================
    function apriAnteprimaAvvisoParcella(idAvviso) {
        fetch(`/Pratiche/GeneraAvvisoParcella?idAvviso=${idAvviso}`)
            .then(r => r.json())
            .then(res => {
                if (!res.success || !res.html) {
                    toastr.error(res.message || "Errore nella generazione dell'avviso parcella.");
                    console.error("❌ Errore GeneraAvvisoParcella:", res.message);
                    return;
                }

                avvisoCorrente = {
                    idAvviso: idAvviso,
                    htmlOriginale: res.html,
                    htmlModificato: res.html
                };

                // 🔹 Scrive l'HTML dell’avviso nella modale
                const contenitore = document.getElementById("contenutoTemplateGenerato");
                contenitore.innerHTML = `
                <div id="anteprimaAvvisoParcella"
                     contenteditable="true"
                     style="border:1px solid #ccc; border-radius:6px; padding:20px; background:#fff;
                            min-height:400px; overflow-y:auto;">
                    ${res.html}
                </div>
            `;

                // 🔹 Aggiorna il titolo modale
                const titolo = document.querySelector("#modaleAnteprimaTemplate .modal-title");
                titolo.textContent = "Anteprima Avviso Parcella";

                // 🔹 Mostra la modale
                const modal = new bootstrap.Modal(document.getElementById("modaleAnteprimaTemplate"));
                modal.show();

                toastr.success("✅ Avviso Parcella generato correttamente.");
            })
            .catch(err => {
                toastr.error("❌ Errore di rete durante la generazione dell'avviso parcella.");
                console.error("🌐 Errore rete/fetch GeneraAvvisoParcella:", err);
            });
    }


    // ======================================================
    // 💾 2️⃣ SALVA AVVISO COME PDF (Rotativa lato server)
    // ======================================================
    function salvaAvvisoComePDF(event) {
        if (!avvisoCorrente || !avvisoCorrente.idAvviso) {
            toastr.warning("⚠️ Nessun avviso selezionato.");
            return;
        }

        const contenuto = document.getElementById("anteprimaAvvisoParcella");
        if (!contenuto) {
            toastr.warning("⚠️ Nessun contenuto trovato nella modale.");
            return;
        }

        const html = contenuto.innerHTML.trim();
        if (!html) {
            toastr.warning("⚠️ Contenuto HTML vuoto, impossibile generare il PDF.");
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        const testoOriginale = btn.innerHTML;
        btn.innerHTML = "Generazione in corso...";

        $.ajax({
            url: "/Pratiche/GeneraPDFAvvisoParcellaDaHtml",
            type: "POST",
            data: { idAvviso: avvisoCorrente.idAvviso, html: html },
            success: function (res) {
                if (res.success) {
                    toastr.success("✅ Avviso Parcella generato e salvato correttamente.");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("modaleAnteprimaTemplate"));
                    if (modal) modal.hide();
                    setTimeout(() => location.reload(), 800);
                } else {
                    toastr.error(res.message || "❌ Errore durante la generazione del PDF.");
                }
            },
            error: function (xhr, status, err) {
                toastr.error("❌ Errore imprevisto durante la generazione del PDF.");
                console.error("Errore AJAX GeneraPDFAvvisoParcellaDaHtml:", err);
            },
            complete: function () {
                btn.disabled = false;
                btn.innerHTML = testoOriginale;
            }
        });
    }


    // fine gestione template avviso parcella


    // 🧭 Attiva tutti i tooltip Bootstrap presenti nella pagina
    document.addEventListener("DOMContentLoaded", function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });


    // 🔍 Filtro e paginazione
    document.addEventListener("DOMContentLoaded", function () {
        // ======================================================
        // 🔍 RICERCA PRATICA PER ID O NOME → AGGIORNA IL SELECT
        // ======================================================
        const cercaPraticaInput = document.getElementById("cercaPraticaInput");
        const selectPratica = document.getElementById("selectPraticaAvviso");

        if (cercaPraticaInput && selectPratica) {
            cercaPraticaInput.addEventListener("input", function () {
                const testo = this.value.trim().toLowerCase();
                if (!testo) return;

                const opzioni = Array.from(selectPratica.options);

                const trovata = opzioni.find(opt => {
                    if (!opt.value) return false;

                    const matchId = opt.value.toString() === testo;
                    const matchTesto = opt.text.toLowerCase().includes(testo);

                    return matchId || matchTesto;
                });

                if (trovata) {
                    selectPratica.value = trovata.value;

                    // 🔥 scatena tutta la logica già esistente
                    selectPratica.dispatchEvent(new Event("change"));
                }
            });
        }
        // ======================================================
        // ⬇️ DA QUI IN POI: IL TUO CODICE GIÀ ESISTENTE FILTRI
        // ====================================================== 
        const table = document.getElementById('avvisiTable');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const cards = document.querySelectorAll('.card-avviso');

        const controlliContainer = document.getElementById('controlliAvvisi');
        const paginationContainer = document.getElementById('paginazioneAvvisi');

        const searchInput = document.createElement('input');
        const selectPageSize = document.createElement('select');
        const selectStato = document.createElement('select');

        let pageSize = 10;
        let currentPage = 1;

        // 🔍 Ricerca
        searchInput.type = 'text';
        searchInput.placeholder = 'Cerca...';
        searchInput.className = 'form-control form-control-sm w-auto';

        // 📄 Page Size
        [10, 25, 50].forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = `${num} per pagina`;
            selectPageSize.appendChild(option);
        });
        selectPageSize.className = 'form-select form-select-sm w-auto';

        // ⚙️ Stato
        ['Tutti', 'In attesa', 'Inviato', 'Pagato'].forEach(stato => {
            const option = document.createElement('option');
            option.value = stato;
            option.textContent = stato;
            selectStato.appendChild(option);
        });
        selectStato.className = 'form-select form-select-sm w-auto';

        // Aggiungi i controlli alla barra
        // Aggiungi i controlli alla barra
        controlliContainer.appendChild(searchInput);

        // 🔽 Wrapper con label "Filtro avvisi"
        const statoWrapper = document.createElement('div');
        statoWrapper.className = 'd-flex align-items-center gap-1';

        const statoLabel = document.createElement('span');
        statoLabel.textContent = 'Filtro avvisi';
        statoLabel.className = 'text-muted small';

        statoWrapper.appendChild(statoLabel);
        statoWrapper.appendChild(selectStato);

        controlliContainer.appendChild(statoWrapper);
        controlliContainer.appendChild(selectPageSize);


        function renderTable() {
            const keyword = searchInput.value.toLowerCase();
            const filtroStato = selectStato.value;

            let filteredRows = rows.filter(row => {
                const text = row.innerText.toLowerCase();
                const statoCell = row.querySelector('td.stato');
                const stato = statoCell ? statoCell.innerText.trim() : '';
                const statoMatch = (filtroStato === 'Tutti' || stato === filtroStato);
                return text.includes(keyword) && statoMatch;
            });

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            currentPage = Math.min(currentPage, totalPages || 1);

            // Tabella desktop
            rows.forEach(r => r.style.display = 'none');
            filteredRows.slice((currentPage - 1) * pageSize, currentPage * pageSize).forEach(r => r.style.display = '');

            // Card mobile
            cards.forEach(c => c.style.display = 'none');
            filteredRows.forEach(row => {
                const id = row.getAttribute('data-id');
                const card = document.querySelector(`.card-avviso[data-id="${id}"]`);
                if (card) card.style.display = '';
            });

            // Paginazione
            paginationContainer.innerHTML = '';
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Pagina ${currentPage} di ${totalPages || 1}`;
            pageInfo.className = 'me-2';
            paginationContainer.appendChild(pageInfo);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '← Indietro';
            prevBtn.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); };
            paginationContainer.appendChild(prevBtn);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Prossima →';
            nextBtn.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); };
            paginationContainer.appendChild(nextBtn);
        }

        // Eventi
        searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
        selectStato.addEventListener('change', () => { currentPage = 1; renderTable(); });
        selectPageSize.addEventListener('change', () => {
            pageSize = parseInt(selectPageSize.value);
            currentPage = 1;
            renderTable();
        });

        renderTable();
    });

</script>
