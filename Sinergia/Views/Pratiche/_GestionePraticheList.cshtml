@model IEnumerable<Sinergia.Models.PraticaViewModel>
@{
    ViewBag.Title = "Gestione Pratiche";
    var tipoUtente = ViewBag.TipoUtente as string;
    var idClienteProfessionista = ViewBag.IDClienteProfessionistaCorrente as int?;
    var nomeProfessionista = ViewBag.NomeProfessionistaCorrente as string ?? "Professionista associato";

    var permessiUtente = ViewBag.Permessi as Sinergia.Models.PermessiViewModel;
    bool puòAggiungere = permessiUtente?.PuòAggiungere == true;
    bool puòModificare = permessiUtente?.PuòModificare == true;
    bool puòEliminare = permessiUtente?.PuòEliminare == true;
    bool mostraAzioni = puòAggiungere || puòModificare || puòEliminare;
}

@using Sinergia.App_Helpers

<!-- Librerie esterne -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


@if (tipoUtente == "Admin" || tipoUtente == "Collaboratore")
{
    <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="fa fa-exclamation-triangle me-2"></i>
        <strong>Attenzione:</strong> per creare o modificare una pratica devi assicurarti di avere selezionato il professionista corretto nel menu in alto.
    </div>
}


<!-- 🔍 Controlli filtro/paginazione -->
<div id="controlliPratiche" class="d-flex flex-wrap align-items-center gap-1 mb-2"></div>

<!-- 📥 Export Pratiche CSV/PDF -->
<div class="d-flex justify-content-end mb-3">
    <form method="get" id="exportPraticheForm"
          class="d-flex flex-wrap flex-md-nowrap gap-2 align-items-center">

        <input type="date" name="da" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.AddMonths(-1).ToString("yyyy-MM-dd")" />

        <input type="date" name="a" class="form-control form-control-sm w-auto"
               value="@DateTime.Today.ToString("yyyy-MM-dd")" />

        <button type="submit" formaction="@Url.Action("EsportaPraticheCsv", "Pratiche")"
                class="btn btn-outline-success btn-sm" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-excel"></i> Excel/CSV
        </button>

        @*<button type="submit" formaction="@Url.Action("EsportaPratichePdf", "Pratiche")"
                class="btn btn-outline-danger btn-sm" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>*@
    </form>
</div>


<!-- ➕ Pulsante nuova pratica -->
<div class="d-flex justify-content-end mb-2">
    @if (puòAggiungere)
    {
        <button class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 1rem; font-size: 0.8rem; line-height: 1.2; height: auto;" onclick="apriNuovaPratica()">
            Nuova Pratica
        </button>
    }
</div>

<!-- 🖥️ TABELLA DESKTOP -->
<div class="d-none d-md-block">
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="praticheTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Titolo</th>
                    @*<th>Tipologia</th>*@
                    <th>Cliente</th>
                    <th>Owner</th>
                    <th>Responsabile</th> <!-- 👈 nuova colonna -->
                    <th>Stato</th>
                    <th>Budget</th>
                    <th>Inizio</th>
                    <th>Fine</th>
                    @if (mostraAzioni)
                    {
                        <th class="text-center">Azioni</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var p in Model)
                {
                    <tr data-id="@p.ID_Pratiche">
                        <td>@p.ID_Pratiche</td>
                        <td>@p.Titolo</td>
                        @*<td>@p.Tipologia</td>*@
                        <td>
                            @if (!string.IsNullOrEmpty(p.ClienteRagioneSociale))
                            {
                                <div>@p.ClienteRagioneSociale</div>
                                <div class="text-muted small">@p.ClienteNomeCompleto</div>
                            }
                            else
                            {
                                <div>@p.ClienteNomeCompleto</div>
                            }
                        </td>

                        <td>@p.NomeOwner</td>
                        <td>@p.NomeUtenteResponsabile</td> <!-- 👈 nuova cella -->
                        <td class="stato">@p.Stato</td>
                        <td class="text-end">@p.Budget.ToString("N2")</td>
                        <td>@(p.DataInizioAttivitaStimata?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td>@(p.DataFineAttivitaStimata?.ToString("dd/MM/yyyy") ?? "-")</td>

                        @if (mostraAzioni)
                        {
                            <td class="text-center">
                                @Html.Partial("~/Views/Pratiche/_AzioniPratica.cshtml", p)
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 📱 CARD VIEW MOBILE -->
<div class="d-block d-md-none mt-3 px-2">
    @foreach (var p in Model)
    {
        <div class="border rounded shadow-sm p-3 mb-3 bg-white card-pratica" data-id="@p.ID_Pratiche">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-primary">@p.Titolo</span>
                <span class="badge bg-@(p.Stato == "Conclusa" ? "success" : p.Stato == "Archiviata" ? "secondary" : "primary")">@p.Stato</span>
            </div>
            <div class="small text-muted"><strong>ID:</strong> @p.ID_Pratiche</div>
            @*<div class="small text-muted"><strong>Tipologia:</strong> @p.Tipologia</div>*@
            <div class="small text-muted">
                <strong>Cliente:</strong>
                @if (!string.IsNullOrEmpty(p.ClienteRagioneSociale))
                {
                    <div>@p.ClienteRagioneSociale</div>
                    <div class="text-muted small">@p.ClienteNomeCompleto</div>
                }
                else
                {
                    <div>@p.ClienteNomeCompleto</div>
                }
            </div>

            <div class="small text-muted"><strong>Owner:</strong> @p.NomeOwner</div>
            <div class="small text-muted"><strong>Responsabile:</strong> @p.NomeUtenteResponsabile</div> <!-- 👈 nuova riga -->
            <div class="small text-muted text-end"><strong>Budget:</strong> @p.Budget.ToString("N2")</div>
            <div class="small text-muted"><strong>Inizio:</strong> @(p.DataInizioAttivitaStimata?.ToString("dd/MM/yyyy") ?? "-")</div>
            <div class="small text-muted"><strong>Fine:</strong> @(p.DataFineAttivitaStimata?.ToString("dd/MM/yyyy") ?? "-")</div>

            @if (mostraAzioni)
            {
                <div class="d-flex flex-wrap gap-2 mt-2">
                    @Html.Partial("~/Views/Pratiche/_AzioniPratica.cshtml", p)
                </div>
            }
        </div>
    }
</div>

<!-- 🔄 Paginazione -->
<div id="paginazionePratiche" class="d-flex justify-content-end align-items-center gap-2 mt-2"></div>


<!-- Modale Nuova/Modifica Pratica -->
<div class="modal fade" id="praticaModal" tabindex="-1" aria-labelledby="praticaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="PraticaForm" enctype="multipart/form-data">
                <input type="hidden" name="ContenutoIncaricoHtml" id="hiddenIncaricoHtml" />

                <div class="modal-header text-black">
                    <h5 class="modal-title" id="praticaModalLabel">Nuova Pratica</h5>
                    <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="ID_Pratiche" id="hiddenIDPratica" />

                    <!-- 🔹 Titolo -->
                    <div class="mb-2">
                        <label class="form-label">Titolo *</label>
                        <input type="text" name="Titolo" class="form-control form-control-sm" required />
                    </div>

                    <!-- 🔹 Cliente, Owner e Responsabile -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">Cliente *</label>

                            <!-- 🔍 Aggiungi campo ricerca -->
                            <input type="text" id="searchCliente" class="form-control form-control-sm mb-1" placeholder="Cerca cliente...">

                            <!-- 🔽 Select clienti -->
                            <select class="form-select form-select-sm" name="ID_Cliente" id="selectCliente" required>
                                <option value="">-- Seleziona cliente --</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Owner (proprietario cliente)</label>
                            <input type="text" class="form-control form-control-sm" id="inputOwnerProfessionista" readonly />
                            <input type="hidden" name="ID_Owner" id="hiddenOwnerProfessionista" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Responsabile Pratica *</label>
                            <select class="form-select form-select-sm" name="ID_UtenteResponsabile" id="selectResponsabile" required>
                                <option value="">-- Seleziona responsabile --</option>
                            </select>
                        </div>
                    </div>

                    <!-- 🔹 Stato, Date -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">Stato *</label>
                            <select name="Stato" class="form-select form-select-sm" required>
                                <option value="">-- Seleziona --</option>
                                <option value="Contrattualizzazione">Contrattualizzazione</option>
                                <option value="Inviata">Inviata</option>
                                <option value="In lavorazione">In lavorazione</option>
                                <option value="Conclusa">Conclusa</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Inizio Attività Stimata</label>
                            <input type="date" name="DataInizioAttivitaStimata" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Fine Attività Stimata</label>
                            <input type="date" name="DataFineAttivitaStimata" class="form-control form-control-sm" />
                        </div>
                    </div>

                    <!-- 🔹 Categoria (Tipologia) e Oggetto -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Categoria *</label>
                            <select class="form-select form-select-sm" name="Tipologia" id="tipologiaSelect" required>
                                <option value="">-- Seleziona categoria --</option>
                                <!-- Popolato via JS -->
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Oggetto della Pratica *</label>
                            <select class="form-select form-select-sm" name="OggettoPratica" id="oggettoPraticaSelect" required>
                                <option value="">-- Seleziona oggetto --</option>
                                <!-- Popolato via JS -->
                            </select>
                        </div>
                    </div>


                    <!-- 🔹 Budget e Note -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">Valore Stimato (€)</label>
                            <input type="text" name="Budget" id="BudgetInput"
                                   class="form-control form-control-sm"
                                   data-submit="true" /> <!-- 👈 tolto readonly -->
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Note</label>
                            <textarea name="Note" class="form-control form-control-sm" style="height: 30px;"></textarea>
                        </div>

                        <div class="col-md-3 d-none" id="boxTrattenutaPersonalizzata">
                            <label class="form-label">Percentuale Trattenuta (%)</label>
                            <input type="number" step="0.01" name="TrattenutaPersonalizzata" class="form-control form-control-sm text-center" />
                        </div>
                    </div>

                    <!-- ⚙️ Tipologia e Metodo di Compenso -->
                    <hr />
                    <h6>⚙️ Tipologia e Metodo di Compenso</h6>
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">Metodo di Compenso *</label>
                            <select name="MetodoCompenso" id="metodoCompensoSelect" class="form-select form-select-sm">
                                <option value="">-- Seleziona --</option>
                                <option value="Fisso">Fisso</option>
                                <option value="A ore">A ore</option>
                                <option value="Giudiziale">Giudiziale</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button"
                                    id="btnGestisciCompensi"
                                    class="btn btn-outline-primary btn-sm ms-2"
                                    onclick="apriCompensoModal($('#hiddenIDPratica').val())"
                                    disabled>
                                ✏️ Gestisci Compensi
                            </button>

                        </div>
                    </div>


                    <!-- Hidden per serializzare le righe compensi -->
                    <div id="hiddenCompensiContainer"></div>

                    <!-- 🔹 Riepilogo Compensi inseriti -->
                    <hr />
                    <h6>💵 Riepilogo Compensi Inseriti</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle" id="riepilogoCompensiTable">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Metodo</th>
                                    <th>Descrizione / Fase / Ruolo</th>
                                    <th>Importo (€)</th>
                                    <th>Tipologia</th>
                                    <th>Unità / Valore stimato</th>
                                    <th>Intestatario</th>
                                    <th class="text-center">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- riempito via JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 🔹 Collaboratori -->
                    <hr />
                    <h6>👥 Utenti Associati</h6>
                    <div id="collaboratoriContainer"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="aggiungiCollaboratore()">+ Aggiungi Collaboratore</button>

                    <!-- 🔹 Pulsanti Costi -->
                    <hr />
                    <h6>💼 Costi</h6>
                    <div class="d-flex gap-2 flex-wrap mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="apriModaleCostiPratica()">Gestione Costi Di Pratica</button>
                    </div>
                    <!-- ✅ Stato caricamento Costi Pratica -->
                    <div class="alert alert-light border d-flex align-items-center justify-content-between px-3 py-2" id="statoCostiCaricati" style="display:none;">
                        <div id="riepilogoCostiIcone"></div>
                        <div>
                            <i class="fas fa-info-circle text-muted me-1"></i>
                            <small id="riepilogoCostiTooltip" class="text-muted" data-bs-toggle="tooltip" title="">Dettagli</small>
                        </div>
                    </div>

                    <div class="mt-3" id="contenitoreIncaricoGenerato" style="display:none;">
                        <h6>📑 Anteprima Incarico da Template</h6>
                        <div class="border rounded p-3 bg-light" id="htmlIncaricoGenerato" style="max-height: 300px; overflow:auto;"></div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="scaricaFoglioIncarico()"> Scarica Incarico</button>
                    </div>

                    <!-- 🔹 Upload incarico firmato -->
                    <div class="mb-2">
                        <label class="form-label">📎 Incarico Firmato (PDF)</label>
                        <input type="file" id="inputFileIncarico" name="IncaricoProfessionale"
                               class="form-control form-control-sm" accept=".pdf" />
                        <div class="mt-2">
                            <strong>File già caricato:</strong>
                            <span id="nomeFileIncarico" class="text-primary"></span>
                            <input type="hidden" name="PercorsoDocumentoEsistente" id="hiddenFileAllegato" />
                        </div>
                        <div class="mt-1 text-muted small" id="fileIncaricoSelezionato"></div>
                        <small class="text-muted">Obbligatorio prima di passare allo stato "In lavorazione".</small>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">💾 Salva</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    </div>

                    <!-- ✅ Hidden inputs generati dinamicamente da modali -->
                    <div id="hiddenCostiPraticaContainer"></div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale Conferma Eliminazione Pratica -->
<div class="modal fade" id="eliminaPraticaModal" tabindex="-1" aria-labelledby="eliminaPraticaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminaPraticaModalLabel">Conferma Eliminazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler eliminare questa pratica?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger" id="btnConfermaEliminazionePratica">Elimina</button>
            </div>
        </div>
    </div>
</div>

<!-- Modale Riattiva Pratica -->
<div class="modal fade" id="riattivaPraticaModal" tabindex="-1" aria-labelledby="riattivaPraticaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="riattivaPraticaModalLabel">Conferma Riattivazione</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler riattivare questa pratica?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" id="btnConfermaRiattivazionePratica">Riattiva</button>
            </div>
        </div>
    </div>
</div>

<!-- Modale Gestione Documenti -->
<div class="modal fade" id="documentiModal" tabindex="-1" aria-labelledby="documentiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="documentiModalLabel">Documenti Incarico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body" id="contenutoDocumenti">
                <!-- I documenti saranno caricati qui dinamicamente -->
            </div>
        </div>
    </div>
</div>

@* questa modale si attiva nel caso nel db non ce un utente e permette la registrazione  *@

<!-- Modale Creazione Utente -->
<div class="modal fade" id="creaUtenteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="CreaUtenteForm">
                <div class="modal-header  text-black">
                    <h5 class="modal-title">Nuovo Utente Responsabile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label>Nome *</label>
                        <input type="text" name="Nome" class="form-control form-control-sm" required />
                    </div>
                    <div class="mb-2">
                        <label>Cognome *</label>
                        <input type="text" name="Cognome" class="form-control form-control-sm" required />
                    </div>
                    <div class="mb-2">
                        <label>Email</label>
                        <input type="email" name="MAIL1" class="form-control form-control-sm" />
                    </div>
                    <div class="mb-2">
                        <label>Tipo Utente *</label>
                        <select name="TipoUtente" class="form-select form-select-sm" required>
                            <option value="Collaboratore">Collaboratore</option>
                            <option value="Partner">Partner</option>
                            <option value="Professionista">Professionista</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-success btn-sm">Crea Utente</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modale per completare dati cliente -->
<div class="modal fade" id="modaleCompletaCliente" tabindex="-1" aria-labelledby="modaleCompletaClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="CompletaClienteForm">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modaleCompletaClienteLabel">Completa Anagrafica Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="ID_Cliente" />

                    <div class="mb-2">
                        <label for="PIVA" class="form-label">Partita IVA *</label>
                        <input type="text" name="PIVA" class="form-control form-control-sm" required />
                    </div>

                    <div class="mb-2">
                        <label for="CodiceFiscale" class="form-label">Codice Fiscale</label>
                        <input type="text" name="CodiceFiscale" class="form-control form-control-sm" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary btn-sm">Salva e Continua</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale: Aggiungi Utenti Associati -->
<div class="modal fade" id="modaleUtentiAssociati" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleziona Utenti da Associare</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 30px;">Seleziona</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Ruolo</th>
                            </tr>
                        </thead>
                        <tbody id="utentiDisponibiliContainer">
                            <!-- Popolato via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="aggiungiUtentiSelezionati()">Aggiungi</button>
            </div>
        </div>
    </div>
</div>


<!-- 🔘 Modale Movimento Bancario -->
<div class="modal fade" id="movimentoBancarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="MovimentoBancarioForm">
                <div class="modal-header">
                    <h5 class="modal-title">Movimento Bancario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-1">
                        <div class="col-md-6 mb-1">
                            <label class="form-label form-label-sm">Data Movimento</label>
                            <input type="date" name="DataMovimentoBancario" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-6 mb-1">
                            <label class="form-label form-label-sm">Metodo di Pagamento *</label>
                            <select name="MetodoDiPagamento" class="form-select form-select-sm" required>
                                <option value="">-- Seleziona --</option>
                                <option value="Bonifico">Bonifico</option>
                                <option value="Contanti">Contanti</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-1">
                            <label class="form-label form-label-sm">Importo</label>
                            <input type="number" name="ImportoMovimento" step="0.01" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-6 mb-1">
                            <label class="form-label form-label-sm">Tipo Movimento</label>
                            <select name="TipoMovimentoBancario" class="form-select form-select-sm">
                                <option value="Entrata">Entrata</option>
                                <option value="Uscita">Uscita</option>
                            </select>
                        </div>
                        <div class="col-12 mb-1">
                            <label class="form-label form-label-sm">Descrizione</label>
                            <textarea name="DescrizioneMovimento" rows="1" class="form-control form-control-sm"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Campo nascosto per utenti associati -->
                <div id="utentiAssociatiHiddenContainer"></div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="salvaPratica()">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>


@* 🧾 MODALE COSTI DELLA PRATICA *@
<div class="modal fade" id="modaleCostiPratica" tabindex="-1" aria-labelledby="modaleCostiPraticaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light border-bottom">
                <h5 class="modal-title">
                    <i class="bi bi-cash-stack me-1"></i> Costi della Pratica
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>

            <div class="modal-body">
                <div id="costiPraticaContainer" class="mb-3"></div>

                <button type="button" class="btn btn-outline-primary btn-sm" onclick="aggiungiCostoPratica()">
                    <i class="bi bi-plus-circle"></i> Aggiungi Costo Pratica
                </button>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="salvaCostiPratica()">
                    <i class="bi bi-save"></i> Salva
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Chiudi
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 🔹 Modale per anteprima Template -->
<div class="modal fade" id="modaleAnteprimaTemplate" tabindex="-1"
     aria-labelledby="modaleAnteprimaTemplateLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg">

            <!-- 🔸 Header -->
            <div class="modal-header bg-light">
                <input type="hidden" name="ID_Pratiche" />
                <h5 class="modal-title fw-bold text-primary" id="titoloTemplate">
                    Anteprima Incarico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>

            <!-- 🔸 Corpo modale -->
            <div class="modal-body bg-white">
                <div id="contenutoTemplateGenerato"
                     contenteditable="true"
                     style="border: 1px solid #ccc; padding: 20px; min-height: 400px; background-color: #fff; border-radius: 6px; overflow-y: auto;">
                </div>
            </div>

            <!-- 🔸 Footer -->
            <div class="modal-footer d-flex justify-content-between align-items-center">

                <!-- 🔹 Navigazione tra template -->
                <div class="d-flex align-items-center">
                    <button id="btnIndietro" class="btn btn-outline-secondary me-2" onclick="indietroTemplate()">← Indietro</button>
                    <button id="btnAvanti" class="btn btn-outline-primary me-2" onclick="avantiTemplate()">Avanti →</button>
                    <span id="templateCounter" class="text-muted small"></span>
                </div>

                <!-- 🔹 Azioni finali -->
                <div>
                    <button class="btn btn-primary me-2" onclick="stampaContenuto()">Stampa</button>
                    <button class="btn btn-success me-2" onclick="salvaComePDF()">Salva come PDF</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>

        </div>
    </div>
</div>


@* Modale Compenso dettaglio  *@

<div class="modal fade" id="compensoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="compensoModalTitle">Gestione Compensi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Campi aggiuntivi dinamici -->
                <div id="campiAggiuntivi"></div>

                <!-- Tabella righe dinamica -->
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-bordered" id="tabellaCompensi">
                        <thead>
                            <tr id="tabellaCompensiHeader"></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="aggiungiRigaCompenso()">+ Aggiungi Riga</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="salvaCompensi()">💾 Salva Compensi</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

@* Gestione Template definitiva  *@
<div class="modal fade" id="modaleAnteprimaTemplate" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Anteprima Incarico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contenutoTemplateGenerato" class="p-3"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>



<script>

    let utentiAssociati = [];
    let indiceCollaboratore = 0;
    let indiceCostoPratica = 0;

    // ⭐ Archivio unico dei compensi in sessione pratica
    window.CompensiCorrenti = [];


    function apriNuovaPratica() {
        $('#PraticaForm')[0].reset();
        $('#praticaModalLabel').text('Nuova Pratica');

        // 🧹 Reset contenitori dinamici
        $('#collaboratoriContainer').empty();
        $('#compensoContainer').empty();
        $('#modaleCostiPraticaBody').empty();

        // 🧹 Reset compensi
        $('#hiddenCompensiContainer').html('');
        $('#riepilogoCompensiTable tbody').html('');

        // 🧹 Reset file incarico
        $('#inputFileIncarico').val("");
        $('#nomeFileIncarico').text("");
        $('#hiddenFileAllegato').val("");

        indiceCollaboratore = 0;
        indiceCostoPratica = 0;

        // Reset responsabile
        $('#selectResponsabile').html('<option value="">-- Seleziona responsabile --</option>');
        $('[name="Stato"]').val("Contrattualizzazione");

        // 🟦 1️⃣ CARICA CATEGORIE PRATICHE (Tipologia)
        fetch("/Pratiche/GetCategoriePratiche")
            .then(r => r.json())
            .then(categorie => {
                const ddl = document.getElementById("tipologiaSelect");
                ddl.innerHTML = '<option value="">-- Seleziona tipologia --</option>';

                categorie.forEach(cat => {
                    ddl.innerHTML += `<option value="${cat.value}">${cat.text}</option>`;
                });
            })
            .catch(() => console.error("Errore caricamento categorie pratiche"));


        // 🟦 1B — CARICA OGGETTI DELLA PRATICA (lista fissa)
        const ddlOggetto = document.getElementById("oggettoPraticaSelect");
        ddlOggetto.innerHTML = '<option value="">-- Seleziona oggetto --</option>';

        OGGETTI_PRATICA.forEach(o => {
            ddlOggetto.innerHTML += `<option value="${o}">${o}</option>`;
        });


        // 🟦 2️⃣ CARICA CLIENTI
        caricaClienti().then(() => {
            const primoClienteID = $('#selectCliente').val();

            if (primoClienteID && parseInt(primoClienteID) > 0) {
                caricaResponsabiliCliente(primoClienteID);
            }

            caricaUtentiAssociabili(primoClienteID);

            fetch(`/Pratiche/GetUtentiAttivi${primoClienteID ? `?idCliente=${primoClienteID}` : ''}`)
                .then(r => r.json())
                .then(data => {
                    window.intestatariGlobali = Array.isArray(data) ? data : [];
                    aggiornaIntestatariDisponibili();
                })
                .catch(err => {
                    console.error("❌ Errore intestatari nuova pratica:", err);
                    window.intestatariGlobali = [];
                    aggiornaIntestatariDisponibili();
                });
        });

        $('#tabellaCompensi tbody').html('');

        // 🔥 Mostra modale SOLO dopo avere popolato tutto
        new bootstrap.Modal(document.getElementById('praticaModal')).show();
    }




     // Imposta la variabile JS globale da backend
    window.ID_UtenteAttivo = @UserManager.GetIDUtenteAttivo();

    async function apriModificaPratica(id) {
        if (!window.ID_UtenteAttivo || window.ID_UtenteAttivo <= 0) {
            toastr.warning("⚠️ Devi impersonificare il professionista della pratica per modificarla.");
            return;
        }

        try {
            // 1️⃣ Prendi i dati della pratica
            const response = await fetch(`/Pratiche/GetPratica?id=${id}`);
            const pratica = await response.json();

            if (!pratica || !pratica.success) {
                toastr.error("Errore caricamento dati pratica");
                return;
            }

            // 🟦 1B — CARICA LE CATEGORIE (Tipologia)
            await fetch("/Pratiche/GetCategoriePratiche")
                .then(r => r.json())
                .then(categorie => {
                    const ddl = document.getElementById("tipologiaSelect");
                    ddl.innerHTML = '<option value="">-- Seleziona tipologia --</option>';

                    categorie.forEach(cat => {
                        ddl.innerHTML += `<option value="${cat.value}">${cat.text}</option>`;
                    });
                });

            // 🟦 1C — CARICA GLI OGGETTI PRATICA (lista fissa)
            const ddlOggetto = document.getElementById("oggettoPraticaSelect");
            ddlOggetto.innerHTML = '<option value="">-- Seleziona oggetto --</option>';

            OGGETTI_PRATICA.forEach(o => {
                ddlOggetto.innerHTML += `<option value="${o}">${o}</option>`;
            });

            // 2️⃣ Imposta professione per costi
            window.IDProfessioneCorrente = pratica.data.ID_Professione || pratica.data.ID_ProfessionistaOwner;

            // 3️⃣ Clienti
            await caricaClienti();
            $('[name="ID_Cliente"]').val(pratica.data.ID_Cliente);

            // 4️⃣ Owner (cliente → fisso)
            $('#inputOwnerProfessionista').val(pratica.nomeOwner || '');
            $('#hiddenOwnerProfessionista').val(pratica.data.ID_Owner || '');

            // 5️⃣ Responsabile pratica
            await caricaResponsabiliCliente(pratica.data.ID_Cliente);
            $('#selectResponsabile').val(pratica.data.ID_UtenteResponsabile || '');

            // 6️⃣ Campi base
            $('[name="ID_Pratiche"]').val(pratica.data.ID_Pratiche);
            $('[name="Titolo"]').val(pratica.data.Titolo);
            $('[name="Note"]').val(pratica.data.Note);

            // Budget
            if (pratica.data.Budget != null) {
                let valoreBudget = pratica.data.Budget.toString().replace(',', '.');
                valoreBudget = parseFloat(valoreBudget) || 0;
                $('#BudgetInput').val(valoreBudget.toFixed(2).replace('.', ','));
            } else {
                $('#BudgetInput').val("0,00");
            }

            // Trattenuta personalizzata
            const campoTrattenuta = document.querySelector('[name="TrattenutaPersonalizzata"]');
            if (campoTrattenuta) {
                campoTrattenuta.value = pratica.data.TrattenutaPersonalizzata ?? '';
            }

            $('[name="DataInizioAttivitaStimata"]').val(parseDotNetDate(pratica.data.DataInizioAttivitaStimata));
            $('[name="DataFineAttivitaStimata"]').val(parseDotNetDate(pratica.data.DataFineAttivitaStimata));
            $('[name="Stato"]').val(pratica.data.Stato);

            // Tipologia pratica
            $('#tipologiaSelect').val(pratica.data.Tipologia || '').trigger("change");

            // Oggetto pratica
            $('#oggettoPraticaSelect').val(pratica.data.OggettoPratica || '').trigger("change");

            // 7️⃣ COMPENSI — VERSIONE CORRETTA
            $('#hiddenCompensiContainer').html('');
            $('#riepilogoCompensiTable tbody').html('');

            // Reset archivio compensi corrente
            window.CompensiCorrenti = [];

            try {
                const respCompensi = await fetch(`/Pratiche/GetCompensiPratica?idPratica=${id}`);
                const jsonCompensi = await respCompensi.json();

                if (jsonCompensi && jsonCompensi.success && Array.isArray(jsonCompensi.raw)) {

                    // 🔥 1) Copia TUTTO in memoria JS
                    window.CompensiCorrenti = JSON.parse(JSON.stringify(jsonCompensi.raw));

                    // 🔥 2) Rigenera hidden in maniera sicura
                    $('#hiddenCompensiContainer').html(
                        `<input type="hidden" name="CompensiJSON" value="${encodeURIComponent(JSON.stringify(window.CompensiCorrenti))}">`
                    );

                    // 🔥 3) Popola riepilogo
                    popolaRiepilogoCompensi(window.CompensiCorrenti);

                    // 🔥 4) Budget automatico
                    if (!pratica.data.Budget || parseFloat(pratica.data.Budget) === 0) {
                        try {
                            aggiornaValoreStimato(window.CompensiCorrenti);
                        } catch (err) { }
                    }
                }
            } catch (err) {
                console.error("❌ Errore caricamento compensi:", err);
            }


            // 8️⃣ Collaboratori
            let idsCollaboratori = [];
            if (Array.isArray(pratica.utentiAssociati)) {
                idsCollaboratori = pratica.utentiAssociati.map(u => u.ID_Utente);
            }

            await caricaUtentiAssociabili(pratica.data.ID_Owner, idsCollaboratori);

            utentiAssociati = pratica.utentiAssociati.map(u => ({
                ID: u.ID_Utente,
                Nome: u.Nome,
                Percentuale: u.PercentualePrevisione || ''
            }));
            aggiornaListaUtentiAssociati();
            indiceCollaboratore = utentiAssociati.length;

            aggiornaIntestatariDisponibili();

            // 9️⃣ Costi pratica
            const containerPratica = document.getElementById('costiPraticaContainer');
            containerPratica.innerHTML = "";
            costiPraticaCorrenti = [];

            if (Array.isArray(pratica.costi)) {
                pratica.costi.forEach((costo, index) => {
                    aggiungiCostoPratica(costo.ID_AnagraficaCosto, costo.Importo, costo.ID_Fornitore);

                    const riga = containerPratica.querySelectorAll('.riga-costo-pratica')[index];
                    const selectCosto = riga.querySelector('.select-costo-pratica');
                    const inputImporto = riga.querySelector('input[type="number"]');
                    const selectFornitore = riga.querySelector('.select-fornitore-pratica');

                    setTimeout(() => {
                        selectCosto.value = costo.ID_AnagraficaCosto?.toString() || "";
                        if (costo.ID_Fornitore) selectFornitore.value = costo.ID_Fornitore.toString();
                    }, 0);

                    inputImporto.value = costo.Importo;

                    costiPraticaCorrenti.push({
                        ID_AnagraficaCosto: costo.ID_AnagraficaCosto,
                        Descrizione: costo.Descrizione || "Voce senza nome",
                        Importo: costo.Importo,
                        ID_Fornitore: costo.ID_Fornitore || null,
                        NomeFornitore: costo.NomeFornitore || ""
                    });
                });
            }

            rigeneraHiddenCostiPratica();
            aggiornaStatoCostiCaricati();

            // 🔟 Incarico PDF / HTML
            if (pratica.incarico) {
                $('#nomeFileIncarico').html(
                    `📂 <a href="/Pratiche/DownloadDocumentoPratica?idDocumento=${pratica.incarico.ID_Documento}" target="_blank">${pratica.incarico.NomeFile}</a>`
                );
                $('#hiddenFileAllegato').val(pratica.incarico.ID_Documento);
            } else {
                $('#nomeFileIncarico').html('<span class="text-muted">Nessun file caricato</span>');
                $('#hiddenFileAllegato').val('');
            }

            // 🔥 Mostra modale
            $('#praticaModalLabel').text('Modifica Pratica');
            new bootstrap.Modal(document.getElementById('praticaModal')).show();

        } catch (err) {
            console.error("Errore fetch pratica:", err);
            toastr.error("Errore nella richiesta.");
        }
    }



    const OGGETTI_PRATICA = [
        "Diritti Reali",
        "Amministrativo",
        "Civile",
        "Comunione e condominio",
        "Contratti",
        "Crisi d’impresa",
        "Diritti della personalità",
        "Donazioni",
        "Famiglia",
        "Lavoro",
        "Locazioni",
        "M&A",
        "Compliance",
        "Penale",
        "RC Generale",
        "RC Obbligatoria",
        "RC Professionale",
        "RC Sanitaria",
        "Recupero crediti",
        "Società",
        "Successioni",
        "Contenzioso Tributario",
        "Contabilità e bilanci",
        "Revisione dei conti",
        "Paghe e contributi",
        "Medicina Legale",
        "Impianti",
        "Asseverazioni Ingegneristiche",
        "Pratiche Ingegneria",
        "Previdenza e assistenza",
        "Start Up",
        "Business Plan",
        "Proprietà intellettuale e industriale"
    ];


    function aggiungiCollaboratore(idUtente = "", percentuale = "") {
        const container = document.getElementById('collaboratoriContainer');

        const row = document.createElement('div');
        row.className = 'row align-items-center mb-2 collaboratore-row';
        row.innerHTML = `
        <div class="col-md-6">
            <select name="UtentiAssociati[${indiceCollaboratore}].ID_Utente" class="form-select form-select-sm">
                <option value="">-- Seleziona professionista --</option>
                ${window.listaUtenti || ''}
            </select>
        </div>
        <div class="col-md-4">
            <div class="input-group input-group-sm">
                <input type="text"
                       name="UtentiAssociati[${indiceCollaboratore}].PercentualePrevisione"
                       class="form-control percentuale-input"
                       value="${percentuale || ''}"
                       placeholder="es. 33,33"
                       oninput="this.value=this.value.replace(/[^0-9,\\.]/g,'')">
                <span class="input-group-text">%</span>
            </div>
        </div>
        <div class="col-md-2 text-end">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.collaboratore-row').remove()">✕</button>
        </div>
    `;

        container.appendChild(row);
        indiceCollaboratore++;
    }


    function parseDotNetDate(jsonDate) {
        const match = /\/Date\((\d+)\)\//.exec(jsonDate);
        if (!match) return '';
        const date = new Date(parseInt(match[1]));
        return date.toISOString().split('T')[0]; // "yyyy-MM-dd"
    }

    function apriModaleUtentiAssociati(idCliente) {
        fetch(`/Pratiche/GetUtentiAttivi?idCliente=${idCliente}`)
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('utentiDisponibiliContainer');
                tbody.innerHTML = '';

                data.forEach(utente => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td><input type="checkbox" class="form-check-input" value="${utente.ID_Utente}" data-nome="${utente.NomeCompleto}"></td>
                    <td>${utente.NomeCompleto}</td>
                    <td>${utente.Email || '-'}</td>
                    <td>${utente.Ruolo || '-'}</td>
                `;
                    tbody.appendChild(tr);
                });

                new bootstrap.Modal(document.getElementById('modaleUtentiAssociati')).show();
            })
            .catch(err => {
                console.error("Errore caricamento utenti:", err);
                toastr.error("Errore durante il caricamento utenti.");
            });
    }

    function caricaUtentiAssociabili(idCliente, utentiDaEscludere = []) {
        // 🔹 Costruisco la URL: se idCliente non valido, chiamo senza parametro
        let url = "/Pratiche/GetUtentiAttivi";
        if (idCliente && parseInt(idCliente) > 0) {
            url += `?idCliente=${idCliente}`;
        }

        return fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Risposta non valida dal server");
                return response.json();
            })
            .then(data => {
                if (Array.isArray(data)) {
                    const esclusi = new Set(utentiDaEscludere);

                    const utentiFiltrati = data.filter(u => !esclusi.has(u.ID_Utente));

                    window.listaUtenti = utentiFiltrati.map(u =>
                        `<option value="${u.ID_Utente}">${u.NomeCompleto}</option>`
                    ).join('');
                } else {
                    console.warn("⚠️ Nessun utente associabile ricevuto dal backend");
                    window.listaUtenti = '';
                }
            })
            .catch(err => {
                console.error("Errore nel caricamento utenti associabili:", err);
                toastr.error("Errore nel caricamento utenti.");
                window.listaUtenti = '';
            });
    }


    function aggiornaListaUtentiAssociati() {
        const container = document.getElementById("collaboratoriContainer");
        container.innerHTML = "";

        if (!utentiAssociati || utentiAssociati.length === 0) {
            container.innerHTML = "<div class='text-muted'>Nessun utente associato</div>";
            return;
        }

        utentiAssociati.forEach((u, i) => {
            const div = document.createElement("div");
            div.className = "row align-items-center mb-2 collaboratore-row";

            div.innerHTML = `
            <div class="col-md-6">
                <input type="text"
                       class="form-control form-control-sm"
                       value="${u.Nome}"
                       readonly />
                <input type="hidden" name="UtentiAssociati[${i}].ID_Utente" value="${u.ID}" />
            </div>
            <div class="col-md-4">
                <div class="input-group input-group-sm">
                    <input type="text"
                           name="UtentiAssociati[${i}].PercentualePrevisione"
                           class="form-control percentuale-input"
                           placeholder="es. 33,33"
                           oninput="this.value=this.value.replace(/[^0-9,\\.]/g,'')"
                           value="${(u.Percentuale || '').toString().replace('.', ',')}" />
                    <span class="input-group-text">%</span>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-sm btn-danger" onclick="rimuoviUtenteAssociato(${i})">✕</button>
            </div>
        `;

            container.appendChild(div);
        });
    }

    function rimuoviUtenteAssociato(indice) {
        utentiAssociati.splice(indice, 1);
        aggiornaListaUtentiAssociati();
    }
    function caricaClienti() {
        return fetch('/Pratiche/GetClientiAttivi')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('selectCliente');
                select.innerHTML = '<option value="">-- Seleziona cliente --</option>';

                // ✅ Ordina per cognome poi nome (suddividendo il campo Nome)
                data.sort((a, b) => {
                    const [aCognome, aNome] = a.Nome.split(' ');
                    const [bCognome, bNome] = b.Nome.split(' ');

                    // confronto case-insensitive
                    const cognomeComp = (aCognome || '').localeCompare(bCognome || '', 'it', { sensitivity: 'base' });
                    if (cognomeComp !== 0) return cognomeComp;

                    return (aNome || '').localeCompare(bNome || '', 'it', { sensitivity: 'base' });
                });

                // ✅ Popola la select
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.ID_Cliente;
                    opt.textContent = c.Nome;
                    select.appendChild(opt);
                });

                return true;
            })
            .catch(err => {
                console.error("❌ Errore caricamento clienti:", err);
                toastr.error("Errore nel caricamento della lista clienti.");
            });
    }

    //  barra di ricerca carica clienti
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById('searchCliente');
        const select = document.getElementById('selectCliente');

        if (input && select) {
            input.addEventListener('keyup', function () {
                const filtro = this.value.toLowerCase();
                const opzioni = select.querySelectorAll('option');

                opzioni.forEach(opt => {
                    if (opt.value === "" || opt.text.toLowerCase().includes(filtro)) {
                        opt.style.display = '';
                    } else {
                        opt.style.display = 'none';
                    }
                });
            });
        }
    });



    // salvataggio modali crea e modifica
    $('#PraticaForm').on('submit', function (e) {
        e.preventDefault();

        const form = this;

        // 👇 forza l'inclusione anche dei campi readonly con data-submit="true"
        document.querySelectorAll('[data-submit="true"]').forEach(el => {
            el.removeAttribute('readonly'); // momentaneamente lo tolgo
        });

        const formData = new FormData(form);

        // 📌 1. Controllo stato "In lavorazione" → serve incarico
        const stato = formData.get("Stato");
        const fileIncarico = document.getElementById('inputFileIncarico')?.files[0];
        const incaricoEsistente = document.getElementById('hiddenFileAllegato')?.value?.trim() || "";

        if (stato === "In lavorazione" && !fileIncarico && !incaricoEsistente) {
            toastr.warning("⚠️ Devi caricare un incarico firmato prima di passare allo stato 'In lavorazione'.");
            return; // blocca il submit
        }

        // 📌 2. Compensi JSON cumulativi (hidden) + ricalcolo budget
        const hiddenCompensi = document.querySelector('#hiddenCompensiContainer input[name="CompensiJSON"]');
        if (hiddenCompensi) {
            let compensi = [];
            try {
                compensi = JSON.parse(decodeURIComponent(hiddenCompensi.value || "[]"));
            } catch (err) {
                console.warn("⚠️ Errore nel parse di CompensiJSON:", err, hiddenCompensi.value);
                compensi = [];
            }

            formData.set("CompensiJSON", JSON.stringify(compensi));

            const idPraticaCorrente = formData.get("ID_Pratiche");
            const compensiOriginali = window.compensiOriginaliJSON ? JSON.stringify(window.compensiOriginaliJSON) : null;
            const compensiAttuali = JSON.stringify(compensi);

            // ✅ Calcolo budget SOLO in creazione o se i compensi cambiano davvero
            if (!idPraticaCorrente || parseInt(idPraticaCorrente) === 0 || compensiOriginali !== compensiAttuali) {
                if (compensi.length > 0) {
                    try {
                        aggiornaValoreStimato(compensi);
                    } catch (err) {
                        console.warn("⚠️ Errore calcolo budget:", err);
                    }
                } else {
                    console.log("💡 Nessun compenso trovato: mantengo budget invariato");
                }
            } else {
                console.log("💡 Nessuna variazione compensi: budget invariato");
            }
        }

        // 📌 3. Trattenuta personalizzata
        const inputTrattenuta = document.querySelector('[name="TrattenutaPersonalizzata"]');
        if (inputTrattenuta) {
            formData.set("TrattenutaPersonalizzata", inputTrattenuta.value);
        }
        // 📌 4. Documento incarico firmato (PDF)
        const fileIncaricoInput = document.getElementById('inputFileIncarico');
        if (fileIncaricoInput && fileIncaricoInput.files.length > 0) {
            formData.append("DocumentoIncarico", fileIncaricoInput.files[0]);
        } else if (document.getElementById('hiddenFileAllegato')?.value) {
            // Se c'è già un file salvato, lo includo per non perderlo
            formData.set("PercorsoDocumentoEsistente", document.getElementById('hiddenFileAllegato').value);
        }

        // 📍 3.1 NORMALIZZA percentuali collaboratori (33,33 → 33.33)
        document.querySelectorAll('input[name*="PercentualePrevisione"]').forEach(input => {
            let val = input.value.trim();
            val = val.replace('%', '').replace(/\s+/g, ''); // rimuove simboli e spazi
            val = val.replace(',', '.'); // converte la virgola in punto
            let num = parseFloat(val);
            if (isNaN(num)) num = 0;
            formData.set(input.name, num);
            console.log(`🔹 Percentuale normalizzata [${input.name}] = ${num}`);
        });


        // 📌 5. Metodo di compenso (solo in creazione pratica)
        const idPratica = formData.get("ID_Pratiche");
        const valoreMetodoCompenso = document.querySelector('[name="MetodoCompenso"]')?.value;

        if (!idPratica || parseInt(idPratica) === 0) {
            if (!valoreMetodoCompenso) {
                toastr.warning("⚠️ Devi selezionare un metodo di compenso.");
                return; // blocca il submit lato client
            }
            formData.set("MetodoCompenso", valoreMetodoCompenso);
        }

        // 📌 6. Budget → ora sicuro aggiornato
        const inputBudget = document.querySelector('[name="Budget"]');
        if (inputBudget) {
            let valore = inputBudget.value || "0";
            valore = valore.replace('.', ','); // 🔹 forza formato italiano
            formData.set("Budget", valore);
            console.log("💰 Budget inviato normalizzato:", valore); // debug
        }

        // 📌 7. Oggetto Pratica (nuovo campo)
        const oggettoPraticaValue = document.querySelector('[name="OggettoPratica"]')?.value || "";
        formData.set("OggettoPratica", oggettoPraticaValue);
        console.log("📌 OggettoPratica inviato:", oggettoPraticaValue);


        // 🔎 Debug rapido
        console.log("📤 Dati inviati:", Array.from(formData.entries()));

        // 📤 Invio
        const url = idPratica && parseInt(idPratica) > 0
            ? '/Pratiche/ModificaPratica'
            : '/Pratiche/CreaPratica';

        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    $('#praticaModal').modal('hide');
                    setTimeout(() => {
                        location.reload(); // ✅ Ricarica la pagina dopo 1s
                    }, 1000);
                } else {
                    toastr.error(res.message || "Errore durante il salvataggio.");
                    if (res.dettagli) console.warn("Dettagli:", res.dettagli);
                }
            })
            .catch(err => {
                console.error("Errore salvataggio pratica:", err);
                toastr.error("Errore imprevisto durante il salvataggio.");
            })
            .finally(() => {
                // 👇 ripristino il readonly
                document.querySelectorAll('[data-submit="true"]').forEach(el => {
                    el.setAttribute('readonly', true);
                });
            });
    });

    // Mostra il nome del file selezionato
    document.getElementById("inputFileIncarico")?.addEventListener("change", function () {
        const fileIncaricoSelezionato = document.getElementById("fileIncaricoSelezionato");
        if (this.files && this.files.length > 0) {
            fileIncaricoSelezionato.textContent = "📂 File selezionato: " + this.files[0].name;
        } else {
            fileIncaricoSelezionato.textContent = "";
        }
    });


    // 🔵 SALVA (modale movimenti bancari )
    function salvaPratica() {
        const form = document.getElementById('PraticaForm');
        const formData = new FormData(form);
        appendiCostiPracticeAlForm(formData);

        // Gli utenti associati sono già inclusi con input type="hidden" nel form

        // Debug (opzionale)
        console.log("=== Dati inviati ===");
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        console.log("====================");

        const idPratica = formData.get('ID_Pratiche');
        const url = idPratica && idPratica !== "0" && idPratica !== "" ? '/Pratiche/ModificaPratica' : '/Pratiche/CreaPratica';

        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    location.reload();
                } else if (res.richiedeDatiCliente) {
                    $('#modaleCompletaCliente input[name="PIVA"]').val(res.cliente.PIVA || "");
                    $('#modaleCompletaCliente input[name="CodiceFiscale"]').val(res.cliente.CodiceFiscale || "");
                    $('#modaleCompletaCliente input[name="ID_Cliente"]').val(res.cliente.ID_Cliente);
                    $('#modaleCompletaCliente').modal('show');
                } else {
                    toastr.error(res.message);
                }
            })
            .catch(err => {
                console.error("Errore:", err);
                toastr.error("Errore durante il salvataggio.");
            });
    }


    // 🔵 APRI MODALE ELIMINA PRATICA
    function apriEliminaPratica(id) {
        const btnConferma = document.getElementById('btnConfermaEliminazionePratica');
        btnConferma.onclick = function () {
            eliminaPratica(id);
        };
        new bootstrap.Modal(document.getElementById('eliminaPraticaModal')).show();
    }

    function eliminaPratica(id) {
        fetch('/Pratiche/EliminaPratica', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ id: id })
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);

                    // ✅ Chiude la modale di conferma
                    const modal = bootstrap.Modal.getInstance(document.getElementById('eliminaPraticaModal'));
                    if (modal) modal.hide();

                    // 🔄 Cerca la riga della pratica nella tabella
                    const rows = document.querySelectorAll("#praticheTable tbody tr");
                    rows.forEach(row => {
                        const cellId = row.cells[0]?.textContent?.trim();
                        if (cellId == id.toString()) {
                            // 🟡 Aggiorna stato → "Inattiva"
                            const statoCell = [...row.cells].find(c => c.dataset && c.dataset.stato === "pratica");
                            if (statoCell) {
                                statoCell.textContent = "Inattiva";
                                statoCell.classList.remove("text-success");
                                statoCell.classList.add("text-muted");
                            } else {
                                // fallback se non usa data-stato
                                row.cells[5].textContent = "Inattiva";
                            }

                            // 🟢 Azioni → Recupera
                            const azioniCell = [...row.cells].find(c => c.dataset && c.dataset.azioni === "pratica");
                            const cell = azioniCell || row.cells[6]; // fallback

                            cell.innerHTML = `
                       <div class="d-flex gap-1 justify-content-center">
                           <button class="btn btn-success btn-sm" onclick="recuperaPratica(${id})" title="Recupera">
                               <i class="fa fa-reply"></i>
                           </button>
                       </div>
                   `;
                        }
                    });

                    // ✅ Aggiorna l'intera lista pratiche dopo qualche secondo (opzionale con delay)
                    setTimeout(() => location.reload(), 1000);

                } else {
                    toastr.error(res.message);
                }
            })
            .catch(err => {
                console.error("Errore:", err);
                toastr.error("Errore durante l'eliminazione.");
            });
    }

    function riattivaPratica(id) {
        Swal.fire({
            title: 'Sei sicuro?',
            text: "Vuoi riattivare questa pratica?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sì, riattiva!',
            cancelButtonText: 'Annulla'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/Pratiche/RiattivaPratica', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ id: id })
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            Swal.fire('Riattivata!', res.message, 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Errore!', res.message, 'error');
                        }
                    })
                    .catch(err => {
                        console.error("Errore:", err);
                        Swal.fire('Errore!', 'Errore durante la riattivazione.', 'error');
                    });
            }
        });
    }

    // 🔵 GESTISCI DOCUMENTI PRATICA
    function gestisciDocumenti(idPratica) {
        fetch(`/Pratiche/GetDocumentiPratica?idPratica=${idPratica}`)
            .then(r => r.text())
            .then(html => {
                document.getElementById('contenutoDocumenti').innerHTML = html;
                new bootstrap.Modal(document.getElementById('documentiModal')).show();
            })
            .catch(err => {
                toastr.error("Errore caricamento documenti.");
            });
    }

    // 🔵 UPLOAD DOCUMENTI PRATICA
    function selezionaECaricaDocumenti(idPratica) {
        const input = document.getElementById("inputUploadDocumenti");

        input.onchange = async function () {
            const files = input.files;
            if (files.length === 0) return;

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append("files", files[i]);
            }
            formData.append("idPratica", idPratica);

            const response = await fetch('/Pratiche/CaricaDocumentoPratica', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                toastr.success(result.message);
                ricalcolaDocumenti(); // 🔄 aggiorna la lista documenti
            } else {
                toastr.error(result.message || "Errore durante il caricamento.");
            }

            input.value = ""; // reset input
        };

        input.click(); // 👉 apre selettore file
    }

    // Apri modale creazione utente
    function apriModalCreaUtente() {
        document.getElementById('CreaUtenteForm').reset();
        new bootstrap.Modal(document.getElementById('creaUtenteModal')).show();
    }

    // Gestione submit creazione utente
    document.getElementById('CreaUtenteForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/Pratiche/CreaUtenteDaPratica', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success("Utente creato con successo!");
                    caricaResponsabili(); // ricarica lista
                    document.getElementById('selectResponsabile').value = res.idUtente;
                    bootstrap.Modal.getInstance(document.getElementById('creaUtenteModal')).hide();
                } else {
                    toastr.error(res.message);
                }
            });
    });

    //questa funzione si attiva quando ad un cliente e stato gia assegnato un responsabile e mostra la lista
    function caricaResponsabiliCliente(idCliente, idResponsabile = null) {
        return fetch('/Pratiche/GetUtentiAssociatiCliente?idCliente=' + idCliente)
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('selectResponsabile');
                select.innerHTML = '<option value="">-- Seleziona --</option>';

                // ✅ Popola normalmente con owner + associati
                data.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.ID_Utente;
                    opt.textContent = u.NomeCompleto;
                    select.appendChild(opt);
                });

                // ✅ Se ho un responsabile salvato che non è tra gli associati → lo aggiungo comunque
                if (idResponsabile && !data.some(u => u.ID_Utente === idResponsabile)) {
                    const opt = document.createElement('option');
                    opt.value = idResponsabile;
                    opt.textContent = "[Responsabile già salvato]";
                    select.appendChild(opt);
                }

                // ✅ Seleziono il responsabile corrente
                if (idResponsabile) {
                    select.value = idResponsabile;
                }
            });
    }


    //< !--Script per autocompletare % previsione-- >
    document.addEventListener("DOMContentLoaded", function () {
        const tipoClusterSelect = document.getElementById("tipoCluster");
        const percentualeInput = document.getElementById("percentualePrevisione");

        if (tipoClusterSelect && percentualeInput) {
            tipoClusterSelect.addEventListener("change", function () {
                const valore = tipoClusterSelect.value;

                switch (valore) {
                    case "Responsabile":
                        percentualeInput.value = 50;
                        break;
                    case "Collaboratore":
                        percentualeInput.value = 30;
                        break;
                    case "Segnalazione":
                        percentualeInput.value = 20;
                        break;
                    default:
                        percentualeInput.value = "";
                        break;
                }
            });
        }
    });

    function recuperaPratica(id) {
        Swal.fire({
            title: 'Recuperare questa pratica?',
            text: "La pratica verrà riattivata e resa nuovamente visibile.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sì, recupera',
            cancelButtonText: 'Annulla'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/Pratiche/RecuperaPratica', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ id: id })
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            Swal.fire('Recuperata!', res.message, 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Errore!', res.message, 'error');
                        }
                    })
                    .catch(err => {
                        console.error("Errore:", err);
                        Swal.fire('Errore!', 'Errore durante il recupero della pratica.', 'error');
                    });
            }
        });
    }

    // 🔵 SALVATAGGIO DATI CLIENTE DA MODALE modaleCompletaCliente
    document.getElementById('CompletaClienteForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/Pratiche/CompletaDatiCliente', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success("Dati cliente aggiornati con successo.");
                    bootstrap.Modal.getInstance(document.getElementById('modaleCompletaCliente')).hide();
                } else {
                    toastr.error(res.message || "Errore durante il salvataggio.");
                }
            })
            .catch(err => {
                console.error("Errore:", err);
                toastr.error("Errore durante la richiesta.");
            });
    });

    function apriModaleMovimentoBancario() {
        const modal = new bootstrap.Modal(document.getElementById('movimentoBancarioModal'));
        modal.show();
    }

    function confermaMovimentoBancario() {
        const form = document.getElementById('MovimentoBancarioForm');
        const formData = new FormData(form);

        // Potresti salvare i dati temporaneamente in hidden input nella pratica
        for (let [key, value] of formData.entries()) {
            // Crea o aggiorna hidden input nella modale della pratica
            let existing = document.querySelector(`#PraticaForm input[name="${key}"]`);
            if (!existing) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                document.getElementById('PraticaForm').appendChild(input);
            } else {
                existing.value = value;
            }
        }

        toastr.success("Movimento bancario aggiunto.");
        bootstrap.Modal.getInstance(document.getElementById('movimentoBancarioModal')).hide();
    }



    let indiceUtente = 0;
    function aggiungiUtentiSelezionati() {
        const checkboxes = document.querySelectorAll('#utentiDisponibiliContainer input[type="checkbox"]:checked');
        const hiddenContainer = document.getElementById('utentiAssociatiHiddenContainer');
        const riepilogo = document.getElementById('riepilogoUtentiAssociati');

        checkboxes.forEach(cb => {
            const id = cb.value;
            const nome = cb.getAttribute("data-nome");

            // Evita duplicati
            if (!utentiAssociati.find(u => u.ID == id)) {
                utentiAssociati.push({ ID: id, Nome: nome });

                // Trova la select del ruolo corrispondente
                const ruoloSelect = document.querySelector(`select.ruolo-select[data-id="${id}"]`);
                const ruolo = cb.getAttribute("data-ruolo") || 'Collaboratore';

                // Campo ID_Utente
                const inputID = document.createElement('input');
                inputID.type = 'hidden';
                inputID.name = `UtentiAssociati[${indiceUtente}].ID_Utente`;
                inputID.value = id;

                // Campo RuoloNellaPratica
                const inputRuolo = document.createElement('input');
                inputRuolo.type = 'hidden';
                inputRuolo.name = `UtentiAssociati[${indiceUtente}].RuoloNellaPratica`;
                inputRuolo.value = ruolo;

                hiddenContainer.appendChild(inputID);
                hiddenContainer.appendChild(inputRuolo);

                indiceUtente++;
            }
        });

        riepilogo.textContent = utentiAssociati.length > 0
            ? `${utentiAssociati.length} utente/i associato/i`
            : "Nessun utente associato";

        const modal = bootstrap.Modal.getInstance(document.getElementById('modaleUtentiAssociati'));
        // 🔽 Sposta il focus via prima di chiudere
        document.activeElement.blur();
        if (modal) modal.hide();
    }

    // sezione owner e responsabile pratica
    document.getElementById('selectCliente').addEventListener('change', function () {
        const idCliente = this.value;

        if (!idCliente) {
            document.getElementById('inputOwnerProfessionista').value = "";
            document.getElementById('hiddenOwnerProfessionista').value = "";
            document.getElementById('selectResponsabile').innerHTML = '<option value="">-- Seleziona responsabile --</option>';
            return;
        }

        fetch(`/Pratiche/GetOwnerCliente?idCliente=${idCliente}`)
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    document.getElementById('inputOwnerProfessionista').value = res.nomeOwner || "";
                    document.getElementById('hiddenOwnerProfessionista').value = res.idOwner || "";

                    // ✅ Popola subito i responsabili collegati al cliente
                    caricaResponsabiliCliente(idCliente);
                } else {
                    toastr.warning(res.message || "Owner non trovato.");
                    document.getElementById('inputOwnerProfessionista').value = "";
                    document.getElementById('hiddenOwnerProfessionista').value = "";
                    document.getElementById('selectResponsabile').innerHTML = '<option value="">-- Seleziona responsabile --</option>';
                }
            })
            .catch(err => {
                console.error(err);
                toastr.error("Errore nel recupero del professionista.");
            });
    });

    function impostaOwnerDaUtente(idUtente) {
        return fetch(`/Pratiche/GetOwnerDaUtente?idUtente=${idUtente}`)
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    // 🔹 Imposta i dati dell'owner
                    $('#inputOwnerProfessionista').val(res.nomeOwner || "");
                    $('#hiddenOwnerProfessionista').val(res.idOperatore || "");

                    // 🔁 Rimozione logica costi practice
                    // if (res.idProfessione) {
                    //     caricaCostiPractice(res.idProfessione);
                    // }

                    return res.idOwner || null;
                } else {
                    toastr.warning(res.message || "Professionista non trovato.");
                    $('#inputOwnerProfessionista').val("");
                    $('#hiddenOwnerProfessionista').val("");
                    return null;
                }
            })
            .catch(err => {
                console.error("Errore nel recupero dell'owner da utente:", err);
                toastr.error("Errore nel recupero del professionista.");
                return null;
            });
    }

    /* gestione costo pratica*/

    function apriModaleCostiPratica() {
        const modal = new bootstrap.Modal(document.getElementById('modaleCostiPratica'));
        modal.show();
    }

    function caricaAnagraficaCostiPratica(selectElement) {
        fetch('/Pratiche/GetAnagraficaCostiPratica')
            .then(r => r.json())
            .then(response => {
                if (!response.success || !Array.isArray(response.data)) return;

                const lista = response.data;

                selectElement.innerHTML = '<option value="">-- Seleziona voce --</option>';
                lista.forEach(voce => {
                    const option = document.createElement('option');
                    option.value = voce.ID_CostoPraticaAnagrafica; // ✅ nome corretto
                    option.textContent = voce.Nome + " - " + voce.Descrizione;
                    selectElement.appendChild(option);
                });
            })
            .catch(err => {
                console.error("Errore caricamento anagrafica costi pratica:", err);
            });
    }

    function caricaAnagraficaCostiPraticaModifica() {
        return fetch('/Pratiche/GetAnagraficaCostiPratica')
            .then(r => r.json())
            .then(response => {
                if (!response.success || !Array.isArray(response.data)) {
                    window.listaCostiPraticaOptions = '';
                    window.listaCostiPraticaRaw = [];
                    toastr.warning("⚠ Nessuna voce disponibile per Costi Pratica.");
                    return;
                }

                // ✅ Usa ID_AnagraficaCosto come value corretto
                window.listaCostiPraticaOptions = response.data.map(voce => {
                    return `<option value="${voce.ID_AnagraficaCosto}">${voce.Nome} - ${voce.Descrizione}</option>`;
                }).join('');

                window.listaCostiPraticaRaw = response.data;
            })
            .catch(err => {
                console.error("❌ Errore caricamento anagrafica costi pratica:", err);
                toastr.error("Errore durante il caricamento dei costi pratica.");
                window.listaCostiPraticaOptions = '';
                window.listaCostiPraticaRaw = [];
            });
    }


    async function aggiungiCostoPratica(idAnagrafica = null, importo = null, idFornitore = null) {
        const container = document.getElementById('costiPraticaContainer');
        const index = container.querySelectorAll('.riga-costo-pratica').length;

        const riga = document.createElement('div');
        riga.className = 'row riga-costo-pratica align-items-center mb-2';

        riga.innerHTML = `
        <div class="col-md-4">
            <select name="CostiPratica[${index}].ID_AnagraficaCosto"
                    class="form-select form-select-sm select-costo-pratica"
                    required>
                <option value="">-- Seleziona voce --</option>
            </select>
        </div>

        <div class="col-md-3">
            <input type="number" step="0.01"
                   name="CostiPratica[${index}].Importo"
                   class="form-control form-control-sm"
                   placeholder="Importo €"
                   required
                   value="${importo ?? ''}" />
        </div>

        <div class="col-md-4">
            <select name="CostiPratica[${index}].ID_Fornitore"
                    class="form-select form-select-sm select-fornitore-pratica">
                <option value="">-- Fornitore (opzionale) --</option>
            </select>
        </div>

        <div class="col-md-1 text-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviCostoPratica(this)">✕</button>
        </div>
    `;

        container.appendChild(riga);

        // ===============================
        // 🔹 1️⃣ CARICA ANAGRAFICA COSTI
        // ===============================
        const selectCosto = riga.querySelector('.select-costo-pratica');
        await fetch('/Pratiche/GetAnagraficaCostiPratica')
            .then(r => r.json())
            .then(response => {
                if (!response.success || !Array.isArray(response.data)) return;
                selectCosto.innerHTML = '<option value="">-- Seleziona voce --</option>';
                response.data.forEach(voce => {
                    const opt = document.createElement('option');
                    opt.value = voce.ID_AnagraficaCosto;
                    opt.textContent = `${voce.Nome ?? ""}${voce.Descrizione ? " - " + voce.Descrizione : ""}`;
                    selectCosto.appendChild(opt);
                });
                if (idAnagrafica) selectCosto.value = idAnagrafica.toString();
            })
            .catch(err => console.error("❌ Errore caricamento anagrafica costi:", err));

        // ===============================
        // 🔹 2️⃣ GESTIONE FORNITORI (dinamico per categoria)
        // ===============================
        const selectFornitore = riga.querySelector('.select-fornitore-pratica');

        // Funzione per caricare fornitori (filtrati o tutti)
        function caricaFornitori(idCategoria = null, idFornitorePreselezionato = null) {
            const url = idCategoria && idCategoria > 0
                ? `/Pratiche/GetFornitoriByCategoria?idCategoria=${idCategoria}`
                : `/Pratiche/GetFornitoriAttivi`;

            fetch(url)
                .then(r => r.json())
                .then(res => {
                    if (!res.success || !Array.isArray(res.data)) {
                        selectFornitore.innerHTML = '<option value="">-- Nessun fornitore disponibile --</option>';
                        return;
                    }

                    selectFornitore.innerHTML = '<option value="">-- Seleziona fornitore (opzionale) --</option>';
                    res.data.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.ID_Operatore; // ✅ ID GIUSTO
                        opt.textContent = f.Nome;
                        selectFornitore.appendChild(opt);
                    });

                    // Se già presente un fornitore
                    if (idFornitorePreselezionato) {
                        selectFornitore.value = idFornitorePreselezionato.toString();
                    }
                })
                .catch(err => console.error("❌ Errore caricamento fornitori:", err));
        }

        // Caricamento iniziale (tutti)
        caricaFornitori(null, idFornitore);

        // Quando cambia il costo → ricarica fornitori in base alla categoria
        selectCosto.addEventListener('change', function () {
            const idCosto = this.value;
            if (!idCosto) {
                caricaFornitori(null);
                return;
            }

            fetch(`/Pratiche/GetCategoriaByCosto?idCosto=${idCosto}`)
                .then(r => r.json())
                .then(cat => {
                    if (cat.success && cat.idCategoria) {
                        caricaFornitori(cat.idCategoria);
                    } else {
                        caricaFornitori(null);
                    }
                })
                .catch(err => console.error("❌ Errore GetCategoriaByCosto:", err));
        });
    }


    function salvaCostiPratica() {

        const container = document.getElementById('costiPraticaContainer');
        const hiddenContainer = document.getElementById('hiddenCostiPraticaContainer');

        // 🔁 Pulisce gli hidden esistenti
        hiddenContainer.innerHTML = '';

        const righe = container.querySelectorAll('.riga-costo-pratica');

        // 🧠 Reset array globale (tooltip / riepilogo)
        costiPraticaCorrenti = [];

        // 🧪 LOG HEADER
        console.group("🧾 [salvaCostiPratica] DATI INVIATI AL FORM / DB");

        righe.forEach((row, index) => {

            const selectCosto = row.querySelector('.select-costo-pratica');
            const selectFornitore = row.querySelector('.select-fornitore-pratica');
            const inputImporto = row.querySelector('input[type="number"]');

            const descrizione = selectCosto?.selectedOptions[0]?.textContent?.trim() || '';

            const importoRaw = parseFloat(inputImporto?.value || "0");

            // ✅ FORMATO CORRETTO PER MVC (IT-IT)
            const importoFormatted = !isNaN(importoRaw)
                ? importoRaw.toFixed(2).replace('.', ',')
                : "0,00";

            const idAnagrafica = selectCosto?.value ? parseInt(selectCosto.value) : null;
            const idFornitore = selectFornitore?.value ? parseInt(selectFornitore.value) : null;
            const nomeFornitore = selectFornitore?.selectedOptions[0]?.textContent?.trim() || '';

            // ============================
            // 📌 LOG PER SINGOLA RIGA
            // ============================
            console.group(`➡️ CostoPratica[${index}]`);
            console.log("ID_AnagraficaCosto:", idAnagrafica);
            console.log("Descrizione:", descrizione);
            console.log("Importo (raw):", importoRaw);
            console.log("Importo (formatted):", importoFormatted);
            console.log("ID_Fornitore:", idFornitore);
            console.log("NomeFornitore:", nomeFornitore);
            console.groupEnd();

            // ✅ Salva per riepilogo UI (usa numero JS)
            if (descrizione && !isNaN(importoRaw) && importoRaw > 0) {
                costiPraticaCorrenti.push({
                    Descrizione: descrizione,
                    Importo: importoRaw,
                    ID_AnagraficaCosto: idAnagrafica,
                    ID_Fornitore: idFornitore,
                    NomeFornitore:
                        (nomeFornitore && nomeFornitore !== "-- Fornitore (opzionale) --")
                            ? nomeFornitore
                            : ""
                });
            }

            // ============================
            // 🧩 HIDDEN INPUT (MVC BINDING)
            // ============================
            hiddenContainer.appendChild(
                creaHidden(`CostiPratica[${index}].ID_AnagraficaCosto`, idAnagrafica)
            );

            hiddenContainer.appendChild(
                creaHidden(`CostiPratica[${index}].Importo`, importoFormatted)
            );

            hiddenContainer.appendChild(
                creaHidden(`CostiPratica[${index}].ID_Fornitore`, idFornitore)
            );
        });

        console.groupEnd(); // 🧾 fine gruppo log

        // ============================
        // 🔎 LOG FINALE HIDDEN INPUT
        // ============================
        console.group("📤 INPUT HIDDEN REALMENTE INVIATI AL FORM");
        hiddenContainer.querySelectorAll('input').forEach(i => {
            console.log(i.name, "=", i.value);
        });
        console.groupEnd();

        toastr.success("💾 Costi della Pratica inseriti correttamente.");

        bootstrap.Modal
            .getInstance(document.getElementById('modaleCostiPratica'))
            .hide();

        aggiornaStatoCostiCaricati();
    }



    // ✅ Funzione utility condivisa
    function creaHidden(name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        input.classList.add('costo-pratica-hidden');
        return input;
    }


    function rimuoviCostoPratica(button) {
        const riga = button.closest('.riga-costo-pratica');
        if (riga) riga.remove();
    }

    function rigeneraHiddenCostiPratica() {
        const container = document.getElementById('hiddenCostiPraticaContainer');
        container.innerHTML = '';

        costiPraticaCorrenti.forEach((costo, index) => {
            container.appendChild(creaHidden(`CostiPratica[${index}].ID_AnagraficaCosto`, costo.ID_AnagraficaCosto));
            container.appendChild(creaHidden(`CostiPratica[${index}].Importo`, costo.Importo));
            container.appendChild(creaHidden(`CostiPratica[${index}].IDCostoHidden`, costo.IDCostoHidden || ''));
            container.appendChild(creaHidden(`CostiPratica[${index}].ID_Fornitore`, costo.ID_Fornitore || '')); // ✅ nuovo campo
        });
    }


    // Gestione visualizzazione costi pratica se sono inseriti
    let costiPraticaCorrenti = [];

    function aggiornaStatoCostiCaricati() {
        const iconeContainer = document.getElementById("riepilogoCostiIcone");
        const tooltip = document.getElementById("riepilogoCostiTooltip");
        const contenitore = document.getElementById("statoCostiCaricati");

        let html = '';
        let tooltipText = '';

        if (costiPraticaCorrenti.length > 0) {
            // ✅ Icona verde
            html += `<i class="fas fa-check-circle text-success me-2" title="Costi Pratica caricati"></i>`;

            // ✅ Riepilogo inline (prime 2 voci max, poi "…")
            const riepilogoInline = costiPraticaCorrenti
                .slice(0, 2)
                .map(c => {
                    const fornitore = c.NomeFornitore ? ` – ${c.NomeFornitore}` : '';
                    return `${c.Descrizione}${fornitore} (${parseFloat(c.Importo).toFixed(2)}€)`;
                })
                .join(" • ");

            html += `<span class="text-muted small">${riepilogoInline}${costiPraticaCorrenti.length > 2 ? " …" : ""}</span>`;

            // Tooltip dettagliato con fornitore
            tooltipText = `✅ Costi Pratica:\n` +
                costiPraticaCorrenti.map(c => {
                    const fornitore = c.NomeFornitore ? ` – ${c.NomeFornitore}` : '';
                    return `• ${c.Descrizione}${fornitore}: ${parseFloat(c.Importo).toFixed(2)}€`;
                }).join("\n");
        } else {
            // ❌ Icona rossa
            html += `<i class="fas fa-times-circle text-danger me-2" title="Costi Pratica mancanti"></i>`;
            html += `<span class="text-danger small">Nessun costo inserito</span>`;
            tooltipText = `⚠️ Nessun costo Pratica aggiunto`;
        }

        // 🧩 Aggiorna box
        iconeContainer.innerHTML = html;
        tooltip.setAttribute("title", tooltipText);
        new bootstrap.Tooltip(tooltip);
        contenitore.style.display = "flex";
    }

    /*fine gestione costo pratica */

/*    gestione template*/

    //function caricaTemplateIncarico(idProfessionista) {
    //    return fetch(`/Pratiche/GetTemplateByProfessionista?idProfessionista=${idProfessionista}`)
    //        .then(r => r.json())
    //        .then(data => {
    //            if (!data.success) {
    //                toastr.warning(data.message || "Nessun template disponibile.");
    //                return null;
    //            }
    //            return data.data; // { IDTemplateIncarichi, NomeTemplate, ContenutoHtml }
    //        })
    //        .catch(() => {
    //            toastr.error("Errore nel caricamento del template incarico.");
    //            return null;
    //        });
    //}

    function generaIncaricoDiretto(idPratica) {
        $.ajax({
            url: `/Pratiche/GeneraFoglioIncarico?idPratica=${idPratica}`,
            type: 'GET',
            success: function (res) {
                if (!res.success || !res.templates || res.templates.length === 0) {
                    toastr.warning("Nessun template disponibile per questa pratica.");
                    return;
                }

                let currentIndex = 0;

                function mostraTemplate(index) {
                    const tpl = res.templates[index];
                    $('#AnteprimaIncaricoModal .modal-body').html(tpl.Html);
                    $('#AnteprimaIncaricoModal .modal-title').text("Anteprima Incarico – " + tpl.TipoCompenso);

                    // Gestione pulsanti
                    $('#btnIndietro').prop('disabled', index === 0);
                    $('#btnAvanti').prop('disabled', index === res.templates.length - 1);
                }

                // Mostra il primo template
                mostraTemplate(currentIndex);
                $('#AnteprimaIncaricoModal').modal('show');

                // Navigazione avanti/indietro
                $('#btnAvanti').off('click').on('click', function () {
                    if (currentIndex < res.templates.length - 1) {
                        currentIndex++;
                        mostraTemplate(currentIndex);
                    }
                });

                $('#btnIndietro').off('click').on('click', function () {
                    if (currentIndex > 0) {
                        currentIndex--;
                        mostraTemplate(currentIndex);
                    }
                });
            },
            error: function () {
                toastr.error("Errore durante la generazione dell’incarico.");
            }
        });
    }

    // 🔹 Non serve più, ma la lasciamo "vuota" per compatibilità
    function caricaTemplateIncarico(idProfessionista) {
        return Promise.resolve(null);
    }

    // 🔹 Non serve più, ma la lasciamo "redirect" al metodo principale
    function generaFoglioIncarico(idPratica) {
        return fetch(`/Pratiche/GeneraFoglioIncarico?idPratica=${idPratica}`)
            .then(r => r.json())
            .then(response => {
                if (!response.success) {
                    toastr.warning(response.message || "Template non disponibile.");
                    return null;
                }

                return response.html; // HTML già pronto
            })
            .catch(err => {
                toastr.error("Errore durante la generazione del foglio incarico.");
                return null;
            });
    }

    function stampaContenuto() {
        const contenuto = document.getElementById("contenutoTemplateGenerato").innerHTML;
        const win = window.open('', '', 'height=800,width=800');
        win.document.write('<html><head><title>Stampa Incarico</title>');
        win.document.write(`
        <style>
            @@page {
                size: A4;
                margin: 20mm;
            }

            body {
                font-family: "Times New Roman", serif;
                font-size: 12pt;
                margin: 0;
                padding: 0;
            }

            table {
                border-collapse: collapse;
                page-break-inside: avoid;
                margin: auto; /* la lascia stretta come nel contenuto */
            }

            tr, td, th {
                page-break-inside: avoid;
                page-break-after: auto;
                padding: 4px;
                vertical-align: top;
            }
        </style>
    `);
        win.document.write('</head><body>');
        win.document.write(contenuto);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }

    function salvaFoglioIncaricoFirmato(idPratica) {
        const input = document.getElementById("inputFileIncarico");
        const file = input.files[0];
        if (!file) {
            toastr.warning("Seleziona un file PDF.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("idPratica", idPratica);

        fetch("/Pratiche/SalvaFoglioIncaricoFirmato", {
            method: "POST",
            body: formData
        })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    toastr.success(res.message);
                    ricaricaDocumentiIncarico(idPratica);
                } else {
                    toastr.error(res.message || "Errore salvataggio incarico.");
                }
            })
            .catch(() => {
                toastr.error("Errore durante il caricamento del file.");
            });

        input.value = ""; // reset input
    }

    function ricaricaDocumentiIncarico(idPratica) {
        fetch(`/Pratiche/GetDocumentiIncarico?idPratica=${idPratica}`)
            .then(r => r.json())
            .then(data => {
                const contenitore = document.getElementById("listaDocumentiIncarico");
                contenitore.innerHTML = "";

                if (!data.success || !Array.isArray(data.documenti)) {
                    contenitore.innerHTML = "<p class='text-muted'>Nessun documento incarico trovato.</p>";
                    return;
                }

                data.documenti.forEach(doc => {
                    // Formatto data in modo leggibile
                    let dataCaricamento = "";
                    if (doc.DataCaricamento) {
                        const d = new Date(doc.DataCaricamento);
                        dataCaricamento = d.toLocaleDateString("it-IT") + " " + d.toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
                    }

                    // Decido cosa mostrare in base allo stato
                    let azione = "";
                    if (doc.Stato === "Firmato") {
                        azione = `<span class="badge bg-success">Firmato</span>`;
                    } else if (doc.Stato === "Da firmare") {
                        azione = `<button class="btn btn-sm btn-primary" onclick="generaIncaricoDiretto(${idPratica})">Genera</button>`;
                    } else {
                        azione = `<button class="btn btn-sm btn-outline-primary" onclick="scaricaFoglioIncarico(${doc.ID_Documento})">Scarica</button>`;
                    }

                    const riga = document.createElement('div');
                    riga.className = "d-flex justify-content-between align-items-center border-bottom py-1";
                    riga.innerHTML = `
                    <div>
                        <strong>${doc.NomeFile}</strong> (${doc.Stato})<br />
                        <small class="text-muted">${dataCaricamento}</small>
                    </div>
                    ${azione}
                `;

                    contenitore.appendChild(riga);
                });
            })
            .catch(() => {
                toastr.error("Errore nel caricamento dei documenti incarico.");
            });
    }

    function scaricaFoglioIncarico(idDocumento) {
        if (!idDocumento || isNaN(idDocumento)) {
            toastr.warning("⚠️ Documento non valido o mancante.");
            return;
        }

        // 🔍 Verifica che il documento esista prima di aprire
        fetch(`/Pratiche/DownloadDocumentoPratica?idDocumento=${idDocumento}`, {
            method: "HEAD"
        })
            .then(response => {
                if (response.ok) {
                    // ✅ Documento trovato → apri nuova scheda
                    window.open(`/Pratiche/DownloadDocumentoPratica?idDocumento=${idDocumento}`, "_blank");
                } else if (response.status === 404) {
                    toastr.warning("📄 Documento non trovato o non più disponibile.");
                } else {
                    toastr.error("❌ Errore durante il download del documento.");
                }
            })
            .catch(err => {
                console.error("Errore durante la verifica del documento:", err);
                toastr.error("Errore di connessione al server.");
            });
    }

    function visualizzaDocumentiIncarico(idPratica) {
        fetch(`/Pratiche/GetDocumentiIncarico?idPratica=${idPratica}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    toastr.error(data.message || "Errore nel caricamento dei documenti incarico.");
                    return;
                }

                if (!data.documenti || data.documenti.length === 0) {
                    toastr.warning("Nessun documento incarico disponibile.");
                    return;
                }

                // ✅ Prendi il primo documento valido
                const doc = data.documenti[0];
                if (!doc.ID_Documento) {
                    toastr.warning("Documento non valido o incompleto.");
                    return;
                }

                // ✅ Apri il documento in una nuova scheda
                window.open(`/Pratiche/DownloadDocumentoPratica?idDocumento=${doc.ID_Documento}`, '_blank');
            })
            .catch(err => {
                console.error("Errore durante il caricamento dei documenti incarico:", err);
                toastr.error("Errore di connessione al server.");
            });
    }


    let templatesCorrenti = [];
    let indiceCorrente = 0;

    function apriAnteprimaIncarico(idPratica) {
        fetch(`/Pratiche/GeneraFoglioIncarico?idPratica=${idPratica}`)
            .then(r => r.json())
            .then(res => {
                if (!res.success || !res.templates || res.templates.length === 0) {
                    // 🔴 Mostra il toast all’utente
                    toastr.error(res.message || "Errore nella generazione dell'incarico");

                    // 🧠 Mostra il dettaglio tecnico completo in console
                    console.error("🚨 ERRORE GeneraFoglioIncarico:", res.message || "(nessun messaggio ricevuto)");

                    // (Facoltativo) mostra un alert modale se vuoi vederlo subito in produzione
                    // alert(res.message || "Errore nella generazione dell'incarico");
                    return;
                }

                // 🔹 Inizializza i template con copia modificabile
                templatesCorrenti = res.templates.map(t => ({
                    ...t,
                    HtmlModificato: t.Html // inizialmente uguale all’originale
                }));
                indiceCorrente = 0;

                mostraTemplateCorrente();
                document.querySelector('[name="ID_Pratiche"]').value = idPratica;

                const modal = new bootstrap.Modal(document.getElementById("modaleAnteprimaTemplate"));
                modal.show();
            })
            .catch(err => {
                // 🔴 Gestione errori di rete o fetch bloccata
                toastr.error("Errore di rete durante il caricamento dell'incarico");
                console.error("🌐 Errore rete/fetch GeneraFoglioIncarico:", err);
            });
    }


    // ======================================================
    // 🔹 Mostra un template alla volta (con supporto salto pagina logico)
    // ======================================================
  function mostraTemplateCorrente() {
  const contenitore = document.getElementById("contenutoTemplateGenerato");
  if (!contenitore) return;

  // 🧹 Pulisce tutto prima di riscrivere
  contenitore.innerHTML = "";

  const t = templatesCorrenti[indiceCorrente];
  if (!t) return;

  // 🔹 Recupera l'HTML del template (solo corpo)
  let html = t.HtmlModificato || t.Html || "";

  // ✨ Rimuove marker o <hr> post-tabella
  html = html
    .replace(/<\/table>\s*<hr[^>]*class=['"]page-break['"][^>]*>/gi, "</table>")
    .replace(/<!--PAGEBREAK-->/gi, ""); // rimuove i marker manuali

  // 📄 Genera layout A4 per anteprima (modificabile)
  contenitore.innerHTML = `
    <div class="page-preview">
      <div class="page-inner" id="anteprimaContenuto" contenteditable="true">
        <h5 class="mb-3 text-primary text-center">
          Compenso: ${t.TipoCompenso || "N/D"}
        </h5>
        ${html}
      </div>
    </div>
  `;

  // 📄 Aggiorna contatore in basso
  document.getElementById("templateCounter").textContent =
    `Template ${indiceCorrente + 1} di ${templatesCorrenti.length}`;

  // ⏪⏩ Pulsanti di navigazione
  document.getElementById("btnIndietro").disabled = indiceCorrente === 0;
  document.getElementById("btnAvanti").disabled = indiceCorrente === templatesCorrenti.length - 1;

  // 🎨 Impaginazione (solo grafica)
  setTimeout(suddividiInPagineA4, 300);
}

  function suddividiInPagineA4() {
    const area = document.getElementById("anteprimaContenuto");
    if (!area) return;

    // 🔹 Rimuovi eventuali marker precedenti
    document.querySelectorAll(".page-break-marker").forEach(function(el) {
        el.remove();
    });

    // 🔹 Calcolo layout reale dopo il rendering
    requestAnimationFrame(function() {
        const PAGE_HEIGHT = 1122; // ≈ 297mm 96dpi
        const totalHeight = area.scrollHeight;
        const numPages = Math.max(1, Math.ceil(totalHeight / PAGE_HEIGHT));

        // 🔸 Aggiungi linee di riferimento visive (solo anteprima)
        for (let i = 1; i < numPages; i++) {
            const marker = document.createElement("div");
            marker.classList.add("page-break-marker");
            marker.style.position = "absolute";
            marker.style.top = (i * PAGE_HEIGHT) + "px";
            area.appendChild(marker);
        }

        console.log("📄 Impaginazione aggiornata:", numPages, "pagine reali trovate (senza numeri o linee post-tabella).");
    });
}

    // ======================================================
    // 📄 Impaginazione A4 fluida — nessun offset, nessun taglio, nessuna pagina bianca
    // ======================================================
    function impaginaAnteprima() {
        // Trova l'interno della pagina
        const contenuto = document.querySelector("#contenutoTemplateGenerato .page-inner");
        if (!contenuto) return;

        // 🔹 Rimuovi eventuali numeri di pagina precedenti
        document.querySelectorAll(".page-number").forEach(n => n.remove());

        // 🔹 Aggiungi solo la numerazione visiva (non toccare il contenuto!)
        setTimeout(() => {
            const pages = document.querySelectorAll(".page-preview");
            pages.forEach((p, i) => {
                const num = document.createElement("div");
                num.classList.add("page-number");
                num.textContent = `Pagina ${i + 1}`;
                p.appendChild(num);
            });
        }, 100);
    }

    // ======================================================
    // 📄 CSS di simulazione A4 per l'anteprima (iniettato via JS una sola volta)
    // ======================================================
    const styleAnteprima = document.createElement("style");
    styleAnteprima.innerHTML =
        ".page-preview {" +
        "  position: relative;" +
        "  width: 210mm;" +
        "  min-height: 297mm;" +
        "  margin: 0 auto;" +
        "  background: #ffffff;" +
        "  border: 1px solid #ddd;" +
        "  box-sizing: border-box;" +
        "}" +

    ".page-inner {" +
    "  position: relative;" +
    "  min-height: 257mm;" +
    "  padding: 20mm;" +
    "  overflow: visible;" +
    "  background: #fff;" +
    "  color: #000;" +
    "  white-space: pre-wrap;" + // 👈 aggiungi questa riga
    "}" +


        ".page-break-marker {" +
        "  position: absolute;" +
        "  left: 0;" +
        "  width: 100%;" +
        "  border-top: 1px dashed rgba(255,0,0,0.25);" +
        "  pointer-events: none;" +
        "  z-index: 5;" +
        "}" +

        ".page-number {" +
        "  position: absolute;" +
        "  right: 15mm;" +
        "  font-size: 10pt;" +
        "  color: #777;" +
        "  font-style: italic;" +
        "  z-index: 5;" +
        "}" +

        "#contenutoTemplateGenerato {" +
        "  background: #f4f4f4;" +
        "  padding: 10px 0;" +
        "}";



    document.head.appendChild(styleAnteprima);


    // ======================================================
    // 🔸 Salva modifiche correnti prima di cambiare template
    // ======================================================
    function salvaModificheTemplateCorrente() {
        const contenuto = document.querySelector("#anteprimaContenuto");
        if (!contenuto || !templatesCorrenti[indiceCorrente]) return;

        // 🔹 Clona il contenuto per manipolarlo senza toccare il DOM reale
        const clone = contenuto.cloneNode(true);

        // 🔹 Rimuovi eventuali titoli <h5> "Compenso: ..."
        clone.querySelectorAll("h5.text-primary").forEach(el => el.remove());

        // 🔹 Salva solo l'HTML interno senza il titolo
        const htmlPulito = clone.innerHTML.trim();
        templatesCorrenti[indiceCorrente].HtmlModificato = htmlPulito;

        toastr.info(`💾 Modifiche salvate per "${templatesCorrenti[indiceCorrente].TipoCompenso}"`, "", { timeOut: 1200 });
    }


    // ======================================================
    // 🔸 Navigazione tra template
    // ======================================================
    function avantiTemplate() {
        salvaModificheTemplateCorrente();
        if (indiceCorrente < templatesCorrenti.length - 1) {
            indiceCorrente++;
            mostraTemplateCorrente();
        }
    }

    function indietroTemplate() {
        salvaModificheTemplateCorrente();
        if (indiceCorrente > 0) {
            indiceCorrente--;
            mostraTemplateCorrente();
        }
    }

    // ======================================================
    // 🔸 Salvataggio e generazione PDF di tutti i template
    // ======================================================
    function salvaComePDF() {
        if (!templatesCorrenti || templatesCorrenti.length === 0) {
            toastr.warning("Nessun template da salvare.");
            return;
        }

        const idPratica = document.querySelector('[name="ID_Pratiche"]')?.value;
        if (!idPratica || isNaN(idPratica)) {
            toastr.error("ID pratica non valido.");
            return;
        }

        // ✅ Salva eventuali modifiche non ancora registrate (ultimo template aperto)
        salvaModificheTemplateCorrente();

        const btn = event.target;
        btn.disabled = true;
        const testoOriginale = btn.innerHTML;
        btn.innerHTML = "Generazione in corso...";

        let completati = 0;

        templatesCorrenti.forEach((t, index) => {
            const tipoCompenso = t.TipoCompenso || "Generico";
            const tipoSanificato = tipoCompenso.replace(/\s+/g, "_").replace(/[^\w_-]/g, "");
            const nomeTemplate = `Incarico_${tipoSanificato}_${new Date().toISOString().slice(0, 10)}`;

            // ✅ Usa il contenuto modificato dell’utente se presente
            const htmlDaUsare = t.HtmlModificato && t.HtmlModificato.trim() !== "" ? t.HtmlModificato : t.Html;

            // ✅ Ogni template sarà una pagina separata nel PDF (pulito)
            const htmlSingolo = `
        <div class="pagina-template" style="page-break-after: always; padding: 30px; background-color: #ffffff; color: #000;">
            <h4 style="text-align:center; color:#007bff; margin-bottom:20px;">
                Compenso: ${t.TipoCompenso}
            </h4>

            ${htmlDaUsare}
        </div>`;

            $.ajax({
                url: "/Pratiche/GeneraPDFIncaricoDaHtml",
                type: "POST",
                data: {
                    idPratica: idPratica,
                    html: htmlSingolo,
                    tipoCompenso: tipoCompenso,
                    nomeFileCustom: nomeTemplate
                },
                success: function (result) {
                    completati++;
                    if (result.success) {
                        toastr.success(`✅ PDF ${t.TipoCompenso} generato (${completati}/${templatesCorrenti.length})`);
                    } else {
                        toastr.error(`❌ Errore PDF ${t.TipoCompenso}: ${result.message}`);
                    }

                    if (completati === templatesCorrenti.length) {
                        fineGenerazione();
                    }
                },
                error: function () {
                    completati++;
                    toastr.error(`❌ Errore di rete durante la generazione del PDF (${t.TipoCompenso})`);

                    if (completati === templatesCorrenti.length) {
                        fineGenerazione();
                    }
                }
            });
        });

        function fineGenerazione() {
            const modalEl = document.getElementById('modaleAnteprimaTemplate');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            setTimeout(() => location.reload(), 1000);
            btn.disabled = false;
            btn.innerHTML = testoOriginale;
        }
    }



    function visualizzaPdf(idDocumento) {
        window.open(`/Pratiche/DownloadDocumentoPratica?idDocumento=${idDocumento}`, '_blank');
    }


    // fine gestione template


    // inizio gestione tipologia e compenso

    //document.addEventListener("DOMContentLoaded", function () {
    //    const tipologiaSelect = document.getElementById("tipologiaSelect");

    //    tipologiaSelect.addEventListener("change", function () {
    //        const valore = this.value;

    //        // Nasconde tutti i campi
    //        document.querySelectorAll(".metodo-compenso").forEach(div => div.classList.add("d-none"));

    //        // Mostra il campo selezionato
    //        if (valore === "Fisso") {
    //            document.getElementById("compensoFisso").classList.remove("d-none");
    //        } else if (valore === "A ore") {
    //            document.getElementById("compensoOre").classList.remove("d-none");
    //        } else if (valore === "Giudiziale") {
    //            document.getElementById("compensoGiudiziale").classList.remove("d-none");
    //        }
    //    });
    //});

    // fine gestione


    //function aggiornaCompensiCalcolati() {
    //    const tariffa = parseFloat(document.querySelector('[name="TariffaOraria"]').value) || 0;
    //    const orePreviste = parseFloat(document.querySelector('[name="OrePreviste"]').value) || 0;
    //    const oreEffettive = parseFloat(document.querySelector('[name="OreEffettive"]').value) || 0;

    //    const compensoPrevisionale = tariffa * orePreviste;
    //    const compensoEconomico = tariffa * oreEffettive;

    //    document.getElementById("compensoPrevisionale").textContent = "€" + compensoPrevisionale.toFixed(2).replace('.', ',');
    //    document.getElementById("compensoEconomico").textContent = "€" + compensoEconomico.toFixed(2).replace('.', ',');
    //}

    //// 🔁 Al change dei campi
    //['TariffaOraria', 'OrePreviste', 'OreEffettive'].forEach(nome => {
    //    const input = document.querySelector(`[name="${nome}"]`);
    //    if (input) {
    //        input.addEventListener('input', aggiornaCompensiCalcolati);
    //    }
    //});

    // Se vuoi eseguire all'apertura della modale
    //document.addEventListener('DOMContentLoaded', aggiornaCompensiCalcolati);
    // fine

    // 🔹 Variabile globale (accessibile ovunque)
    window.intestatariGlobali = [];
    // mi serve quando creo nuova pratica che non ho dati nel db 
    window.compensiTemp = [];


    // ============================================================
    // 🧩 Normalizza e ripulisce testi da accenti e apici tipografici
    // ============================================================
    function sanitizeText(value) {
        if (!value) return "";
        return value
            .normalize("NFC")                    // uniforma lettere accentate
            .replace(/[\u2018\u2019]/g, "'")     // converte apici tipografici in '
            .replace(/[\u201C\u201D]/g, '"')     // converte doppi apici tipografici in "
            .replace(/[\r\n]+/g, ' ')            // rimuove newline
            .trim();
    }


    function apriCompensoModal(idPratica) {
        console.log("🚀 apriCompensoModal CHIAMATA con idPratica:", idPratica);

        const metodo = document.getElementById('metodoCompensoSelect').value;
        const header = document.getElementById('tabellaCompensiHeader');
        const tbody = document.querySelector('#tabellaCompensi tbody');
        const campiAggiuntivi = document.getElementById('campiAggiuntivi');
        const budgetInput = document.getElementById('BudgetInput');

        header.innerHTML = '';
        tbody.innerHTML = '';
        campiAggiuntivi.innerHTML = '';

        // ============================================================
        // 🔧 GESTIONE CAMPI AGGIUNTIVI
        // ============================================================
        if (metodo === 'Giudiziale') {
            campiAggiuntivi.innerHTML = `
            <a href="https://www.avvocatoandreani.it/servizi/calcolo-compenso-avvocati-parametri-civili-2014.php"
               target="_blank" class="btn btn-outline-info btn-sm mb-2">
               🔗 Calcolatore parametri civili
            </a>
            <input type="text" class="form-control form-control-sm mb-2"
                   id="EstremiGiudizio"
                   name="EstremiGiudizio"
                   placeholder="Estremi giudizio oggetto dell’incarico" />
        `;
        }
        else if (metodo === 'A ore') {
            campiAggiuntivi.innerHTML = `
            <input type="text" class="form-control form-control-sm"
                   id="OggettoIncarico"
                   name="OggettoIncarico"
                   placeholder="Oggetto dell’incarico" />
        `;
            budgetInput.removeAttribute('readonly');
            budgetInput.placeholder = "Inserisci budget stimato manualmente";
        }
        else {
            budgetInput.setAttribute('readonly', true);
            budgetInput.placeholder = "";
        }

        // ============================================================
        // 🔧 TABELLA — INTESTAZIONI DINAMICHE
        // ============================================================
        switch (metodo) {
            case 'Fisso':
                header.innerHTML = `
                <th>#</th>
                <th>Descrizione</th>
                <th>Importo (€)</th>
                <th>Tipologia</th>
                <th>Unità/Valore stimato</th>
                <th>Intestatario</th>
                <th>Azioni</th>`;
                break;

            case 'Giudiziale':
                header.innerHTML = `
                <th>#</th>
                <th>Fase Giudizio</th>
                <th>Importo (€)</th>
                <th>Intestatario</th>
                <th>Azioni</th>`;
                break;

            case 'A ore':
                header.innerHTML = `
                <th>#</th>
                <th>Ruolo</th>
                <th>Tariffa Oraria (€)</th>
                <th>Intestatario</th>
                <th>Azioni</th>`;
                break;
        }

        // ============================================================
        // 🟦 CASO A — NUOVA PRATICA (idPratica = 0)
        // ============================================================
        if (!idPratica || idPratica == 0) {

            console.log("🆕 NUOVA PRATICA → uso compensiTemp:", window.compensiTemp);

            const tbody = document.querySelector('#tabellaCompensi tbody');
            tbody.innerHTML = "";

            // 🔄 Prima ricarico gli intestatari (normale)
            const idCliente = $('#selectCliente').val();
            fetch(`/Pratiche/GetIntestatariPratica?idCliente=${idCliente}`)
                .then(r => r.json())
                .then(json => {

                    window.intestatariGlobali = json.intestatari || [];
                    aggiornaIntestatariDisponibili();

                    // 🔥 ECCO LA PARTE IMPORTANTE:
                    // Se ho compensi già inseriti in questa nuova pratica → li ricarico
                    if (window.compensiTemp.length > 0) {

                        window.compensiTemp
                            .filter(x => x.Metodo === metodo)
                            .forEach(r => aggiungiRigaDaJSON(r, metodo));

                    } else {

                        // ⚖️ fallback giudiziale se nulla inserito
                        if (metodo === 'Giudiziale') {
                            ['Fase di Studio', 'Fase Introduttiva', 'Fase Istruttoria', 'Fase Decisionale']
                                .forEach(f => aggiungiRigaCompenso(f, true));
                        }
                    }

                    new bootstrap.Modal('#compensoModal').show();
                });

            return;
        }


        // ============================================================
        // 🟨 CASO B — MODIFICA PRATICA
        // ============================================================
        console.log("✏️ MODIFICA pratica → carico compensi");

        Promise.all([
            fetch(`/Pratiche/GetIntestatariPratica?idPratica=${idPratica}`).then(r => r.json()),
            fetch(`/Pratiche/GetCompensiPratica?idPratica=${idPratica}`).then(r => r.json())
        ])
            .then(([jsonInt, jsonComp]) => {

                // ---------------- INTESTATARI ----------------
                window.intestatariGlobali = jsonInt.intestatari || [];
                aggiornaIntestatariDisponibili();

                // ---------------- COMPENSI ----------------

                // 1️⃣ Carico sempre i compensi dal server come base
                let cumulativo = Array.isArray(jsonComp.raw) ? jsonComp.raw : [];

                // 2️⃣ Salvo in memoria globale (fonte unica)
                window.CompensiCorrenti = JSON.parse(JSON.stringify(cumulativo));

                // 3️⃣ Aggiorno l’hidden in modo sicuro
                document.querySelector('#hiddenCompensiContainer').innerHTML =
                    `<input type="hidden" name="CompensiJSON" value="${encodeURIComponent(JSON.stringify(window.CompensiCorrenti))}">`;

                // 4️⃣ Filtra per metodo corrente (Fisso, A ore, Giudiziale)
                let righeMetodo = window.CompensiCorrenti.filter(x => x.Metodo === metodo);

                // ⚠️ Se non trovate righe → uso quelle grezze del server
                if (righeMetodo.length === 0)
                    righeMetodo = cumulativo.filter(x => x.Metodo === metodo);

                // 5️⃣ Costruzione righe nella tabella
                righeMetodo.forEach(r => aggiungiRigaDaJSON(r, metodo));

                // 6️⃣ Fallback per giudiziale
                if (metodo === "Giudiziale" && righeMetodo.length === 0) {
                    ['Fase di Studio', 'Fase Introduttiva', 'Fase Istruttoria', 'Fase Decisionale']
                        .forEach(f => aggiungiRigaCompenso(f, true));
                }


                new bootstrap.Modal('#compensoModal').show();
            });
    }


    function aggiungiRigaDaJSON(riga, metodo) {
        let lastRow;

        // 🔹 Crea la riga base
        if (metodo === 'Fisso' || metodo === 'A ore') {
            aggiungiRigaCompenso();
            const tbody = document.querySelector('#tabellaCompensi tbody');
            lastRow = tbody.lastElementChild;
        }
        else if (metodo === 'Giudiziale') {
            const tbody = document.querySelector('#tabellaCompensi tbody');
            let row = document.createElement('tr');
            row.innerHTML = `
        <td><strong></strong></td>
        <td>
          <input type="text" class="form-control form-control-sm"
                 name="Fase_temp"
                 value="${riga.Descrizione || ''}"
                 placeholder="Descrizione fase giudizio">
        </td>
        <td>
          <input type="text" class="form-control form-control-sm importo-input"
                 name="Importo_temp"
                 inputmode="decimal"
                 placeholder="Importo (€)">
        </td>
        <td>
          <select class="form-select form-select-sm intestatario-select" name="Intestatario_temp">
            <option value="">-- Seleziona intestatario --</option>
          </select>
          <div class="collaboratori-riga mt-2"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                  onclick="aggiungiCollaboratoreRiga(this)">➕ Collaboratore</button>
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-sm btn-danger"
                  onclick="this.closest('tr').remove(); aggiornaNumeri()">🗑</button>
        </td>`;
            tbody.appendChild(row);
            lastRow = row;
        }

        if (!lastRow) return;

        // 🔹 Campi per "Fisso"
        if (metodo === 'Fisso') {
            (lastRow.querySelector('textarea[name="Descrizione_temp"]') || lastRow.querySelector('textarea[name^="Descrizione_"]'))
                .value = riga.Descrizione || "";

            const inputImporto = (lastRow.querySelector('input[name="Importo_temp"]') || lastRow.querySelector('input[name^="Importo_"]'));
            if (inputImporto) {
                const num = parseFloat(riga.Importo?.toString().replace(',', '.'));
                inputImporto.value = !isNaN(num)
                    ? num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : (riga.Importo || '');
                inputImporto.dataset.raw = !isNaN(num) ? num : riga.Importo;
            }

            (lastRow.querySelector('select[name="Tipologia_temp"]') || lastRow.querySelector('select[name^="Tipologia_"]'))
                .value = riga.Tipologia || "Fisso";

            (lastRow.querySelector('input[name="ValoreStimato_temp"]') || lastRow.querySelector('input[name^="ValoreStimato_"]'))
                .value = riga.ValoreStimato || "";
        }

        // 🔹 Campi per "A ore"
        else if (metodo === 'A ore') {
            (lastRow.querySelector('input[name="Ruolo_temp"]') || lastRow.querySelector('input[name^="Ruolo_"]'))
                .value = riga.Descrizione || "";

            const inputTariffa = (lastRow.querySelector('input[name="Tariffa_temp"]') || lastRow.querySelector('input[name^="Tariffa_"]'));
            if (inputTariffa) {
                const num = parseFloat(riga.Importo?.toString().replace(',', '.'));
                inputTariffa.value = !isNaN(num)
                    ? num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : (riga.Importo || '');
                inputTariffa.dataset.raw = !isNaN(num) ? num : riga.Importo;
            }
        }

        // 🔹 Campi per "Giudiziale"
        else if (metodo === 'Giudiziale') {
            (lastRow.querySelector('input[name="Fase_temp"]') || lastRow.querySelector('input[name^="Fase_"]'))
                .value = riga.Descrizione || "";

            const inputImporto = (lastRow.querySelector('input[name="Importo_temp"]') || lastRow.querySelector('input[name^="Importo_"]'));
            if (inputImporto) {
                const num = parseFloat(riga.Importo?.toString().replace(',', '.'));
                inputImporto.value = !isNaN(num)
                    ? num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : (riga.Importo || '');
                inputImporto.dataset.raw = !isNaN(num) ? num : riga.Importo;
            }
        }


        // 👤 Intestatario (Owner / Responsabile / Collaboratori principali)
        const selectIntestatario = lastRow.querySelector('.intestatario-select');
        if (selectIntestatario) {

            console.log("🔥 [DEBUG] INIZIO gestione intestatario da JSON:", riga);

            try {
                // Popola la select
                console.log("➡️ [DEBUG] Popolo select con intestatari globali...");
                popolaSelectIntestatari(selectIntestatario);
            } catch (err) {
                console.error("💥 [ERRORE] durante popolaSelectIntestatari:", err);
            }

            // Valore che arriva dal JSON
            let idInt = riga.ID_ProfessionistaIntestatario;
            console.log("🔍 [DEBUG] ID intestatario dal JSON:", idInt);

            try {
                if (idInt && idInt !== "null") {

                    // applico valore
                    selectIntestatario.value = idInt;
                    selectIntestatario.dataset.savedValue = idInt;

                    console.log("✔️ [DEBUG] Valore intestatario applicato:", idInt);

                    // FIX APOSTROFO → sanifico SOLO il testo dell’opzione selezionata
                    let opt = selectIntestatario.options[selectIntestatario.selectedIndex];
                    if (opt) {
                        let original = opt.text;
                        let safe = original
                            .replace(/'/g, "&#39;")
                            .replace(/"/g, "&quot;");
                        opt.innerHTML = safe;

                        console.log(`✔️ [DEBUG] Testo opzione sanificato: "${original}" → "${safe}"`);
                    }
                }
                else {
                    console.log("⚠️ Nessun intestatario nel JSON, imposto vuoto.");
                    selectIntestatario.value = "";
                    delete selectIntestatario.dataset.savedValue;
                }
            } catch (err) {
                console.error("💥 [ERRORE] durante assegnazione intestatario:", err);
            }

            console.log("🏁 [DEBUG] Fine gestione intestatario.");
        }



        // 👥 Collaboratori (se presenti nel JSON)
        if (riga.Collaboratori && Array.isArray(riga.Collaboratori)) {
            const container = lastRow.querySelector(".collaboratori-riga");
            riga.Collaboratori.forEach(col => {
                const div = document.createElement("div");
                div.classList.add("row-collaboratore", "input-group", "input-group-sm", "mb-1");
                div.innerHTML = `
            <select name="Collaboratore_temp" class="form-select form-select-sm col-6">
                ${getUtentiDisponibili().map(u =>
                    `<option value="${u.ID}" ${u.ID == col.ID_Collaboratore ? 'selected' : ''}>${u.Nome}</option>`
                ).join("")}
            </select>
            <input name="PercentualeCollaboratore_temp" type="number"
                   class="form-control form-control-sm col-3 ms-1"
                   value="${col.Percentuale}" min="0" max="100">
            <button type="button" class="btn btn-sm btn-danger ms-1"
                    onclick="this.parentElement.remove()">🗑</button>`;
                container.appendChild(div);
            });
        }

        aggiornaNumeri();
    }


    function aggiungiRigaCompenso(valorePredefinito = '', isStandard = false) {
        const metodo = document.getElementById('metodoCompensoSelect').value;
        const tbody = document.querySelector('#tabellaCompensi tbody');
        let row = document.createElement('tr');

        switch (metodo) {
            // ======================================================
            // 🔹 CASO: COMPENSO FISSO
            // ======================================================
            case 'Fisso':
                row.innerHTML = `
            <td><strong></strong></td>
            <td>
                <textarea class="form-control form-control-sm"
                          name="Descrizione_temp"
                          rows="2"
                          placeholder="Descrizione servizio/attività"></textarea>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm importo-input"
                       name="Importo_temp"
                       inputmode="decimal"
                       placeholder="Importo (€)">
            </td>
            <td>
                <select class="form-select form-select-sm" name="Tipologia_temp" onchange="mostraCampoValoreStimato(this)">
                    <option value="Fisso">Fisso</option>
                    <option value="Mensile">Mensile</option>
                    <option value="Trimestrale">Trimestrale</option>
                    <option value="Semestrale">Semestrale</option>
                    <option value="Annuale">Annuale</option>
                    <option value="Per unità/mese">Per unità/mese</option>
                    <option value="Per unità/trimestre">Per unità/trimestre</option>
                    <option value="Per unità/anno">Per unità/anno</option>
                    <option value="Percentuale">Percentuale</option>
                </select>
            </td>
            <td>
                <input type="number"
                       class="form-control form-control-sm d-none"
                       name="ValoreStimato_temp"
                       step="0.01"
                       disabled
                       placeholder="Unità o valore stimato">
            </td>
            <td>
                <select class="form-select form-select-sm intestatario-select" name="Intestatario_temp">
                    <option value="">-- Seleziona intestatario --</option>
                </select>
                <div class="collaboratori-riga mt-2"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                        onclick="aggiungiCollaboratoreRiga(this)">➕ Collaboratore</button>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger"
                        onclick="this.closest('tr').remove(); aggiornaNumeri()">🗑</button>
            </td>`;
                tbody.appendChild(row);
                break;

            // ======================================================
            // 🔹 CASO: COMPENSO GIUDIZIALE
            // ======================================================
            case 'Giudiziale':
                if (isStandard) row.dataset.standard = "true";
                row.innerHTML = `
            <td><strong></strong></td>
            <td>
                <input type="text" class="form-control form-control-sm"
                       name="Fase_temp"
                       value="${valorePredefinito}"
                       placeholder="Descrizione fase giudizio">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm importo-input"
                       name="Importo_temp"
                       inputmode="decimal"
                       placeholder="Importo pattuito (€)">
            </td>
            <td>
                <select class="form-select form-select-sm intestatario-select" name="Intestatario_temp">
                    <option value="">-- Seleziona intestatario --</option>
                </select>
                <div class="collaboratori-riga mt-2"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                        onclick="aggiungiCollaboratoreRiga(this)">➕ Collaboratore</button>
            </td>
            <td class="text-center">
                ${isStandard ? '' : '<button type="button" class="btn btn-sm btn-danger" onclick="this.closest(\'tr\').remove(); aggiornaNumeri()">🗑</button>'}
            </td>`;
                if (isStandard) {
                    tbody.appendChild(row);
                } else {
                    const firstStandard = tbody.querySelector('tr[data-standard="true"]');
                    if (firstStandard) {
                        tbody.insertBefore(row, firstStandard);
                    } else {
                        tbody.insertBefore(row, tbody.firstChild);
                    }
                }
                break;

            // ======================================================
            // 🔹 CASO: COMPENSO A ORE
            // ======================================================
            case 'A ore':
                row.innerHTML = `
            <td><strong></strong></td>
            <td>
                <input type="text" class="form-control form-control-sm" name="Ruolo_temp" placeholder="Ruolo o mansione">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm importo-input"
                       name="Tariffa_temp"
                       inputmode="decimal"
                       placeholder="Tariffa oraria (€)">
            </td>
            <td>
                <select class="form-select form-select-sm intestatario-select" name="Intestatario_temp">
                    <option value="">-- Seleziona intestatario --</option>
                </select>
                <div class="collaboratori-riga mt-2"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                        onclick="aggiungiCollaboratoreRiga(this)">➕ Collaboratore</button>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger"
                        onclick="this.closest('tr').remove(); aggiornaNumeri()">🗑</button>
            </td>`;
                tbody.appendChild(row);
                break;
        }

        // 👤 Popola subito la select intestatario
        const selectIntestatario = row.querySelector('.intestatario-select');
        if (selectIntestatario) {
            popolaSelectIntestatari(selectIntestatario);
        }

        aggiornaNumeri();
    }


    function aggiornaNumeri() {
        document.querySelectorAll('#tabellaCompensi tbody tr').forEach((tr, i) => {
            const index = i + 1;
            const strong = tr.querySelector('td strong');
            if (strong) strong.textContent = index + ')';

            // Fisso o Giudiziale
            const descrizioneInput = tr.querySelector('textarea[name="Descrizione_temp"], input[name="Descrizione_temp"], input[name^="Descrizione_"]');
            const faseInput = tr.querySelector('input[name="Fase_temp"], input[name^="Fase_"]');
            const importoInput = tr.querySelector('input[name="Importo_temp"], input[name^="Importo_"]');
            const tipologiaSelect = tr.querySelector('select[name="Tipologia_temp"], select[name^="Tipologia_"]');
            const valoreInput = tr.querySelector('input[name="ValoreStimato_temp"], input[name^="ValoreStimato_"]');
            const ruoloInput = tr.querySelector('input[name="Ruolo_temp"], input[name^="Ruolo_"]');
            const tariffaInput = tr.querySelector('input[name="Tariffa_temp"], input[name^="Tariffa_"]');
            const intestatarioSelect = tr.querySelector('select[name="Intestatario_temp"], select[name^="Intestatario_"]');

            if (descrizioneInput) descrizioneInput.name = 'Descrizione_' + index;
            if (faseInput) faseInput.name = 'Fase_' + index;
            if (importoInput) importoInput.name = 'Importo_' + index;
            if (tipologiaSelect) tipologiaSelect.name = 'Tipologia_' + index;
            if (valoreInput) valoreInput.name = 'ValoreStimato_' + index;
            if (ruoloInput) ruoloInput.name = 'Ruolo_' + index;
            if (tariffaInput) tariffaInput.name = 'Tariffa_' + index;
            if (intestatarioSelect) intestatarioSelect.name = 'Intestatario_' + index;

            // 👥 Collaboratori → rinumerazione annidata
            tr.querySelectorAll('.row-collaboratore').forEach((colRow, j) => {
                const collabSelect = colRow.querySelector('select[name="Collaboratore_temp"], select[name^="Collaboratore_"]');
                const percInput = colRow.querySelector('input[name="PercentualeCollaboratore_temp"], input[name^="PercentualeCollaboratore_"]');

                if (collabSelect) collabSelect.name = `Collaboratore_${index}_${j + 1}`;
                if (percInput) percInput.name = `PercentualeCollaboratore_${index}_${j + 1}`;
            });
        });
    }


// 📌 Funzione calcolo Valore Stimato
    function aggiornaValoreStimato(compensi) {
        let totale = 0;

        compensi.forEach(c => {
            if (c.Metodo === "Fisso") {
                const importo = parseFloat(c.Importo) || 0;
                const valore = parseFloat(c.ValoreStimato) || 1;
                totale += importo * valore;
            }
            else if (c.Metodo === "Giudiziale") {
                const importo = parseFloat(c.Importo) || 0;
                totale += importo;
            }
            else if (c.Metodo === "A ore") {
                // 👇 Se esiste BudgetManuale nel JSON, usalo senza ricalcolare
                if (c.BudgetManuale) {
                    totale += parseFloat(c.BudgetManuale) || 0;
                }
            }
        });

        const budgetInput = document.getElementById("BudgetInput");

        if (budgetInput) {
            // 🔹 formato italiano → con virgola
            budgetInput.value = totale.toFixed(2).replace('.', ',');
        }
    }

    // 🔹 Formatta numeri in stile italiano con due decimali e virgola
    function formattaImportoItaliano(valore) {
        if (valore === null || valore === undefined || valore === "") return "";
        const numero = parseFloat(valore.toString().replace(',', '.'));
        if (isNaN(numero)) return valore;
        return numero.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }


    // 🔹 Popola riepilogo con debug esteso
    function popolaRiepilogoCompensi(compensi) {
        console.log("🖊 [DEBUG] Compensi ricevuti per riepilogo:", compensi);

        const tbody = document.querySelector('#riepilogoCompensiTable tbody');
        tbody.innerHTML = '';

        compensi.forEach((c, i) => {
            // Nome intestatario → fallback multiplo
            const intestatarioNome = c.IntestatarioNome || c.NomeProfessionistaIntestatario || "(sconosciuto)";

            // 🔎 Debug dettagliato
            console.log(`➡️ Riga ${i + 1}`, {
                ID_Intestatario: c.ID_ProfessionistaIntestatario,
                IntestatarioNome: c.IntestatarioNome,
                NomeProfessionistaIntestatario: c.NomeProfessionistaIntestatario,
                NomeUsatoNelRiepilogo: intestatarioNome,
                CollaboratoriRaw: c.Collaboratori
            });

            // 🔎 Debug collaboratori singoli
            if (c.Collaboratori && Array.isArray(c.Collaboratori)) {
                c.Collaboratori.forEach((col, j) => {
                    console.log(`   👥 Collaboratore ${j + 1}:`, {
                        ID: col.ID_Collaboratore,
                        NomeCollaboratore: col.NomeCollaboratore,
                        Percentuale: col.Percentuale
                    });
                });
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${c.Metodo}</td>
            <td>${c.Descrizione || c.Ruolo || ""}</td>
            <td>${formattaImportoItaliano(c.Importo)}</td>
            <td>${c.Tipologia || ""}</td>
            <td>${c.ValoreStimato || ""}</td>
            <td>
                ${intestatarioNome ? `<div><strong>${intestatarioNome}</strong></div>` : ""}
                ${c.Collaboratori && c.Collaboratori.length > 0
                    ? `<ul class="mb-0 ps-3 small text-muted">` +
                    c.Collaboratori.map(col =>
                        `<li>${col.NomeCollaboratore || "(sconosciuto)"} (${col.Percentuale}%)</li>`
                    ).join('') +
                    `</ul>`
                    : ""}
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminaRigaRiepilogo(${i})">🗑</button>
            </td>`;
            tbody.appendChild(tr);
        });

        // =====================================================
        // 🟦 NUOVA PRATICA → aggiorno compensiTemp
        // =====================================================
        const idPratica = document.getElementById("ID_Pratiche")?.value || "0";
        if (idPratica == "0" || idPratica === "") {
            window.compensiTemp = JSON.parse(JSON.stringify(compensi));
            console.log("🟦 [popolaRiepilogo] aggiorno compensiTemp:", window.compensiTemp);
        }
    }

    // 🔹 Elimina una riga dal riepilogo
    function eliminaRigaRiepilogo(index) {
        let cumulativo = [];
        const hidden = document.querySelector('#hiddenCompensiContainer input[name="CompensiJSON"]');

        if (hidden && hidden.value) {
            try {
                const decoded = decodeURIComponent(hidden.value); // ✅ decodifica prima
                cumulativo = JSON.parse(decoded);                 // ✅ poi parse
            } catch (e) {
                console.error("❌ Errore nel parsing JSON durante eliminazione:", e);
                cumulativo = [];
            }
        }

        // ✂️ Rimuove la riga selezionata
        cumulativo.splice(index, 1);

        // ✅ risalva in formato codificato
        const nuovoJson = encodeURIComponent(JSON.stringify(cumulativo));
        document.getElementById('hiddenCompensiContainer').innerHTML =
            `<input type="hidden" name="CompensiJSON" value="${nuovoJson}">`;

        popolaRiepilogoCompensi(cumulativo);
    }


    function mostraCampoValoreStimato(select) {
        const tipologia = select.value;
        const valoreInput = select.closest('tr').querySelector('input[name^="ValoreStimato_"]');

        if (tipologia.startsWith('Per unità') || tipologia === 'Percentuale') {
            valoreInput.classList.remove('d-none');
            valoreInput.disabled = false;
            valoreInput.placeholder = "Inserisci unità o valore stimato";
        } else {
            valoreInput.value = '';
            valoreInput.disabled = true;
            valoreInput.classList.add('d-none');
            valoreInput.placeholder = '';
        }
    }

    function getUtentiDisponibili() {
        const utenti = [];

        // 🔹 Usa sempre quelli dal backend
        if (Array.isArray(window.intestatariGlobali)) {
            window.intestatariGlobali.forEach(u => {
                utenti.push({ ID: u.ID, Nome: u.Nome });
            });
        }

        return utenti;
    }


    function popolaSelectIntestatari(selectElement, valoreSelezionato = null) {
        console.log("🔥 [DEBUG] popolaSelectIntestatari — START");

        const utenti = window.intestatariGlobali || [];
        console.log("🔄 [DEBUG] Utenti disponibili:", utenti);

        try {
            selectElement.innerHTML = '<option value="">-- Seleziona intestatario --</option>';
        } catch (err) {
            console.error("💥 [ERRORE] Non riesco a impostare innerHTML della select:", err);
        }

        utenti.forEach((u, idx) => {
            console.log(`🟦 [DEBUG] Inserisco option #${idx}:`, u);

            try {
                // Sanificazione nome
                const nomeSafe = (u.Nome || "")
                    .replace(/'/g, "&#39;")
                    .replace(/"/g, "&quot;");

                console.log(`➡️ [DEBUG] Nome originale: "${u.Nome}" → Nome safe: "${nomeSafe}"`);

                const opt = document.createElement("option");
                opt.value = u.ID;

                // ⚠️ USIAMO innerHTML perché dobbiamo interpretare l’entità HTML
                opt.innerHTML = nomeSafe;

                selectElement.appendChild(opt);

                console.log(`✔️ [DEBUG] Option aggiunta (ID=${u.ID})`);
            }
            catch (err) {
                console.error("💥 [ERRORE] Durante creazione/append option:", err);
            }
        });

        // gestione valore selezionato
        try {
            const valore = valoreSelezionato || selectElement.dataset.savedValue;
            console.log("🎯 [DEBUG] Valore selezionato richiesto:", valore);

            if (valore) {
                selectElement.value = valore;
                console.log("✔️ [DEBUG] Valore selezionato applicato:", valore);
            }
        } catch (err) {
            console.error("💥 [ERRORE] Impostando il valore selezionato:", err);
        }

        console.log("🏁 [DEBUG] popolaSelectIntestatari — END");
    }


    // 🔹 Salvataggio compensi dal modal (versione con fix accenti/apostrofi)
    function salvaCompensi() {

        const metodo = document.getElementById('metodoCompensoSelect').value;
        const budgetInput = document.getElementById('BudgetInput');
        const idPratica = document.getElementById("ID_Pratiche")?.value || "0";

        let righeMetodo = [];

        // =====================================================================================
        // 🔍 RACCOLTA RIGHE DEL METODO CORRENTE
        // =====================================================================================
        document.querySelectorAll('#tabellaCompensi tbody tr').forEach(tr => {

            let obj = { Metodo: metodo };

            // Campi dinamici generali
            tr.querySelectorAll('input, textarea, select').forEach(c => {
                if (!c.disabled) {
                    obj[c.name] = sanitizeText(c.value?.trim() || "");
                }
            });

            // =====================================================================================
            // 🔸 METODO "A ore"
            // =====================================================================================
            if (metodo === "A ore") {

                obj["Tipologia"] = "A ore";

                const oggettoInput = document.getElementById("OggettoIncarico");
                if (oggettoInput)
                    obj["OggettoIncarico"] = sanitizeText(oggettoInput.value?.trim() || "");

                obj["Descrizione"] = sanitizeText(tr.querySelector('input[name^="Ruolo_"]')?.value || "");

                const tariffaInput = tr.querySelector('input[name^="Tariffa_"]');
                let tariffa = tariffaInput?.dataset.raw ?? tariffaInput?.value;
                tariffa = parseFloat((tariffa || "0").replace(',', '.')) || 0;
                obj["Importo"] = tariffa;

                if (budgetInput && budgetInput.value) {
                    const val = parseFloat(budgetInput.value.replace('.', '').replace(',', '.'));
                    obj["BudgetManuale"] = isNaN(val) ? 0 : val;
                }
            }

            // =====================================================================================
            // 🔸 METODO "Fisso"
            // =====================================================================================
            if (metodo === "Fisso") {

                obj["Tipologia"] = tr.querySelector('select[name^="Tipologia_"]')?.value || "Fisso";
                obj["Descrizione"] = sanitizeText(tr.querySelector('textarea[name^="Descrizione_"]')?.value || "");

                const importoInput = tr.querySelector('input[name^="Importo_"]');
                let importo = importoInput?.dataset.raw ?? importoInput?.value;
                importo = parseFloat((importo || "0").toString().replace(',', '.')) || 0;
                obj["Importo"] = importo;

                let valStimato = tr.querySelector('input[name^="ValoreStimato_"]')?.value;

                // 🔥 FIX: forza sempre valStimato a stringa
                if (valStimato === undefined || valStimato === null || valStimato === "") {
                    valStimato = "1"; // default
                } else {
                    valStimato = valStimato.toString(); // <--- qui il fix fondamentale
                }

                obj["ValoreStimato"] = parseFloat(valStimato.replace(',', '.')) || 1;
            }


            // =====================================================================================
            // 🔸 METODO "Giudiziale"
            // =====================================================================================
            if (metodo === "Giudiziale") {

                obj["Tipologia"] = "Giudiziale";

                const estremiInput = document.getElementById("EstremiGiudizio");
                if (estremiInput)
                    obj["EstremiGiudizio"] = sanitizeText(estremiInput.value?.trim() || "");

                obj["Descrizione"] = sanitizeText(tr.querySelector('input[name^="Fase_"]')?.value || "");

                const importoInput = tr.querySelector('input[name^="Importo_"]');
                let importo = importoInput?.dataset.raw ?? importoInput?.value;
                importo = parseFloat((importo || "0").replace(',', '.')) || 0;
                obj["Importo"] = importo;
            }

            // =====================================================================================
            // 👤 INTESTATARIO
            // =====================================================================================
            const intestatarioSelect = tr.querySelector('select[name^="Intestatario_"]');
            if (intestatarioSelect) {
                obj["ID_ProfessionistaIntestatario"] = intestatarioSelect.value || "";
                obj["IntestatarioNome"] = sanitizeText(
                    intestatarioSelect.options[intestatarioSelect.selectedIndex]?.text || ""
                );
            }

            // =====================================================================================
            // 👥 COLLABORATORI
            // =====================================================================================
            let collaboratori = [];
            tr.querySelectorAll('.collaboratori-riga .row-collaboratore').forEach(rowCol => {

                const collabSelect = rowCol.querySelector('select[name="Collaboratore_temp"], select[name^="Collaboratore_"]');
                const percInput = rowCol.querySelector('input[name="PercentualeCollaboratore_temp"], input[name^="PercentualeCollaboratore_"]');

                if (collabSelect && percInput && collabSelect.value) {
                    collaboratori.push({
                        ID_Collaboratore: collabSelect.value,
                        NomeCollaboratore: sanitizeText(collabSelect.options[collabSelect.selectedIndex]?.text || ""),
                        Percentuale: parseFloat(percInput.value.replace(',', '.')) || 0
                    });
                }
            });

            if (collaboratori.length > 0)
                obj["Collaboratori"] = collaboratori;

            righeMetodo.push(obj);
        });

        // =====================================================================================
        // 🔁 RICOSTRUZIONE JSON CUMULATIVO (tutti i metodi)
        // =====================================================================================
        let cumulativo = [];

        const hidden = document.querySelector('#hiddenCompensiContainer input[name="CompensiJSON"]');
        let jsonHidden = hidden?.value || "";

        if (jsonHidden.trim() !== "") {
            try {
                cumulativo = JSON.parse(decodeURIComponent(jsonHidden));
            } catch {
                console.warn("⚠️ Hidden JSON corrotto → uso variabile globale");
                cumulativo = Array.isArray(window.compensiCorrenti)
                    ? JSON.parse(JSON.stringify(window.compensiCorrenti))
                    : [];
            }
        } else {
            cumulativo = Array.isArray(window.compensiCorrenti)
                ? JSON.parse(JSON.stringify(window.compensiCorrenti))
                : [];
        }

        // 🔄 Sostituisco solo le righe del metodo corrente
        cumulativo = cumulativo.filter(r => r.Metodo !== metodo);
        cumulativo = cumulativo.concat(righeMetodo);

        // =====================================================================================
        // 💾 AGGIORNO HIDDEN JSON
        // =====================================================================================
        const container = document.getElementById('hiddenCompensiContainer');
        container.innerHTML = `
        <input type="hidden" name="CompensiJSON"
               value="${encodeURIComponent(JSON.stringify(cumulativo))}">
    `;

        // =====================================================================================
        // 🟦 SE È NUOVA PRATICA → aggiorno anche compensiTemp
        // =====================================================================================
        if (idPratica == "0" || idPratica === "") {
            console.log("🟦 NUOVA PRATICA → aggiorno compensiTemp:", cumulativo);
            window.compensiTemp = JSON.parse(JSON.stringify(cumulativo));
        }

        // =====================================================================================
        // 🔁 AGGIORNAMENTO UI
        // =====================================================================================
        popolaRiepilogoCompensi(cumulativo);

        if (metodo !== "A ore") {
            aggiornaValoreStimato(cumulativo);
        }

        bootstrap.Modal.getInstance(document.getElementById('compensoModal')).hide();
    }


    document.addEventListener('blur', e => {
        if (e.target.classList.contains('importo-input')) {
            let val = e.target.value.trim().replace(/\./g, '').replace(',', '.');
            const num = parseFloat(val);
            if (!isNaN(num)) {
                e.target.dataset.raw = num; // 🔹 valore pulito
                e.target.value = num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }
    }, true);

    function aggiornaIntestatariDisponibili() {
        const intestatari = getUtentiDisponibili();

        document.querySelectorAll('.intestatario-select').forEach(select => {
            popolaSelectIntestatari(select);
            // 🔄 se ha già un valore salvato nel JSON lo manteniamo
            if (select.dataset.savedValue) {
                select.value = select.dataset.savedValue;
            }
        });
    }

    function controllaAbilitazioneCompensi() {
        const cliente = document.getElementById("selectCliente")?.value;
        const metodo = document.getElementById("metodoCompensoSelect")?.value;
        const btn = document.getElementById("btnGestisciCompensi");

        if (cliente && metodo) {
            btn.removeAttribute("disabled");
        } else {
            btn.setAttribute("disabled", "disabled");
        }
    }

    function aggiungiCollaboratoreRiga(button) {
        const container = button.closest("td").querySelector(".collaboratori-riga");

        const div = document.createElement("div");
        div.classList.add("row-collaboratore", "input-group", "input-group-sm", "mb-1");

        div.innerHTML = `
        <select name="Collaboratore_temp" class="form-select form-select-sm col-6">
            ${getUtentiDisponibili().map(u => `<option value="${u.ID}">${u.Nome}</option>`).join("")}
        </select>
        <input name="PercentualeCollaboratore_temp" type="number"
               class="form-control form-control-sm col-3 ms-1"
               placeholder="%" min="0" max="100">
        <button type="button" class="btn btn-sm btn-danger ms-1"
                onclick="this.parentElement.remove()">🗑</button>
    `;

        container.appendChild(div);
    }


    // ⭐ Funzione unificata per generare l'hidden dei compensi
    function aggiornaHiddenCompensi() {
        const hidden = document.querySelector('#hiddenCompensiContainer input[name="CompensiJSON"]');
        if (!hidden) return;

        hidden.value = encodeURIComponent(JSON.stringify(window.CompensiCorrenti || []));
    }



    // 🔄 Collego i change
    document.getElementById("selectCliente")?.addEventListener("change", controllaAbilitazioneCompensi);
    document.getElementById("metodoCompensoSelect")?.addEventListener("change", controllaAbilitazioneCompensi);



    // trattenuta sinergia personalizzata
    //document.addEventListener("DOMContentLoaded", function () {
    //    const checkbox = document.getElementById('flagTrattenutaPersonalizzata');
    //    const boxInput = document.getElementById('boxTrattenutaPersonalizzata');

    //    checkbox.addEventListener('change', function () {
    //        if (this.checked) {
    //            boxInput.classList.remove('d-none');
    //        } else {
    //            boxInput.classList.add('d-none');
    //            // puoi anche azzerare il campo se vuoi:
    //            boxInput.querySelector('input').value = "";
    //        }
    //    });

    //    // ✅ Se già presente un valore (in modifica), spunta checkbox e mostra box
    //    const campo = document.querySelector('[name="TrattenutaPersonalizzata"]');
    //    if (campo && campo.value && parseFloat(campo.value) > 0) {
    //        checkbox.checked = true;
    //        boxInput.classList.remove('d-none');
    //    }
    //});

    // fine trattenuta

    // 🔍 Filtro e paginazione pratiche
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById('praticheTable');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const cards = document.querySelectorAll('.card-pratica');

        const controlliContainer = document.getElementById('controlliPratiche');
        const paginationContainer = document.getElementById('paginazionePratiche');

        const searchInput = document.createElement('input');
        const selectPageSize = document.createElement('select');
        const selectStato = document.createElement('select');

        let pageSize = 10;
        let currentPage = 1;

        // 🔍 Ricerca
        searchInput.type = 'text';
        searchInput.placeholder = 'Cerca...';
        searchInput.className = 'form-control form-control-sm w-auto';

        // 📄 Page Size
        [10, 25, 50].forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = `${num} per pagina`;
            selectPageSize.appendChild(option);
        });
        selectPageSize.className = 'form-select form-select-sm w-auto';

        ['Tutte', 'Contrattualizzazione', 'In lavorazione', 'Conclusa']
            .forEach(stato => {
                const option = document.createElement('option');
                option.value = stato;
                option.textContent = stato;
                selectStato.appendChild(option);
            });

        selectStato.className = 'form-select form-select-sm w-auto';

        // Aggiungi i controlli alla barra
        controlliContainer.appendChild(searchInput);
        // 🏷️ Etichetta "Stato pratiche:" in formato piccolo
        const labelStato = document.createElement('label');
        labelStato.innerText = "Stato pratiche:";
        labelStato.className = "me-1 fw-bold small align-self-center";

        // Contenitore per etichetta + select
        const statoWrapper = document.createElement('div');
        statoWrapper.className = "d-flex align-items-center me-3";
        statoWrapper.appendChild(labelStato);
        statoWrapper.appendChild(selectStato);

        // Aggiungi nella barra dei controlli
        controlliContainer.appendChild(statoWrapper);


        controlliContainer.appendChild(selectPageSize);

        function renderTable() {
            const keyword = searchInput.value.toLowerCase();
            const filtroStato = selectStato.value;

            let filteredRows = rows.filter(row => {
                const text = row.innerText.toLowerCase();
                const statoCell = row.querySelector('td.stato');
                const stato = statoCell ? statoCell.innerText.trim() : '';
                const statoMatch = (filtroStato === 'Tutte' || stato === filtroStato);
                return text.includes(keyword) && statoMatch;
            });

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            currentPage = Math.min(currentPage, totalPages || 1);

            // Tabella desktop
            rows.forEach(r => r.style.display = 'none');
            filteredRows.slice((currentPage - 1) * pageSize, currentPage * pageSize).forEach(r => r.style.display = '');

            // Card mobile
            cards.forEach(c => c.style.display = 'none');
            filteredRows.forEach(row => {
                const id = row.getAttribute('data-id');
                const card = document.querySelector(`.card-pratica[data-id="${id}"]`);
                if (card) card.style.display = '';
            });

            // Paginazione
            paginationContainer.innerHTML = '';
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Pagina ${currentPage} di ${totalPages || 1}`;
            pageInfo.className = 'me-2';
            paginationContainer.appendChild(pageInfo);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = '← Indietro';
            prevBtn.className = 'btn btn-sm ' + (currentPage === 1 ? 'btn-secondary' : 'btn-outline-primary');
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); };
            paginationContainer.appendChild(prevBtn);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Prossima →';
            nextBtn.className = 'btn btn-sm ' + (currentPage === totalPages ? 'btn-secondary' : 'btn-outline-primary');
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); };
            paginationContainer.appendChild(nextBtn);
        }

        // Eventi
        searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
        selectStato.addEventListener('change', () => { currentPage = 1; renderTable(); });
        selectPageSize.addEventListener('change', () => {
            pageSize = parseInt(selectPageSize.value);
            currentPage = 1;
            renderTable();
        });

        renderTable();
    });



</script>

